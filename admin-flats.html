<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOOM ‚Äì Gestione Appartamenti</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --gold: #FFD700; --green: #00FF88; --red: #FF4444; --orange: #FFA500; --cyan: #00CED1; --black: #000; --dark: #111; --gray: #333; --light-gray: #666; --white: #fff; }
        body { font-family: 'Inter', sans-serif; background: var(--black); color: var(--white); min-height: 100vh; padding: 20px; }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: var(--dark); border: 1px solid var(--gold); margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 24px; font-weight: 300; display: flex; align-items: center; gap: 15px; }
        .header h1 span { color: var(--gold); }
        .logo-circle { width: 40px; height: 40px; background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 50%; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }

        .btn { padding: 12px 24px; border: none; cursor: pointer; font-family: inherit; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s; }
        .btn-gold { background: var(--gold); color: var(--black); }
        .btn-gold:hover { background: var(--orange); }
        .btn-green { background: var(--green); color: var(--black); }
        .btn-green:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border: 1px solid var(--light-gray); color: var(--white); }
        .btn-outline:hover { border-color: var(--gold); color: var(--gold); }
        .btn-red { background: var(--red); color: var(--white); }
        .btn-small { padding: 8px 16px; font-size: 11px; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--dark); padding: 25px; border: 1px solid var(--gray); }
        .stat-value { font-size: 42px; font-weight: 200; color: var(--gold); }
        .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--light-gray); margin-top: 5px; }

        .flats-container { background: var(--dark); border: 1px solid var(--gray); }
        .flats-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--gray); flex-wrap: wrap; gap: 10px; }
        .flats-header h2 { font-size: 16px; font-weight: 400; }

        .flat-item { display: grid; grid-template-columns: 100px 1fr auto auto auto; gap: 20px; align-items: center; padding: 20px; border-bottom: 1px solid var(--gray); transition: background 0.3s; }
        .flat-item:hover { background: rgba(255, 215, 0, 0.02); }
        .flat-image { width: 100px; height: 70px; background-size: cover; background-position: center; border-radius: 4px; position: relative; }
        .flat-image .video-indicator { position: absolute; bottom: 4px; right: 4px; background: red; color: white; font-size: 8px; padding: 2px 5px; border-radius: 2px; }
        .flat-info h3 { font-size: 16px; font-weight: 500; margin-bottom: 4px; }
        .flat-info p { font-size: 13px; color: var(--light-gray); }
        .flat-info .zone { font-size: 11px; color: var(--cyan); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
        .flat-price { font-size: 20px; font-weight: 300; color: var(--gold); }
        .flat-status { padding: 6px 14px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; border-radius: 20px; }
        .flat-status.available { background: rgba(0, 255, 136, 0.15); color: var(--green); }
        .flat-status.waitlist { background: rgba(255, 165, 0, 0.15); color: var(--orange); }
        .flat-actions { display: flex; gap: 8px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 1000; justify-content: center; align-items: flex-start; padding: 30px 20px; overflow-y: auto; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--dark); border: 1px solid var(--gold); width: 100%; max-width: 700px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--gray); }
        .modal-header h2 { font-size: 18px; font-weight: 400; }
        .modal-close { background: none; border: none; color: var(--light-gray); font-size: 24px; cursor: pointer; }
        .modal-close:hover { color: var(--white); }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; padding: 20px; border-top: 1px solid var(--gray); }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--light-gray); margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background: var(--black); border: 1px solid var(--gray); color: var(--white); font-family: inherit; font-size: 14px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--gold); }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-group small { display: block; margin-top: 5px; font-size: 11px; color: var(--light-gray); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        .section-divider { border: none; border-top: 1px solid var(--gray); margin: 25px 0; }
        .section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: var(--gold); margin-bottom: 15px; }

        .instructions { background: var(--dark); border: 1px solid var(--gray); padding: 25px; margin-top: 30px; }
        .instructions h3 { font-size: 14px; font-weight: 500; margin-bottom: 15px; color: var(--gold); }
        .instructions ol { padding-left: 20px; color: var(--light-gray); font-size: 14px; line-height: 2; }
        .instructions code { background: var(--black); padding: 2px 8px; color: var(--green); font-size: 12px; }

        .download-section { background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), transparent); border: 2px solid var(--gold); padding: 30px; margin-top: 30px; text-align: center; }
        .download-section h3 { font-size: 18px; font-weight: 400; margin-bottom: 10px; }
        .download-section p { color: var(--light-gray); font-size: 14px; margin-bottom: 20px; }

        .alert { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: var(--green); color: var(--black); font-weight: 500; z-index: 2000; display: none; }
        .alert.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .preview-images { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .preview-images img { width: 60px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid var(--gray); }

        @media (max-width: 768px) {
            .flat-item { grid-template-columns: 1fr; text-align: center; }
            .flat-image { width: 100%; height: 150px; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .header { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="alert" id="alert"></div>

    <header class="header">
        <h1><div class="logo-circle"></div><span>BOOM</span> Gestione Appartamenti</h1>
        <div class="header-actions">
            <button class="btn btn-outline" onclick="loadFromFile()">üìÅ Carica JSON</button>
            <button class="btn btn-gold" onclick="openModal()">+ Nuovo Appartamento</button>
        </div>
    </header>

    <section class="stats">
        <div class="stat-card"><div class="stat-value" id="totalCount">0</div><div class="stat-label">Totale</div></div>
        <div class="stat-card"><div class="stat-value" id="availableCount">0</div><div class="stat-label">Disponibili</div></div>
        <div class="stat-card"><div class="stat-value" id="waitlistCount">0</div><div class="stat-label">Waitlist</div></div>
        <div class="stat-card"><div class="stat-value" id="videoCount">0</div><div class="stat-label">Con Video</div></div>
    </section>

    <section class="flats-container">
        <div class="flats-header">
            <h2>üìç Lista Appartamenti</h2>
            <span id="lastUpdate" style="color: var(--light-gray); font-size: 12px;"></span>
        </div>
        <div id="flatsList"></div>
    </section>

    <section class="download-section">
        <h3>üíæ Salva le Modifiche</h3>
        <p>Dopo aver fatto le modifiche, scarica il file JSON e caricalo nella cartella del sito</p>
        <button class="btn btn-green" onclick="downloadJSON()" style="margin-right: 10px;">‚¨áÔ∏è Scarica flats.json</button>
        <button class="btn btn-outline" onclick="copyJSON()">üìã Copia negli Appunti</button>
    </section>

    <section class="instructions">
        <h3>üìñ Come Funziona</h3>
        <ol>
            <li><strong>Aggiungi/Modifica/Elimina</strong> appartamenti usando i pulsanti</li>
            <li>Per le <strong>immagini multiple</strong>, inserisci gli URL separati da virgola</li>
            <li>Per i <strong>video YouTube</strong>, inserisci il link completo (es: https://youtube.com/watch?v=...)</li>
            <li>Clicca <strong>"Scarica flats.json"</strong> per salvare le modifiche</li>
            <li>Carica il file <code>flats.json</code> nella cartella principale del sito</li>
            <li>Fai il deploy su Vercel (push su GitHub o drag&drop)</li>
        </ol>
    </section>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Nuovo Appartamento</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="flatForm">
                    <input type="hidden" id="flatIndex" value="-1">
                    
                    <!-- BASIC INFO -->
                    <div class="section-title">üìã Informazioni Base</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>ID (unico, senza spazi)</label>
                            <input type="text" id="flatId" required placeholder="es: trastevere-loft">
                        </div>
                        <div class="form-group">
                            <label>Nome Appartamento</label>
                            <input type="text" id="flatName" required placeholder="es: Trastevere Loft">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Indirizzo</label>
                            <input type="text" id="flatAddress" required placeholder="es: Via della Scala 42, Trastevere">
                        </div>
                        <div class="form-group">
                            <label>Zona / Quartiere</label>
                            <input type="text" id="flatZone" placeholder="es: Trastevere, Centro, Prati">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tagline / Descrizione Breve</label>
                        <input type="text" id="flatTagline" placeholder="es: Luminoso bilocale con terrazza panoramica">
                    </div>

                    <hr class="section-divider">
                    
                    <!-- DETAILS -->
                    <div class="section-title">üè† Dettagli</div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label>Prezzo (‚Ç¨/mese)</label>
                            <input type="number" id="flatPrice" required placeholder="1200">
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <input type="text" id="flatType" required placeholder="es: Attic, Loft, Studio">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="flatStatus">
                                <option value="available">Disponibile</option>
                                <option value="waitlist">Waitlist</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label>Camere</label>
                            <input type="text" id="flatBeds" required placeholder="es: 1 Bedroom">
                        </div>
                        <div class="form-group">
                            <label>Dimensione</label>
                            <input type="text" id="flatSize" required placeholder="es: 55m¬≤">
                        </div>
                        <div class="form-group">
                            <label>Piano</label>
                            <input type="text" id="flatFloor" required placeholder="es: 3rd Floor">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Data Disponibilit√†</label>
                            <input type="text" id="flatDate" required placeholder="es: Feb 1">
                        </div>
                        <div class="form-group">
                            <label>File Pagina (opzionale)</label>
                            <input type="text" id="flatFile" placeholder="es: apartment_trastevere.html">
                        </div>
                    </div>

                    <hr class="section-divider">
                    
                    <!-- MEDIA -->
                    <div class="section-title">üì∏ Media</div>

                    <div class="form-group">
                        <label>Immagine Principale (URL)</label>
                        <input type="url" id="flatImage" required placeholder="https://i.imgur.com/xxxxx.jpeg">
                        <small>Questa sar√† l'immagine mostrata nella card</small>
                    </div>

                    <div class="form-group">
                        <label>Gallery Immagini (URLs separati da virgola)</label>
                        <textarea id="flatGallery" placeholder="https://i.imgur.com/img1.jpeg, https://i.imgur.com/img2.jpeg, https://i.imgur.com/img3.jpeg"></textarea>
                        <small>Inserisci tutti gli URL delle immagini per la galleria, separati da virgola</small>
                        <div class="preview-images" id="galleryPreview"></div>
                    </div>

                    <div class="form-group">
                        <label>Video YouTube (URL)</label>
                        <input type="url" id="flatVideo" placeholder="https://www.youtube.com/watch?v=XXXXXXX">
                        <small>Link completo di YouTube. Se presente, apparir√† il badge "Video Tour" sulla card</small>
                    </div>

                    <hr class="section-divider">
                    
                    <!-- TAGS -->
                    <div class="section-title">üè∑Ô∏è Tags</div>

                    <div class="form-group">
                        <label>Tags (separati da virgola)</label>
                        <input type="text" id="flatTags" placeholder="All Inclusive, Balcony, AC, WiFi, Terrace">
                        <small>Es: All Inclusive, Balcony, AC, WiFi, Elevator, Terrace, Garden</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Annulla</button>
                <button class="btn btn-gold" onclick="saveFlat()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileUpload(event)">

    <script>
        // Initialize
        let FLATS = JSON.parse(localStorage.getItem('boom_flats') || '[]');

        // Default data if empty
        if (FLATS.length === 0) {
            FLATS = [
                { id: "marconi", file: "apartment-marconi.html", name: "Marconi Shared", address: "Via Federico Guarducci, Marconi", zone: "Marconi", tagline: "Spacious private room in shared 3-bedroom apartment", price: 750, type: "Shared Room", beds: "1 Room in 3BR", size: "110m¬≤", floor: "7th Floor", image: "https://i.imgur.com/s2es0MN.jpeg", gallery: ["https://i.imgur.com/s2es0MN.jpeg", "https://i.imgur.com/V73fwGD.jpeg", "https://i.imgur.com/ArIwJXE.jpeg", "https://i.imgur.com/iAScYmL.jpeg"], videoUrl: "", tags: ["All Inclusive", "Balcony", "AC"], status: "available", availableDate: "Feb 1" },
                { id: "levico", file: "apartment_levico.html", name: "Levico", address: "Via Levico, Trieste/Copped√®", zone: "Trieste", tagline: "Charming garden apartment in prestigious area", price: 1200, type: "Garden Floor", beds: "1 Bedroom", size: "40m¬≤", floor: "Ground Floor", image: "https://i.imgur.com/Ne0ROPe.jpeg", gallery: ["https://i.imgur.com/Ne0ROPe.jpeg"], videoUrl: "", tags: ["All Inclusive", "Garden", "WiFi"], status: "available", availableDate: "Feb 1" },
                { id: "piemonte", file: "apartment_piemonte.html", name: "Piemonte Attic", address: "Via Piemonte, Vittorio Veneto", zone: "Centro", tagline: "Recently renovated attic in the heart of Rome", price: 1300, type: "Attic", beds: "1 Bedroom", size: "55m¬≤", floor: "5th Floor", image: "https://i.imgur.com/Smv5uPX.jpeg", gallery: ["https://i.imgur.com/Smv5uPX.jpeg"], videoUrl: "", tags: ["Renovated", "AC", "Central"], status: "available", availableDate: "Jan 1" },
                { id: "pigneto", file: "apartment_pigneto.html", name: "Pigneto Terrace", address: "Via Ascoli Piceno, Pigneto", zone: "Pigneto", tagline: "Bohemian 2BR with stunning terrace views", price: 1700, type: "Bohemian", beds: "2 Bedrooms", size: "80m¬≤", floor: "2nd Floor", image: "https://i.imgur.com/tJnYADn.jpeg", gallery: ["https://i.imgur.com/tJnYADn.jpeg"], videoUrl: "", tags: ["All Inclusive", "Terrace", "Balcony"], status: "available", availableDate: "Apr 1" },
                { id: "navona", file: "apartment_navona.html", name: "Coronari Classic", address: "Via dei Coronari, Piazza Navona", zone: "Centro Storico", tagline: "Historic apartment steps from Piazza Navona", price: 2000, type: "Historic", beds: "1 Bedroom", size: "70m¬≤", floor: "1st Floor", image: "https://i.imgur.com/8LVxrhs.jpeg", gallery: ["https://i.imgur.com/8LVxrhs.jpeg"], videoUrl: "", tags: ["Historic Center", "Elevator", "Fireplace"], status: "available", availableDate: "Mar 1" },
                { id: "angelico", file: "apartment_angelico.html", name: "Angelico Loft", address: "Viale Angelico, Mazzini", zone: "Prati", tagline: "Modern loft-style apartment near Vatican", price: 2000, type: "Loft Style", beds: "1BR + Loft", size: "65m¬≤", floor: "2nd Floor", image: "https://i.imgur.com/CI4n46J.jpeg", gallery: ["https://i.imgur.com/CI4n46J.jpeg"], videoUrl: "", tags: ["All Inclusive", "Modern", "Sep 2026"], status: "waitlist", availableDate: "Sep 1" },
                { id: "ripetta", file: "apartment_ripetta.html", name: "Ripetta Terrace", address: "Passeggiata di Ripetta, Centro", zone: "Centro", tagline: "Premium terrace apartment with river views", price: 2300, type: "Premium Terrace", beds: "1 Bedroom", size: "100m¬≤", floor: "1st Floor", image: "https://i.imgur.com/hxai5bz.jpeg", gallery: ["https://i.imgur.com/hxai5bz.jpeg"], videoUrl: "", tags: ["Panoramic Terrace", "River View", "Sep 2026"], status: "waitlist", availableDate: "Sep 1" }
            ];
            saveToStorage();
        }

        // RENDER
        function render() {
            document.getElementById('totalCount').textContent = FLATS.length;
            document.getElementById('availableCount').textContent = FLATS.filter(f => f.status === 'available').length;
            document.getElementById('waitlistCount').textContent = FLATS.filter(f => f.status === 'waitlist').length;
            document.getElementById('videoCount').textContent = FLATS.filter(f => f.videoUrl).length;
            document.getElementById('lastUpdate').textContent = 'Ultimo salvataggio: ' + new Date().toLocaleTimeString('it-IT');

            const list = document.getElementById('flatsList');
            if (FLATS.length === 0) {
                list.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--light-gray);">Nessun appartamento. Clicca "Nuovo Appartamento" per iniziare.</div>';
                return;
            }

            list.innerHTML = FLATS.map((flat, index) => `
                <div class="flat-item">
                    <div class="flat-image" style="background-image: url('${flat.image}')">
                        ${flat.videoUrl ? '<span class="video-indicator">‚ñ∂</span>' : ''}
                    </div>
                    <div class="flat-info">
                        <h3>${flat.name}</h3>
                        <p>${flat.address}</p>
                        ${flat.zone ? `<div class="zone">${flat.zone}</div>` : ''}
                    </div>
                    <div class="flat-price">‚Ç¨${flat.price.toLocaleString()}</div>
                    <span class="flat-status ${flat.status}">${flat.status === 'available' ? 'Disponibile' : 'Waitlist'}</span>
                    <div class="flat-actions">
                        <button class="btn btn-outline btn-small" onclick="editFlat(${index})">‚úèÔ∏è Modifica</button>
                        <button class="btn btn-red btn-small" onclick="deleteFlat(${index})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // MODAL
        function openModal(index = -1) {
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('flatIndex').value = index;
            document.getElementById('galleryPreview').innerHTML = '';

            if (index >= 0) {
                const flat = FLATS[index];
                document.getElementById('modalTitle').textContent = 'Modifica Appartamento';
                document.getElementById('flatId').value = flat.id;
                document.getElementById('flatName').value = flat.name;
                document.getElementById('flatAddress').value = flat.address;
                document.getElementById('flatZone').value = flat.zone || '';
                document.getElementById('flatTagline').value = flat.tagline || '';
                document.getElementById('flatPrice').value = flat.price;
                document.getElementById('flatType').value = flat.type;
                document.getElementById('flatStatus').value = flat.status;
                document.getElementById('flatBeds').value = flat.beds;
                document.getElementById('flatSize').value = flat.size;
                document.getElementById('flatFloor').value = flat.floor;
                document.getElementById('flatDate').value = flat.availableDate;
                document.getElementById('flatFile').value = flat.file || '';
                document.getElementById('flatImage').value = flat.image;
                document.getElementById('flatGallery').value = (flat.gallery || []).join(', ');
                document.getElementById('flatVideo').value = flat.videoUrl || '';
                document.getElementById('flatTags').value = flat.tags.join(', ');
                updateGalleryPreview();
            } else {
                document.getElementById('modalTitle').textContent = 'Nuovo Appartamento';
                document.getElementById('flatForm').reset();
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function updateGalleryPreview() {
            const gallery = document.getElementById('flatGallery').value;
            const preview = document.getElementById('galleryPreview');
            if (!gallery.trim()) {
                preview.innerHTML = '';
                return;
            }
            const urls = gallery.split(',').map(u => u.trim()).filter(u => u);
            preview.innerHTML = urls.map(url => `<img src="${url}" onerror="this.style.display='none'">`).join('');
        }

        document.getElementById('flatGallery').addEventListener('input', updateGalleryPreview);

        // CRUD
        function saveFlat() {
            const index = parseInt(document.getElementById('flatIndex').value);
            const galleryText = document.getElementById('flatGallery').value;
            const galleryUrls = galleryText ? galleryText.split(',').map(u => u.trim()).filter(u => u) : [];
            
            const flat = {
                id: document.getElementById('flatId').value.toLowerCase().replace(/\s+/g, '-'),
                name: document.getElementById('flatName').value,
                address: document.getElementById('flatAddress').value,
                zone: document.getElementById('flatZone').value || '',
                tagline: document.getElementById('flatTagline').value || '',
                price: parseInt(document.getElementById('flatPrice').value),
                type: document.getElementById('flatType').value,
                status: document.getElementById('flatStatus').value,
                beds: document.getElementById('flatBeds').value,
                size: document.getElementById('flatSize').value,
                floor: document.getElementById('flatFloor').value,
                availableDate: document.getElementById('flatDate').value,
                file: document.getElementById('flatFile').value || `apartment_${document.getElementById('flatId').value.toLowerCase().replace(/\s+/g, '_')}.html`,
                image: document.getElementById('flatImage').value,
                gallery: galleryUrls.length > 0 ? galleryUrls : [document.getElementById('flatImage').value],
                videoUrl: document.getElementById('flatVideo').value || '',
                tags: document.getElementById('flatTags').value.split(',').map(t => t.trim()).filter(t => t)
            };

            if (!flat.name || !flat.address || !flat.price || !flat.image) {
                showAlert('‚ö†Ô∏è Compila tutti i campi obbligatori');
                return;
            }

            if (index >= 0) {
                FLATS[index] = flat;
                showAlert('‚úÖ Appartamento aggiornato!');
            } else {
                FLATS.push(flat);
                showAlert('‚úÖ Appartamento aggiunto!');
            }

            saveToStorage();
            render();
            closeModal();
        }

        function editFlat(index) { openModal(index); }

        function deleteFlat(index) {
            if (confirm(`Sei sicuro di voler eliminare "${FLATS[index].name}"?`)) {
                FLATS.splice(index, 1);
                saveToStorage();
                render();
                showAlert('üóëÔ∏è Appartamento eliminato');
            }
        }

        // STORAGE
        function saveToStorage() { localStorage.setItem('boom_flats', JSON.stringify(FLATS)); }

        function downloadJSON() {
            const data = JSON.stringify(FLATS, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'flats.json';
            a.click();
            URL.revokeObjectURL(url);
            showAlert('‚úÖ File scaricato!');
        }

        function copyJSON() {
            navigator.clipboard.writeText(JSON.stringify(FLATS, null, 2)).then(() => showAlert('üìã JSON copiato!'));
        }

        function loadFromFile() { document.getElementById('fileInput').click(); }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    FLATS = JSON.parse(e.target.result);
                    saveToStorage();
                    render();
                    showAlert('‚úÖ File caricato!');
                } catch (err) {
                    showAlert('‚ö†Ô∏è Errore nel file JSON');
                }
            };
            reader.readAsText(file);
        }

        function showAlert(message) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 3000);
        }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
        document.getElementById('modalOverlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });

        render();
    </script>
</body>
</html>
