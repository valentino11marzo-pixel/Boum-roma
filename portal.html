<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="BOOM Property Management Portal - Gestione immobili, contratti e pagamenti">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BOOM â€” Property Portal</title>
    <link rel="icon" type="image/png" href="https://www.boomrome.com/BOOMlogogoldicon512.png">
    <link rel="apple-touch-icon" href="https://www.boomrome.com/BOOMlogogoldicon512.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--gold:#D4AF37;--gold-light:rgba(212,175,55,0.15);--gold-dark:#B8960C;--green:#34C759;--green-light:rgba(52,199,89,0.12);--red:#FF3B30;--red-light:rgba(255,59,48,0.12);--orange:#FF9500;--orange-light:rgba(255,149,0,0.12);--blue:#007AFF;--blue-light:rgba(0,122,255,0.12);--purple:#AF52DE;--purple-light:rgba(175,82,222,0.12);--cyan:#00C7BE;--cyan-light:rgba(0,199,190,0.12);--bg:#000;--bg-card:#0A0A0A;--bg-elevated:#141414;--bg-input:#1A1A1A;--border:rgba(255,255,255,0.08);--text:#FFF;--text-secondary:#999;--text-muted:#666}
        body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}
        .loading{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;z-index:9999}.loading.hidden{display:none}
        .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .auth{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}.auth.hidden{display:none}
        .auth-card{background:var(--bg-card);border:1px solid var(--border);border-radius:24px;padding:48px;width:100%;max-width:420px;text-align:center}
        .auth-logo{width:72px;height:72px;margin:0 auto 20px;display:block}
        .auth-title{font-size:32px;font-weight:300;letter-spacing:6px;margin-bottom:8px}
        .auth-subtitle{font-size:11px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:3px;margin-bottom:32px}
        .auth-msg{padding:14px 18px;border-radius:12px;font-size:13px;margin-bottom:20px;display:none;text-align:left}
        .auth-msg.error{background:var(--red-light);color:var(--red)}.auth-msg.info{background:var(--blue-light);color:var(--blue)}.auth-msg.show{display:block}
        .form-input,.form-select,.form-textarea{width:100%;padding:14px 18px;background:var(--bg-input);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:inherit;font-size:14px;margin-bottom:16px;transition:all .2s}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--gold)}
        .form-input::placeholder{color:var(--text-muted)}
        .form-select{cursor:pointer}.form-select option{background:var(--bg-card)}
        .form-textarea{min-height:100px;resize:vertical}
        .form-group{margin-bottom:16px;text-align:left}
        .form-label{display:block;font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        @media(max-width:600px){.form-row{grid-template-columns:1fr}}
        .btn{padding:14px 28px;background:var(--gold);border:none;border-radius:12px;color:#000;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none}
        .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(212,175,55,0.3)}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .btn-secondary{background:var(--bg-elevated);color:var(--text);border:1px solid var(--border)}
        .btn-secondary:hover:not(:disabled){border-color:var(--gold);color:var(--gold);box-shadow:none;transform:none}
        .btn-danger{background:var(--red);color:#fff}
        .btn-success{background:var(--green);color:#fff}
        .btn-sm{padding:10px 16px;font-size:13px}
        .btn-xs{padding:6px 12px;font-size:11px}
        .btn-block{width:100%}
        .btn-icon{width:36px;height:36px;padding:0;border-radius:8px;font-size:14px}
        .app{display:none;min-height:100vh}.app.active{display:block}
        .header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:0 24px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
        .header-left{display:flex;align-items:center;gap:16px}
        .menu-btn{display:none;width:40px;height:40px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:20px;cursor:pointer;align-items:center;justify-content:center}
        @media(max-width:1000px){.menu-btn{display:flex}}
        .logo{display:flex;align-items:center;gap:12px;text-decoration:none}
        .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,#FFD54F,#F5A623);border-radius:50%;box-shadow:0 0 15px rgba(212,175,55,0.4)}
        .logo-text{font-size:20px;font-weight:300;letter-spacing:4px;color:var(--text)}
        .header-center{flex:1;max-width:400px;margin:0 20px}
        .search-box{display:flex;align-items:center;background:var(--bg-input);border:1px solid var(--border);border-radius:12px;padding:0 16px}
        .search-box input{flex:1;background:none;border:none;color:var(--text);padding:12px 0;font-size:14px;outline:none}
        .search-box input::placeholder{color:var(--text-muted)}
        @media(max-width:800px){.header-center{display:none}}
        .header-right{display:flex;align-items:center;gap:12px}
        .header-badge{padding:6px 14px;border-radius:100px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px}
        .header-badge.admin{background:var(--purple-light);color:var(--purple)}
        .header-badge.landlord{background:var(--gold-light);color:var(--gold)}
        .header-badge.tenant{background:var(--blue-light);color:var(--blue)}
        .notif-btn{position:relative;width:40px;height:40px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .notif-btn .badge,.notif-btn .notif-badge{position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;background:var(--red);color:#fff;font-size:10px;font-weight:700;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 4px}
        .notif-pulse{animation:notifPulse 0.5s ease-in-out 3}
        @keyframes notifPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
        .notif-item.unread{border-left:3px solid var(--gold)}
        .notif-item:hover{background:var(--surface)!important}
        .user-menu{display:flex;align-items:center;gap:10px;cursor:pointer;padding:6px 12px;border-radius:12px;transition:background .2s}
        .user-menu:hover{background:var(--bg-elevated)}
        .user-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--gold),var(--gold-dark));border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:13px;color:#000}
        .user-info{text-align:right}
        .user-name{font-size:13px;font-weight:600}
        .user-role{font-size:11px;color:var(--text-muted)}
        @media(max-width:600px){.user-info{display:none}}
        .layout{display:flex}
        .sidebar{width:260px;background:var(--bg-card);border-right:1px solid var(--border);height:calc(100vh - 64px);position:sticky;top:64px;overflow-y:auto;padding:16px 10px;display:flex;flex-direction:column}
        @media(max-width:1000px){.sidebar{position:fixed;top:0;left:-280px;height:100vh;z-index:200;transition:left .3s ease;padding-top:80px;width:280px}.sidebar.open{left:0}}
        .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:199}.sidebar-overlay.open{display:block}
        .nav-section{margin-bottom:20px}
        .nav-label{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-muted);padding:8px 14px;margin-bottom:4px}
        .nav-item{display:flex;align-items:center;gap:12px;padding:11px 14px;border-radius:10px;color:var(--text-secondary);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;margin-bottom:2px}
        .nav-item:hover{background:var(--bg-elevated);color:var(--text)}
        .nav-item.active{background:var(--gold-light);color:var(--gold)}
        .nav-icon{font-size:16px;width:22px;text-align:center}
        .nav-badge{margin-left:auto;padding:2px 8px;background:var(--red);color:#fff;font-size:10px;font-weight:700;border-radius:8px}
        .nav-badge.gold{background:var(--gold);color:#000}
        .nav-badge.orange{background:var(--orange);color:#000}
        .sidebar-footer{margin-top:auto;padding-top:16px;border-top:1px solid var(--border)}
        .main{flex:1;padding:24px;min-height:calc(100vh - 64px);overflow-x:hidden}
        @media(max-width:600px){.main{padding:16px}}
        .page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:16px}
        .page-title{font-size:24px;font-weight:600}
        .page-subtitle{font-size:14px;color:var(--text-secondary);margin-top:4px}
        .page-actions{display:flex;gap:10px;flex-wrap:wrap}
        .card{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;margin-bottom:20px;overflow:hidden}
        .card-header{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:16px}
        .card-title{font-size:15px;font-weight:600;display:flex;align-items:center;gap:10px}
        .card-body{padding:22px}
        .card-body.flush{padding:0}
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
        @media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:600px){.stats-grid{grid-template-columns:1fr}}
        .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:20px;position:relative;overflow:hidden;cursor:pointer;transition:all .2s}
        .stat-card:hover{border-color:var(--gold);transform:translateY(-2px)}
        .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
        .stat-card.gold::before{background:var(--gold)}.stat-card.green::before{background:var(--green)}.stat-card.orange::before{background:var(--orange)}.stat-card.blue::before{background:var(--blue)}.stat-card.red::before{background:var(--red)}.stat-card.purple::before{background:var(--purple)}
        .stat-icon{width:44px;height:44px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:14px}
        .stat-card.gold .stat-icon{background:var(--gold-light)}.stat-card.green .stat-icon{background:var(--green-light)}.stat-card.orange .stat-icon{background:var(--orange-light)}.stat-card.blue .stat-icon{background:var(--blue-light)}.stat-card.purple .stat-icon{background:var(--purple-light)}.stat-card.red .stat-icon{background:var(--red-light)}
        .stat-value{font-size:26px;font-weight:700;margin-bottom:4px}
        .stat-card.gold .stat-value{color:var(--gold)}.stat-card.green .stat-value{color:var(--green)}.stat-card.orange .stat-value{color:var(--orange)}.stat-card.blue .stat-value{color:var(--blue)}.stat-card.purple .stat-value{color:var(--purple)}.stat-card.red .stat-value{color:var(--red)}
        .stat-label{font-size:12px;color:var(--text-secondary)}
        .stat-sub{font-size:11px;color:var(--text-muted);margin-top:4px}
        .list-item{display:flex;align-items:center;gap:14px;padding:14px 20px;border-bottom:1px solid var(--border);transition:background .15s}
        .list-item:last-child{border-bottom:none}
        .list-item:hover{background:var(--bg-elevated)}
        .list-item.clickable{cursor:pointer}
        .list-icon{width:42px;height:42px;background:var(--bg-elevated);border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
        .list-content{flex:1;min-width:0}
        .list-title{font-size:14px;font-weight:500;margin-bottom:2px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .list-subtitle{font-size:12px;color:var(--text-secondary)}
        .list-meta{text-align:right;flex-shrink:0}
        .list-value{font-size:15px;font-weight:600;margin-bottom:2px}
        .list-actions{display:flex;gap:6px}
        .badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:100px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
        .badge.green{background:var(--green-light);color:var(--green)}.badge.orange{background:var(--orange-light);color:var(--orange)}.badge.red{background:var(--red-light);color:var(--red)}.badge.blue{background:var(--blue-light);color:var(--blue)}.badge.gold{background:var(--gold-light);color:var(--gold)}.badge.purple{background:var(--purple-light);color:var(--purple)}.badge.gray{background:var(--bg-elevated);color:var(--text-muted)}
        .avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--gold),var(--gold-dark));border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;color:#000;flex-shrink:0}
        .avatar.lg{width:56px;height:56px;font-size:18px}.avatar.xl{width:72px;height:72px;font-size:24px}
        .avatar.blue{background:linear-gradient(135deg,var(--blue),#0055b3);color:#fff}.avatar.purple{background:linear-gradient(135deg,var(--purple),#8e44ad);color:#fff}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(8px);display:none;align-items:flex-start;justify-content:center;z-index:300;padding:24px;overflow-y:auto}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;width:100%;max-width:560px;margin:auto;overflow:hidden;animation:modalIn .2s ease}
        .modal.lg{max-width:720px}.modal.xl{max-width:900px}
        @keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(-20px)}to{opacity:1;transform:scale(1) translateY(0)}}
        .modal-header{padding:22px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .modal-title{font-size:18px;font-weight:600}
        .modal-close{width:36px;height:36px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;color:var(--text-secondary);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .modal-close:hover{border-color:var(--red);color:var(--red)}
        .modal-body{padding:24px;max-height:65vh;overflow-y:auto}
        .modal-footer{padding:18px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;background:var(--bg)}
        .detail-header{display:flex;align-items:flex-start;gap:20px;margin-bottom:24px}
        .detail-info{flex:1}
        .detail-title{font-size:20px;font-weight:600;margin-bottom:8px}
        .detail-subtitle{font-size:14px;color:var(--text-secondary);margin-bottom:12px}
        .detail-badges{display:flex;gap:8px;flex-wrap:wrap}
        .detail-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
        @media(max-width:500px){.detail-grid{grid-template-columns:1fr}}
        .detail-label{font-size:11px;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
        .detail-value{font-size:14px;font-weight:500}
        .info-box{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:16px}
        .info-box-title{font-size:12px;font-weight:600;color:var(--gold);margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .info-box-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
        .info-box-row:last-child{border-bottom:none}
        .info-box-label{color:var(--text-secondary)}
        .info-box-value{font-weight:500}
        .file-zone{border:2px dashed var(--border);border-radius:14px;padding:28px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg)}
        .file-zone:hover,.file-zone.dragover{border-color:var(--gold);background:var(--gold-light)}
        .file-zone-icon{font-size:36px;margin-bottom:10px;opacity:.5}
        .file-zone-text{font-size:13px;color:var(--text-secondary)}
        .file-input{display:none}
        .file-preview{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;margin-top:12px}
        .toast-container{position:fixed;bottom:24px;right:24px;z-index:500;display:flex;flex-direction:column;gap:10px;max-width:360px}
        @media(max-width:500px){.toast-container{left:16px;right:16px}}
        .toast{padding:14px 18px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;gap:12px;box-shadow:0 12px 40px rgba(0,0,0,0.4);animation:toastIn .3s ease}
        .toast.success{border-color:var(--green)}.toast.error{border-color:var(--red)}.toast.warning{border-color:var(--orange)}.toast.info{border-color:var(--blue)}
        @keyframes toastIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        @media(max-width:900px){.grid-2{grid-template-columns:1fr}}
        .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
        @media(max-width:900px){.grid-3{grid-template-columns:1fr}}
        .welcome-card{background:linear-gradient(135deg,rgba(212,175,55,0.15),rgba(212,175,55,0.03));border:1px solid rgba(212,175,55,0.3);border-radius:18px;padding:28px;margin-bottom:24px}
        .welcome-title{font-size:26px;font-weight:600;margin-bottom:6px}
        .welcome-text{color:var(--text-secondary);font-size:14px}
        .alert{padding:14px 18px;border-radius:12px;display:flex;align-items:flex-start;gap:12px;margin-bottom:16px}
        .alert.warning{background:var(--orange-light);border:1px solid rgba(255,149,0,0.3)}
        .alert.danger{background:var(--red-light);border:1px solid rgba(255,59,48,0.3)}
        .alert.info{background:var(--blue-light);border:1px solid rgba(0,122,255,0.3)}
        .alert.success{background:var(--green-light);border:1px solid rgba(52,199,89,0.3)}
        .alert-icon{font-size:18px;margin-top:1px}
        .alert-content{flex:1}
        .alert-title{font-weight:600;font-size:13px;margin-bottom:2px}
        .alert.warning .alert-title{color:var(--orange)}.alert.danger .alert-title{color:var(--red)}.alert.info .alert-title{color:var(--blue)}.alert.success .alert-title{color:var(--green)}
        .alert-text{font-size:12px;color:var(--text-secondary)}
        .countdown{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg);border-radius:8px;font-size:12px}
        .countdown.urgent{background:var(--red-light);color:var(--red)}
        .countdown.warning{background:var(--orange-light);color:var(--orange)}
        .countdown.ok{background:var(--green-light);color:var(--green)}
        .contact-card{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;align-items:center;gap:14px}
        .contact-info{flex:1}
        .contact-name{font-weight:600;font-size:14px;margin-bottom:2px}
        .contact-role{font-size:12px;color:var(--text-muted);margin-bottom:6px}
        .contact-details{font-size:12px;color:var(--text-secondary)}
        .contact-actions{display:flex;gap:6px}
        .pipeline{display:flex;gap:14px;overflow-x:auto;padding-bottom:16px}
        .pipeline-col{min-width:240px;max-width:240px;background:var(--bg-elevated);border-radius:14px;display:flex;flex-direction:column}
        .pipeline-header{padding:14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .pipeline-title{font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
        .pipeline-count{padding:3px 8px;background:var(--bg);border-radius:6px;font-size:10px;color:var(--text-muted)}
        .pipeline-cards{flex:1;padding:10px;max-height:50vh;overflow-y:auto}
        .pipeline-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all .15s}
        .pipeline-card:hover{border-color:var(--gold);transform:translateY(-2px)}
        .pipeline-card-name{font-weight:600;margin-bottom:3px;font-size:13px}
        .pipeline-card-service{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;margin-bottom:6px}
        .pipeline-card-service.pfs{background:var(--gold-light);color:var(--gold)}.pipeline-card-service.das{background:var(--blue-light);color:var(--blue)}.pipeline-card-service.vv{background:var(--purple-light);color:var(--purple)}
        .pipeline-card-meta{font-size:10px;color:var(--text-muted)}
        .pipeline-card-value{font-size:12px;font-weight:600;color:var(--gold);margin-top:6px}
        .tabs{display:flex;gap:4px;margin-bottom:20px;overflow-x:auto;padding-bottom:4px}
        .tab{padding:10px 18px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;font-size:13px;font-weight:500;cursor:pointer;white-space:nowrap;transition:all .15s}
        .tab:hover{border-color:var(--gold)}
        .tab.active{background:var(--gold);color:#000;border-color:var(--gold)}
        .empty-state{text-align:center;padding:50px 24px}
        .empty-icon{font-size:48px;margin-bottom:14px;opacity:.4}
        .empty-title{font-size:16px;font-weight:600;margin-bottom:6px}
        .empty-text{font-size:13px;color:var(--text-muted);margin-bottom:20px}
        .text-gold{color:var(--gold)!important}.text-green{color:var(--green)!important}.text-red{color:var(--red)!important}.text-orange{color:var(--orange)!important}.text-muted{color:var(--text-muted)!important}.text-center{text-align:center}
        .mt-8{margin-top:8px}.mt-16{margin-top:16px}.mt-24{margin-top:24px}.mb-8{margin-bottom:8px}.mb-16{margin-bottom:16px}.mb-24{margin-bottom:24px}
        .hidden{display:none!important}
        ::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bg-elevated);border-radius:3px}
        .confirm-modal{text-align:center;padding:20px 0}
        .confirm-icon{font-size:56px;margin-bottom:16px}
        .confirm-title{font-size:20px;font-weight:600;margin-bottom:8px}
        .confirm-text{color:var(--text-secondary);margin-bottom:24px}
    .crm-table { width: 100%; border-collapse: collapse; }
.crm-table th { text-align: left; padding: 12px; font-size: 11px; text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid var(--border); background: var(--bg); }
.crm-table td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; }
.crm-table tbody tr { transition: background .2s; cursor: pointer; }
.crm-table tbody tr:hover { background: var(--bg); }
.modal.xl { width: 800px; max-width: 95vw; }

/* Production additions */
.offline-banner { position: fixed; top: 0; left: 0; right: 0; background: var(--red); color: #fff; text-align: center; padding: 10px; font-size: 13px; font-weight: 600; z-index: 9999; display: none; }
.offline-banner.show { display: block; }
.btn.loading { color: transparent !important; pointer-events: none; position: relative; }
.btn.loading::after { content: ''; position: absolute; width: 16px; height: 16px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin .6s linear infinite; left: 50%; top: 50%; margin-left: -8px; margin-top: -8px; }
.btn.loading.btn-secondary::after { border-top-color: var(--text); }
.form-input.error { border-color: var(--red); }
.form-error { color: var(--red); font-size: 11px; margin-top: -10px; margin-bottom: 10px; }

/* Image Upload Zone */
.image-upload-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all .3s; background: var(--bg); }
.image-upload-zone:hover, .image-upload-zone.dragover { border-color: var(--gold); background: rgba(212,175,55,0.05); }
.image-upload-zone.uploading { pointer-events: none; opacity: 0.7; }
.upload-icon { font-size: 40px; margin-bottom: 10px; }
.upload-text { color: var(--text-secondary); font-size: 13px; margin-bottom: 5px; }
.upload-hint { color: var(--text-muted); font-size: 11px; }
.upload-progress { margin-top: 15px; }
.progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--gold), #FFD54F); width: 0%; transition: width .3s; }
.progress-text { font-size: 11px; color: var(--text-secondary); margin-top: 5px; }
.image-preview { margin-top: 15px; position: relative; display: inline-block; }
.image-preview img { max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border); }
.image-preview .remove-btn { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: var(--red); color: #fff; border: none; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
.uploaded-images { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
.uploaded-image { position: relative; }
.uploaded-image img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border); }
.uploaded-image.primary img { border-color: var(--gold); }
.uploaded-image .badge { position: absolute; top: -5px; left: -5px; font-size: 9px; padding: 2px 6px; }

/* Language Selector */
.lang-selector { display: flex; gap: 4px; background: var(--bg-elevated); padding: 4px; border-radius: 8px; }
.lang-btn { padding: 8px 16px; border: none; background: transparent; color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; border-radius: 6px; transition: all .2s; }
.lang-btn.active { background: var(--gold); color: #000; }
.lang-btn:hover:not(.active) { color: var(--text); }

/* Section Box for forms */
.section-box { background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
.section-title { font-size: 13px; font-weight: 600; color: var(--gold); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

/* Expanded modal */
.modal.xxl { width: 1100px; max-width: 95vw; }
</style>
</head>
<body>
    <!-- Early Protocol Check -->
    <script>
        if (window.location.protocol === 'file:') {
            document.body.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#000;color:#fff;font-family:system-ui;text-align:center;padding:20px">
                    <div>
                        <div style="font-size:60px;margin-bottom:20px">ğŸ–¥ï¸</div>
                        <h1 style="color:#FFD700;margin-bottom:10px">Server Web Richiesto</h1>
                        <p style="color:#999;margin-bottom:20px">Questo file non puÃ² essere aperto direttamente dal computer.<br>Deve essere caricato su un server web.</p>
                        <div style="background:#111;padding:20px;border-radius:8px;text-align:left;margin-bottom:20px">
                            <p style="color:#FFD700;margin-bottom:10px;font-size:12px">âœ… URL CORRETTO:</p>
                            <code style="color:#00FF88">https://www.boomrome.com/portal.html</code>
                            <p style="color:#FF3B3B;margin-top:15px;margin-bottom:10px;font-size:12px">âŒ URL ERRATO:</p>
                            <code style="color:#666">file:///Users/.../portal.html</code>
                        </div>
                        <a href="https://www.boomrome.com/portal.html" style="display:inline-block;padding:12px 30px;background:#FFD700;color:#000;text-decoration:none;font-weight:600;border-radius:8px">Vai al Portal â†’</a>
                    </div>
                </div>
            `;
            throw new Error('File protocol not supported');
        }
    </script>

    <!-- Offline Banner -->
    <div class="offline-banner" id="offlineBanner">âš ï¸ Connessione assente - ModalitÃ  offline</div>
    
    <div class="loading" id="loading"><div class="spinner"></div><div style="color:var(--text-muted);font-size:14px">Caricamento...</div></div>
    <div class="auth hidden" id="authScreen">
        <div class="auth-card">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" class="auth-logo" style="width:72px;height:72px;margin:0 auto 20px;display:block;filter:drop-shadow(0 0 30px rgba(212,175,55,0.5))">
                <defs><linearGradient id="goldGradAuth" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFD54F"/><stop offset="100%" stop-color="#F5A623"/></linearGradient></defs>
                <g transform="translate(0,1024) scale(0.1,-0.1)" fill="url(#goldGradAuth)"><path d="M4860 8749 c-509 -29 -976 -161 -1413 -401 -580 -317 -1057 -806 -1350 -1383 -148 -292 -229 -532 -291 -859 -89 -465 -69 -1005 54 -1461 184 -688 616 -1308 1232 -1769 492 -368 1172 -609 1794 -635 546 -22 987 57 1489 267 503 211 979 589 1327 1053 340 453 557 994 630 1569 17 135 17 630 0 760 -93 716 -396 1341 -900 1861 -280 289 -569 498 -922 667 -416 200 -813 303 -1285 332 -165 10 -170 10 -365 -1z m610 -144 c743 -103 1436 -459 1919 -985 338 -367 562 -751 704 -1205 276 -879 132 -1858 -388 -2640 -242 -364 -493 -615 -900 -900 l-70 -49 109 104 c413 396 679 919 767 1505 33 217 33 558 0 765 -75 476 -257 896 -549 1265 -127 161 -363 380 -549 511 -300 211 -689 363 -1079 420 -172 26 -604 26 -764 0 -296 -47 -545 -128 -808 -262 -236 -122 -440 -271 -632 -464 -486 -485 -749 -1121 -751 -1815 -1 -611 170 -1148 515 -1608 100 -134 286 -335 382 -413 33 -27 -8 -2 -91 55 -513 351 -904 805 -1143 1331 -71 156 -136 336 -168 465 -9 33 -19 76 -24 95 -5 19 -20 100 -34 180 -59 343 -60 740 0 1070 81 456 229 826 479 1200 246 368 558 669 949 917 386 245 881 418 1321 462 61 6 124 13 140 15 73 10 556 -4 665 -19z"/></g>
            </svg>
            <h1 class="auth-title">BOOM</h1>
            <p class="auth-subtitle">Property Portal</p>
            <div class="auth-msg error" id="authError"></div>
            <div class="auth-msg info" id="authInfo"></div>
            <form id="loginForm">
                <input type="email" class="form-input" id="loginEmail" placeholder="Email" required>
                <input type="password" class="form-input" id="loginPassword" placeholder="Password" required>
                <button type="submit" class="btn btn-block">Accedi</button>
            </form>
            <form id="setupForm" class="hidden">
                <input type="text" class="form-input" id="setupName" placeholder="Nome Completo" required>
                <input type="email" class="form-input" id="setupEmail" placeholder="Email" required>
                <input type="password" class="form-input" id="setupPassword" placeholder="Password (min 6 caratteri)" required minlength="6">
                <button type="submit" class="btn btn-block">Crea Account Admin</button>
            </form>
        </div>
    </div>
    <div class="app" id="app">
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
                <a href="#" class="logo" onclick="goTo('dashboard');return false">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" style="width:36px;height:36px;filter:drop-shadow(0 0 15px rgba(212,175,55,0.4))">
                        <defs><linearGradient id="goldGradHeader" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFD54F"/><stop offset="100%" stop-color="#F5A623"/></linearGradient></defs>
                        <g transform="translate(0,1024) scale(0.1,-0.1)" fill="url(#goldGradHeader)"><path d="M4860 8749 c-509 -29 -976 -161 -1413 -401 -580 -317 -1057 -806 -1350 -1383 -148 -292 -229 -532 -291 -859 -89 -465 -69 -1005 54 -1461 184 -688 616 -1308 1232 -1769 492 -368 1172 -609 1794 -635 546 -22 987 57 1489 267 503 211 979 589 1327 1053 340 453 557 994 630 1569 17 135 17 630 0 760 -93 716 -396 1341 -900 1861 -280 289 -569 498 -922 667 -416 200 -813 303 -1285 332 -165 10 -170 10 -365 -1z"/></g>
                    </svg>
                    <span class="logo-text">BOOM</span>
                </a>
            </div>
            <div class="header-center" id="searchContainer"></div>
            <div class="header-right">
                <span class="header-badge" id="headerBadge">Admin</span>
                <button class="notif-btn" onclick="showNotifications()" id="notifBtn">ğŸ””</button>
                <div class="user-menu" onclick="goTo('settings')">
                    <div class="user-avatar" id="headerAvatar">VR</div>
                    <div class="user-info"><div class="user-name" id="headerName">Nome</div><div class="user-role" id="headerRole">Ruolo</div></div>
                </div>
            </div>
        </header>
        <div class="layout">
            <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
            <aside class="sidebar" id="sidebar"></aside>
            <main class="main" id="main"></main>
        </div>
    </div>
    <div class="toast-container" id="toasts"></div>
    <div id="modals"></div>

    <script>
        // Track script loading
        window.firebaseScriptsLoaded = 0;
        window.firebaseScriptsTotal = 4;
        function onFirebaseScriptLoad() {
            window.firebaseScriptsLoaded++;
            console.log(`Firebase script ${window.firebaseScriptsLoaded}/${window.firebaseScriptsTotal} loaded`);
        }
        function onFirebaseScriptError(e) {
            console.error('Failed to load Firebase script:', e.target.src);
            document.body.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#000;color:#fff;font-family:system-ui;text-align:center;padding:20px">
                    <div>
                        <div style="font-size:60px;margin-bottom:20px">âš ï¸</div>
                        <h1 style="color:#FFD700;margin-bottom:10px">Errore Caricamento Script</h1>
                        <p style="color:#999;margin-bottom:20px">Impossibile caricare Firebase SDK.<br>Script: ${e.target.src}</p>
                        <ul style="color:#666;text-align:left;display:inline-block;margin-bottom:20px">
                            <li>Disabilita AdBlocker per questo sito</li>
                            <li>Controlla la connessione internet</li>
                            <li>Prova con un altro browser</li>
                        </ul>
                        <button onclick="location.reload()" style="padding:12px 30px;background:#FFD700;color:#000;border:none;font-weight:600;cursor:pointer;border-radius:8px">ğŸ”„ Riprova</button>
                    </div>
                </div>
            `;
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js" onload="onFirebaseScriptLoad()" onerror="onFirebaseScriptError(event)"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js" onload="onFirebaseScriptLoad()" onerror="onFirebaseScriptError(event)"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js" onload="onFirebaseScriptLoad()" onerror="onFirebaseScriptError(event)"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js" onload="onFirebaseScriptLoad()" onerror="onFirebaseScriptError(event)"></script>
    <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIREBASE LOADING CHECK
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (typeof firebase === 'undefined') {
        console.error('âŒ Firebase SDK not loaded! Check network connection or ad blocker.');
        document.body.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#000;color:#fff;font-family:system-ui;text-align:center;padding:20px">
                <div>
                    <div style="font-size:60px;margin-bottom:20px">âš ï¸</div>
                    <h1 style="color:#FFD700;margin-bottom:10px">Errore Caricamento</h1>
                    <p style="color:#999;margin-bottom:20px">Firebase SDK non caricato.<br>Possibili cause:</p>
                    <ul style="color:#666;text-align:left;display:inline-block;margin-bottom:20px">
                        <li>Ad blocker attivo (disabilita per questo sito)</li>
                        <li>Problema di connessione internet</li>
                        <li>Firewall aziendale che blocca gstatic.com</li>
                    </ul>
                    <button onclick="location.reload()" style="padding:12px 30px;background:#FFD700;color:#000;border:none;font-weight:600;cursor:pointer;border-radius:8px">ğŸ”„ Riprova</button>
                </div>
            </div>
        `;
        throw new Error('Firebase SDK not available');
    }
    console.log('âœ… Firebase SDK loaded successfully');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PRODUCTION CONFIGURATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const CONFIG = {
        // âš ï¸ CHANGE TO 'production' WHEN DEPLOYING
        ENV: 'development',
        
        // Session timeout: 30 minutes of inactivity
        SESSION_TIMEOUT: 30 * 60 * 1000,
        
        // Firebase configurations
        FIREBASE: {
            development: {
                apiKey: "AIzaSyDDb8UeSc8RhO_VxQrhLrupu1aPD4rwRso",
                authDomain: "boom-property-dashboards.firebaseapp.com",
                projectId: "boom-property-dashboards",
                storageBucket: "boom-property-dashboards.firebasestorage.app",
                messagingSenderId: "937269017440",
                appId: "1:937269017440:web:41c1a0b1e1633c2f373c05"
            },
            production: {
                // âš ï¸ REPLACE WITH YOUR PRODUCTION FIREBASE CONFIG
                apiKey: "YOUR_PROD_API_KEY",
                authDomain: "your-prod-project.firebaseapp.com",
                projectId: "your-prod-project",
                storageBucket: "your-prod-project.appspot.com",
                messagingSenderId: "YOUR_SENDER_ID",
                appId: "YOUR_APP_ID"
            }
        }
    };

    // Initialize Firebase with appropriate config
    const firebaseConfig = CONFIG.FIREBASE[CONFIG.ENV];
    let firebaseInitError = null;
    
    try {
        firebase.initializeApp(firebaseConfig);
        console.log(`ğŸš€ BOOM Portal initialized [${CONFIG.ENV}]`);
    } catch (err) {
        firebaseInitError = err;
        console.error('Firebase init failed:', err);
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    
    // Enable offline persistence
    db.enablePersistence({ synchronizeTabs: true }).catch(err => {
        if (err.code === 'failed-precondition') {
            console.warn('Persistence: multiple tabs open');
        } else if (err.code === 'unimplemented') {
            console.warn('Persistence: browser not supported');
        }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPANY INFO - UPDATE THESE FOR YOUR BUSINESS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const COMPANY = {
        name: 'BOOM',
        legal: 'Egidi Immobiliare S.r.l.',
        address: 'Roma, Italia',
        piva: '17546591000',
        email: 'info@boomrome.com',
        phone: '+39 331 325 1961',
        website: 'www.boomrome.com',
        // âš ï¸ UPDATE WITH YOUR REAL IBAN
        iban: 'IT00X0000000000000000000000'
    };
    
    // Make.com Webhook for email notifications
    const WEBHOOK_URL = 'https://hook.eu1.make.com/9z8afoyco6l8bg57wbgmmx6chsc6mayx';

    const SERVICES = {
        PFS: { name: 'Property Finding Service', price: 350, color: 'gold' },
        DAS: { name: 'Deal Assistance Service', price: 249, color: 'blue' },
        VV: { name: 'Virtual Viewing', price: 89, color: 'purple' }
    };

    const PIPELINE_STAGES = [
        { id: 'lead', name: 'Lead', icon: 'ğŸ“¥' },
        { id: 'contacted', name: 'Contattato', icon: 'ğŸ“' },
        { id: 'qualified', name: 'Qualificato', icon: 'âœ…' },
        { id: 'searching', name: 'Ricerca', icon: 'ğŸ”' },
        { id: 'found', name: 'Trovato', icon: 'ğŸ ' },
        { id: 'closing', name: 'Chiusura', icon: 'ğŸ“' },
        { id: 'paid', name: 'Pagato', icon: 'ğŸ’°' },
        { id: 'completed', name: 'Completato', icon: 'ğŸ‰' },
        { id: 'lost', name: 'Perso', icon: 'âŒ' }
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const S = {
        user: null, profile: null, page: 'dashboard', lang: 'IT',
        users: [], properties: [], contracts: [], payments: [],
        maintenance: [], documents: [], clients: [], invoices: [], notifications: [],
        userNotifications: [], // Persistent notifications from Firestore
        listings: [], // For adminflats
        lastActivity: Date.now(),
        isOnline: navigator.onLine,
        notifListener: null // Real-time listener reference
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRANSLATIONS (IT/EN)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const LANG = {
        IT: {
            landlord: 'Locatore', tenant: 'Conduttore', property: 'Immobile', rent: 'Canone',
            deposit: 'Deposito Cauzionale', duration: 'Durata', startDate: 'Data Inizio', endDate: 'Data Fine',
            signature: 'Firma', date: 'Data', address: 'Indirizzo', cf: 'Codice Fiscale',
            birthDate: 'Data di Nascita', birthPlace: 'Luogo di Nascita', residence: 'Residenza',
            floor: 'Piano', rooms: 'Vani', cadastral: 'Dati Catastali', sheet: 'Foglio', parcel: 'Particella', sub: 'Subalterno',
            sqm: 'Superficie mq', furnished: 'Ammobiliato', unfurnished: 'Non Ammobiliato',
            accessories: 'Accessori', cellar: 'Cantina', garage: 'Autorimessa', parking: 'Posto Auto',
            balcony: 'Balcone', terrace: 'Terrazzo', energyClass: 'Classe Energetica',
            monthlyRent: 'Canone Mensile', annualRent: 'Canone Annuo', payments: 'Rate',
            paymentMethod: 'ModalitÃ  Pagamento', bankTransfer: 'Bonifico Bancario', cash: 'Contanti',
            cedolareSecca: 'Cedolare Secca', istatUpdate: 'Aggiornamento ISTAT',
            contractType4plus4: 'Contratto di Locazione Abitativa 4+4',
            contractTypeTransitorio: 'Contratto di Locazione Transitoria',
            contractTypeStudenti: 'Contratto per Studenti Universitari',
            article: 'Articolo', transitoryReason: 'Motivazione Transitoria',
            university: 'UniversitÃ ', course: 'Corso di Studi',
            receipt: 'Ricevuta', amount: 'Importo', period: 'Periodo', total: 'Totale'
        },
        EN: {
            landlord: 'Landlord', tenant: 'Tenant', property: 'Property', rent: 'Rent',
            deposit: 'Security Deposit', duration: 'Duration', startDate: 'Start Date', endDate: 'End Date',
            signature: 'Signature', date: 'Date', address: 'Address', cf: 'Tax ID',
            birthDate: 'Date of Birth', birthPlace: 'Place of Birth', residence: 'Residence',
            floor: 'Floor', rooms: 'Rooms', cadastral: 'Cadastral Data', sheet: 'Sheet', parcel: 'Parcel', sub: 'Sub',
            sqm: 'Area sqm', furnished: 'Furnished', unfurnished: 'Unfurnished',
            accessories: 'Accessories', cellar: 'Cellar', garage: 'Garage', parking: 'Parking',
            balcony: 'Balcony', terrace: 'Terrace', energyClass: 'Energy Class',
            monthlyRent: 'Monthly Rent', annualRent: 'Annual Rent', payments: 'Payments',
            paymentMethod: 'Payment Method', bankTransfer: 'Bank Transfer', cash: 'Cash',
            cedolareSecca: 'Flat Tax', istatUpdate: 'ISTAT Adjustment',
            contractType4plus4: 'Residential Lease Agreement 4+4',
            contractTypeTransitorio: 'Transitional Lease Agreement',
            contractTypeStudenti: 'Student Housing Lease Agreement',
            article: 'Article', transitoryReason: 'Transitional Reason',
            university: 'University', course: 'Course of Study',
            receipt: 'Receipt', amount: 'Amount', period: 'Period', total: 'Total'
        }
    };
    
    function t(key) { return LANG[S.lang][key] || key; }
    function setLang(lang) { S.lang = lang; renderPage(); toast('success', `Lingua: ${lang === 'IT' ? 'Italiano' : 'English'}`); }

    let selectedFile = null;
    let sessionCheckInterval = null;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NETWORK & SESSION MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.addEventListener('online', () => {
        S.isOnline = true;
        document.getElementById('offlineBanner')?.classList.remove('show');
        toast('success', 'Connessione ripristinata');
        refresh();
    });

    window.addEventListener('offline', () => {
        S.isOnline = false;
        document.getElementById('offlineBanner')?.classList.add('show');
        toast('warning', 'Connessione assente', 'Alcune funzioni potrebbero non funzionare');
    });

    function updateActivity() { S.lastActivity = Date.now(); }
    
    function checkSession() {
        if (S.user && (Date.now() - S.lastActivity > CONFIG.SESSION_TIMEOUT)) {
            toast('warning', 'Sessione scaduta', 'Effettua nuovamente il login');
            logout();
        }
    }

    function startSessionCheck() {
        stopSessionCheck();
        sessionCheckInterval = setInterval(checkSession, 60000);
    }

    function stopSessionCheck() {
        if (sessionCheckInterval) {
            clearInterval(sessionCheckInterval);
            sessionCheckInterval = null;
        }
    }

    document.addEventListener('click', updateActivity);
    document.addEventListener('keypress', updateActivity);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RBAC & DATA FILTERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function isAdmin() { return S.profile?.role === 'admin'; }
    function isLandlord() { return S.profile?.role === 'landlord'; }
    function isTenant() { return S.profile?.role === 'tenant'; }

    function getMyProperties() {
        if (isAdmin()) return S.properties;
        if (isLandlord()) return S.properties.filter(p => p.ownerId === S.profile.id);
        return [];
    }

    function getMyContracts() {
        if (isAdmin()) return S.contracts;
        if (isLandlord()) {
            const myPropIds = getMyProperties().map(p => p.id);
            return S.contracts.filter(c => myPropIds.includes(c.propertyId));
        }
        if (isTenant()) return S.contracts.filter(c => c.tenantId === S.profile.id);
        return [];
    }

    function getMyPayments() {
        if (isAdmin()) return S.payments;
        const myContractIds = getMyContracts().map(c => c.id);
        return S.payments.filter(p => myContractIds.includes(p.contractId));
    }

    function getMyMaintenance() {
        if (isAdmin()) return S.maintenance;
        if (isLandlord()) {
            const myPropIds = getMyProperties().map(p => p.id);
            return S.maintenance.filter(m => myPropIds.includes(m.propertyId));
        }
        if (isTenant()) return S.maintenance.filter(m => m.userId === S.profile.id);
        return [];
    }

    function getMyDocuments() {
        if (isAdmin()) return S.documents;
        // Tenant/landlord see their own + shared docs for their properties
        const myPropIds = isTenant() ? getMyContracts().map(c => c.propertyId) : getMyProperties().map(p => p.id);
        return S.documents.filter(d => d.userId === S.profile.id || (d.shared && myPropIds.includes(d.propertyId)));
    }

    // Get owner/admin contact for tenant
    function getMyLandlord() {
        if (!isTenant()) return null;
        const myContract = getMyContracts().find(c => c.status === 'active');
        if (!myContract) return null;
        const prop = S.properties.find(p => p.id === myContract.propertyId);
        if (!prop) return null;
        return S.users.find(u => u.id === prop.ownerId);
    }

    function getAdmin() {
        return S.users.find(u => u.role === 'admin');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATE & ALERT UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function daysUntil(dateStr) {
        if (!dateStr) return null;
        const d = dateStr.toDate ? dateStr.toDate() : new Date(dateStr);
        if (isNaN(d.getTime())) return null;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        d.setHours(0, 0, 0, 0);
        return Math.ceil((d - today) / (1000 * 60 * 60 * 24));
    }

    function daysSince(dateStr) {
        const days = daysUntil(dateStr);
        return days !== null ? -days : null;
    }

    function isOverdue(dateStr) {
        const days = daysUntil(dateStr);
        return days !== null && days < 0;
    }

    function getCountdownClass(days) {
        if (days === null) return '';
        if (days < 0) return 'urgent';
        if (days <= 7) return 'warning';
        return 'ok';
    }

    function formatCountdown(days) {
        if (days === null) return '';
        if (days < 0) return `${Math.abs(days)} giorni fa`;
        if (days === 0) return 'Oggi';
        if (days === 1) return 'Domani';
        return `${days} giorni`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Detect Safari desktop
    const isSafariDesktop = /^((?!chrome|android).)*safari/i.test(navigator.userAgent) && !/mobile/i.test(navigator.userAgent);
    if (isSafariDesktop) console.log('Safari desktop detected');
    
    // Set persistence - try LOCAL first, fall back to SESSION for Safari
    (async () => {
        try {
            await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
            console.log('Persistence set to LOCAL');
        } catch (e) {
            console.log('LOCAL persistence failed, trying SESSION:', e.message);
            try {
                await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                console.log('Persistence set to SESSION');
            } catch (e2) {
                console.log('SESSION persistence also failed:', e2.message);
            }
        }
    })();
    
    // Track if auth already processed
    let authProcessed = false;
    let authRetryCount = 0;
    const maxAuthRetries = 3;
    
    // Auth timeout - longer for Safari
    let authTimeout = setTimeout(() => {
        if (!authProcessed) {
            console.log('Auth timeout - no response');
            hideLoading();
            showAuth();
        }
    }, isSafariDesktop ? 20000 : 12000);
    
    auth.onAuthStateChanged(async u => {
        // Prevent multiple processing
        if (authProcessed && u) return;
        
        clearTimeout(authTimeout);
        console.log('Auth state changed:', u ? u.email : 'no user');
        
        if (u) {
            authProcessed = true;
            S.user = u;
            try {
                const doc = await db.collection('users').doc(u.uid).get();
                if (doc.exists) {
                    S.profile = { id: u.uid, ...doc.data() };
                    await db.collection('users').doc(u.uid).update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() }).catch(() => {});
                    await loadData();
                    showApp();
                    startSessionCheck();
                } else {
                    console.log('Creating new user document...');
                    await db.collection('users').doc(u.uid).set({
                        name: u.displayName || u.email.split('@')[0],
                        email: u.email, role: 'admin', phone: '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    location.reload();
                }
            } catch (e) { 
                console.error('Auth error:', e);
                // Retry logic for Safari
                if (isSafariDesktop && authRetryCount < maxAuthRetries) {
                    authRetryCount++;
                    console.log('Retrying auth... attempt', authRetryCount);
                    authProcessed = false;
                    setTimeout(() => auth.onAuthStateChanged(() => {}), 1000);
                    return;
                }
                showAuthError('Errore di autenticazione: ' + e.message); 
                hideLoading(); 
                showAuth(); 
            }
        } else { 
            console.log('No user, checking setup...');
            stopSessionCheck();
            await checkSetup(); 
        }
    });

    async function checkSetup() {
        try {
            console.log('Checking setup...');
            const q = await db.collection('users').where('role', '==', 'admin').limit(1).get();
            console.log('Setup check complete, admins found:', !q.empty);
            hideLoading(); 
            showAuth();
            if (q.empty) {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('setupForm').classList.remove('hidden');
                showAuthInfo('Prima configurazione: crea il tuo account amministratore');
            }
        } catch (e) { 
            console.error('Setup check error:', e);
            hideLoading(); 
            showAuth(); 
        }
    }

    async function loadData() {
        console.log('Loading data...');
        try {
            const [users, props, contracts, payments, maint, docs, clients, invoices] = await Promise.all([
                db.collection('users').get(),
                db.collection('properties').get(),
                db.collection('contracts').get(),
                db.collection('payments').get(),
                db.collection('maintenance').get(),
                db.collection('documents').get(),
                db.collection('clients').get(),
                db.collection('invoices').get()
            ]);
            console.log('Core data loaded');
            S.users = users.docs.map(d => ({ id: d.id, ...d.data() }));
            S.properties = props.docs.map(d => ({ id: d.id, ...d.data() }));
            S.contracts = contracts.docs.map(d => ({ id: d.id, ...d.data() }));
            S.payments = payments.docs.map(d => ({ id: d.id, ...d.data() }));
            S.maintenance = maint.docs.map(d => ({ id: d.id, ...d.data() }));
            S.documents = docs.docs.map(d => ({ id: d.id, ...d.data() }));
            S.clients = clients.docs.map(d => ({ id: d.id, ...d.data() }));
            S.invoices = invoices.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Load listings separately (might not exist yet)
            try {
                const listings = await db.collection('listings').get();
                S.listings = listings.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e) { 
                console.log('Listings collection not found, using empty array');
                S.listings = []; 
            }
            
            console.log('All data loaded successfully');
            checkAlerts();
        } catch (e) { 
            console.error('Load data error:', e);
            toast('error', 'Errore caricamento', e.message); 
        }
    }

    function checkAlerts() {
        S.notifications = [];
        // Contract expiring alerts
        S.contracts.filter(c => c.status === 'active').forEach(c => {
            const days = daysUntil(c.endDate);
            if (days !== null && days <= 30 && days >= 0) {
                S.notifications.push({ type: 'warning', title: 'Contratto in scadenza', text: `${S.properties.find(p => p.id === c.propertyId)?.name || 'Immobile'} - ${days} giorni`, id: c.id });
            }
        });
        // Overdue payments
        S.payments.filter(p => p.status === 'pending').forEach(p => {
            if (isOverdue(p.dueDate)) {
                const c = S.contracts.find(x => x.id === p.contractId);
                const prop = c ? S.properties.find(x => x.id === c.propertyId) : null;
                S.notifications.push({ type: 'danger', title: 'Pagamento in ritardo', text: `${prop?.name || ''} - â‚¬${p.amount}`, id: p.id });
            }
        });
        // Open maintenance
        S.maintenance.filter(m => m.status === 'open' && m.priority === 'urgent').forEach(m => {
            S.notifications.push({ type: 'danger', title: 'Manutenzione urgente', text: m.title, id: m.id });
        });
        updateNotifBadge();
    }

    function updateNotifBadge() {
        const btn = document.getElementById('notifBtn');
        const systemCount = S.notifications.length;
        const userUnread = S.userNotifications.filter(n => !n.read).length;
        const count = systemCount + userUnread;
        btn.innerHTML = count > 0 ? `ğŸ””<span class="notif-badge">${count > 9 ? '9+' : count}</span>` : 'ğŸ””';
        btn.style.position = 'relative';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NOTIFICATION SYSTEM - Persistent & Real-time
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function startNotificationListener() {
        if (!S.profile?.id) return;
        
        // Stop existing listener if any
        if (S.notifListener) S.notifListener();
        
        // Listen for notifications for this user
        S.notifListener = db.collection('notifications')
            .where('userId', '==', S.profile.id)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .onSnapshot(snapshot => {
                S.userNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateNotifBadge();
                // Play sound for new unread notifications
                const newUnread = S.userNotifications.filter(n => !n.read && isRecent(n.createdAt, 30));
                if (newUnread.length > 0 && document.hidden === false) {
                    // Visual feedback for new notification
                    document.getElementById('notifBtn')?.classList.add('notif-pulse');
                    setTimeout(() => document.getElementById('notifBtn')?.classList.remove('notif-pulse'), 2000);
                }
            }, err => console.error('Notification listener error:', err));
    }
    
    function stopNotificationListener() {
        if (S.notifListener) {
            S.notifListener();
            S.notifListener = null;
        }
    }
    
    function isRecent(timestamp, seconds = 30) {
        if (!timestamp) return false;
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return (Date.now() - date.getTime()) < seconds * 1000;
    }
    
    async function createNotification(userId, type, title, message, data = {}) {
        if (!userId) return;
        try {
            // Get recipient user data
            const recipient = S.users.find(u => u.id === userId);
            
            const notifData = {
                userId,
                type, // 'maintenance', 'payment', 'contract', 'document', 'system'
                title,
                message,
                data, // Additional context (propertyId, contractId, etc.)
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                emailSent: false,
                webhookSent: false
            };
            
            const docRef = await db.collection('notifications').add(notifData);
            console.log('Notification created for user:', userId);
            
            // Send to Make.com webhook for email
            if (recipient?.email && WEBHOOK_URL) {
                try {
                    await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            notificationId: docRef.id,
                            recipientEmail: recipient.email,
                            recipientName: recipient.name || 'Cliente',
                            type,
                            title,
                            message,
                            propertyName: data.propertyId ? S.properties.find(p => p.id === data.propertyId)?.name : null,
                            priority: data.priority || 'normal',
                            timestamp: new Date().toISOString(),
                            portalUrl: 'https://boomrome.com/portal.html'
                        })
                    });
                    // Mark webhook as sent
                    await db.collection('notifications').doc(docRef.id).update({ webhookSent: true });
                    console.log('Webhook sent for notification');
                } catch (webhookErr) {
                    console.error('Webhook error:', webhookErr);
                }
            }
        } catch (err) {
            console.error('Error creating notification:', err);
        }
    }
    
    async function notifyMultipleUsers(userIds, type, title, message, data = {}) {
        const promises = userIds.map(userId => createNotification(userId, type, title, message, data));
        await Promise.all(promises);
    }
    
    async function markNotificationRead(notifId) {
        try {
            await db.collection('notifications').doc(notifId).update({ read: true, readAt: firebase.firestore.FieldValue.serverTimestamp() });
        } catch (err) { console.error('Error marking notification read:', err); }
    }
    
    async function markAllNotificationsRead() {
        try {
            const batch = db.batch();
            S.userNotifications.filter(n => !n.read).forEach(n => {
                batch.update(db.collection('notifications').doc(n.id), { read: true, readAt: firebase.firestore.FieldValue.serverTimestamp() });
            });
            await batch.commit();
            toast('success', 'Tutte le notifiche segnate come lette');
        } catch (err) { toast('error', 'Errore', err.message); }
    }
    
    async function deleteNotification(notifId) {
        try {
            await db.collection('notifications').doc(notifId).delete();
        } catch (err) { toast('error', 'Errore', err.message); }
    }
    
    async function clearAllNotifications() {
        if (!confirm('Eliminare tutte le notifiche?')) return;
        try {
            const batch = db.batch();
            S.userNotifications.forEach(n => batch.delete(db.collection('notifications').doc(n.id)));
            await batch.commit();
            toast('success', 'Notifiche eliminate');
        } catch (err) { toast('error', 'Errore', err.message); }
    }
    
    function showNotifications() {
        const allNotifs = [
            ...S.notifications.map(n => ({ ...n, source: 'system', read: true })),
            ...S.userNotifications.map(n => ({ ...n, source: 'user' }))
        ].sort((a, b) => {
            const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
            const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
            return dateB - dateA;
        });
        
        const notifTypeIcon = (type) => ({ maintenance: 'ğŸ”§', payment: 'ğŸ’³', contract: 'ğŸ“‹', document: 'ğŸ“„', system: 'âš¡', warning: 'âš ï¸', danger: 'ğŸš¨' }[type] || 'ğŸ””');
        const notifTypeColor = (type) => ({ maintenance: 'blue', payment: 'gold', contract: 'green', document: 'purple', danger: 'red', warning: 'orange' }[type] || 'gray');
        
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal lg">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ”” Notifiche ${allNotifs.length > 0 ? `(${allNotifs.filter(n => !n.read).length} non lette)` : ''}</h3>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" style="max-height:60vh;overflow-y:auto;padding:0">
                ${allNotifs.length > 0 ? allNotifs.map(n => `
                    <div class="notif-item ${n.read ? 'read' : 'unread'}" style="padding:14px 20px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:flex-start;cursor:pointer;background:${n.read ? 'transparent' : 'rgba(212,175,55,0.05)'}" onclick="${n.source === 'user' && !n.read ? `markNotificationRead('${n.id}')` : ''}">
                        <div style="width:36px;height:36px;border-radius:50%;background:var(--${notifTypeColor(n.type)}-light);display:flex;align-items:center;justify-content:center;flex-shrink:0">${notifTypeIcon(n.type)}</div>
                        <div style="flex:1;min-width:0">
                            <div style="font-weight:${n.read ? '400' : '600'};margin-bottom:2px">${n.title}</div>
                            <div style="font-size:13px;color:var(--text-muted)">${n.text || n.message || ''}</div>
                            <div style="font-size:11px;color:var(--text-dim);margin-top:4px">${n.createdAt ? fmtDate(n.createdAt) : 'Ora'}</div>
                        </div>
                        ${n.source === 'user' ? `<button class="btn btn-xs btn-secondary" onclick="event.stopPropagation();deleteNotification('${n.id}')" title="Elimina">Ã—</button>` : ''}
                    </div>
                `).join('') : '<div class="empty-state" style="padding:40px"><div class="empty-icon">ğŸ””</div><div class="empty-title">Nessuna notifica</div><div class="empty-subtitle">Sei al passo con tutto!</div></div>'}
            </div>
            ${allNotifs.length > 0 ? `<div class="modal-footer" style="justify-content:space-between">
                <button class="btn btn-secondary btn-sm" onclick="clearAllNotifications()">ğŸ—‘ Elimina tutte</button>
                <button class="btn btn-sm" onclick="markAllNotificationsRead()">âœ“ Segna tutte lette</button>
            </div>` : ''}
        </div></div>`;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NOTIFICATION TRIGGERS - Called on specific events
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function notifyMaintenanceRequest(maintenanceData) {
        // Notify landlord of the property
        const property = S.properties.find(p => p.id === maintenanceData.propertyId);
        if (!property) return;
        const landlord = S.users.find(u => u.id === property.ownerId);
        if (!landlord) return;
        
        const requester = S.users.find(u => u.id === maintenanceData.userId);
        await createNotification(
            landlord.id,
            'maintenance',
            'ğŸ”§ Nuova richiesta manutenzione',
            `${requester?.name || 'Inquilino'} ha segnalato: "${maintenanceData.title}" per ${property.name}`,
            { maintenanceId: maintenanceData.id, propertyId: property.id, priority: maintenanceData.priority }
        );
        
        // Also notify admins
        const admins = S.users.filter(u => u.role === 'admin' && u.id !== landlord.id);
        for (const admin of admins) {
            await createNotification(admin.id, 'maintenance', 'ğŸ”§ Nuova manutenzione', `${property.name}: ${maintenanceData.title}`, { maintenanceId: maintenanceData.id });
        }
    }
    
    async function notifyMaintenanceResolved(maintenanceData) {
        // Notify the tenant who requested it
        if (!maintenanceData.userId) return;
        const property = S.properties.find(p => p.id === maintenanceData.propertyId);
        await createNotification(
            maintenanceData.userId,
            'maintenance',
            'âœ… Manutenzione completata',
            `La richiesta "${maintenanceData.title}" per ${property?.name || 'immobile'} Ã¨ stata risolta`,
            { maintenanceId: maintenanceData.id }
        );
    }
    
    async function notifyPaymentReceived(paymentData) {
        // Notify landlord
        const contract = S.contracts.find(c => c.id === paymentData.contractId);
        if (!contract) return;
        const property = S.properties.find(p => p.id === contract.propertyId);
        if (!property) return;
        const landlord = S.users.find(u => u.id === property.ownerId);
        if (!landlord) return;
        const tenant = S.users.find(u => u.id === contract.tenantId);
        
        await createNotification(
            landlord.id,
            'payment',
            'ğŸ’° Pagamento ricevuto',
            `${tenant?.name || 'Inquilino'} ha pagato â‚¬${paymentData.amount} per ${property.name} (${paymentData.month})`,
            { paymentId: paymentData.id, propertyId: property.id, amount: paymentData.amount }
        );
    }
    
    async function notifyPaymentDueSoon(payment, daysUntilDue) {
        // Notify tenant
        const contract = S.contracts.find(c => c.id === payment.contractId);
        if (!contract) return;
        const property = S.properties.find(p => p.id === contract.propertyId);
        
        await createNotification(
            contract.tenantId,
            'payment',
            'â° Pagamento in scadenza',
            `Il pagamento di â‚¬${payment.amount} per ${property?.name || 'immobile'} scade tra ${daysUntilDue} giorni`,
            { paymentId: payment.id, dueDate: payment.dueDate }
        );
    }
    
    async function notifyContractExpiringSoon(contract, daysUntilEnd) {
        const property = S.properties.find(p => p.id === contract.propertyId);
        const tenant = S.users.find(u => u.id === contract.tenantId);
        const landlord = property ? S.users.find(u => u.id === property.ownerId) : null;
        
        const message = `Il contratto per ${property?.name || 'immobile'} scade tra ${daysUntilEnd} giorni`;
        
        // Notify tenant
        if (tenant) {
            await createNotification(tenant.id, 'contract', 'ğŸ“‹ Contratto in scadenza', message, { contractId: contract.id });
        }
        
        // Notify landlord
        if (landlord) {
            await createNotification(landlord.id, 'contract', 'ğŸ“‹ Contratto in scadenza', `${message} - Inquilino: ${tenant?.name || 'N/A'}`, { contractId: contract.id });
        }
    }
    
    async function notifyNewDocument(document, assignedUserId) {
        if (!assignedUserId) return;
        await createNotification(
            assignedUserId,
            'document',
            'ğŸ“„ Nuovo documento disponibile',
            `Ãˆ stato caricato un nuovo documento: "${document.name}"`,
            { documentId: document.id, type: document.type }
        );
    }
    
    // Check and send scheduled notifications (run periodically)
    async function checkScheduledNotifications() {
        if (!isAdmin()) return; // Only admin triggers scheduled notifications
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Check payments due in 5 days
        for (const payment of S.payments.filter(p => p.status === 'pending')) {
            const days = daysUntil(payment.dueDate);
            if (days === 5) {
                // Check if notification already sent today
                const existing = S.userNotifications.find(n => 
                    n.data?.paymentId === payment.id && 
                    n.type === 'payment' &&
                    isToday(n.createdAt)
                );
                if (!existing) await notifyPaymentDueSoon(payment, 5);
            }
        }
        
        // Check contracts expiring in 30 days
        for (const contract of S.contracts.filter(c => c.status === 'active')) {
            const days = daysUntil(contract.endDate);
            if (days === 30 || days === 7) {
                const existing = S.userNotifications.find(n => 
                    n.data?.contractId === contract.id && 
                    n.type === 'contract' &&
                    n.title.includes('scadenza') &&
                    isToday(n.createdAt)
                );
                if (!existing) await notifyContractExpiringSoon(contract, days);
            }
        }
    }
    
    function isToday(timestamp) {
        if (!timestamp) return false;
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        const today = new Date();
        return date.toDateString() === today.toDateString();
    }

    async function refresh() { 
        try {
            await loadData(); 
            renderPage(); 
            buildNav(); 
        } catch (e) {
            console.error('Refresh error:', e);
            toast('error', 'Errore aggiornamento', 'Ricarica la pagina');
        }
    }

    function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
    function showAuth() { window.location.href = 'login.html'; }
    function showApp() { hideLoading(); document.getElementById('authScreen').classList.add('hidden'); document.getElementById('app').classList.add('active'); setupApp(); }
    function showAuthError(m) { const e = document.getElementById('authError'); e.textContent = m; e.classList.add('show'); document.getElementById('authInfo').classList.remove('show'); }
    function showAuthInfo(m) { const e = document.getElementById('authInfo'); e.textContent = m; e.classList.add('show'); document.getElementById('authError').classList.remove('show'); }

    document.getElementById('loginForm').addEventListener('submit', async e => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.disabled = true; btn.textContent = 'Accesso...';
        try {
            await auth.signInWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPassword').value);
        } catch (err) { showAuthError(authErr(err.code)); btn.disabled = false; btn.textContent = 'Accedi'; }
    });

    document.getElementById('setupForm').addEventListener('submit', async e => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.disabled = true; btn.textContent = 'Creazione...';
        try {
            const cred = await auth.createUserWithEmailAndPassword(document.getElementById('setupEmail').value, document.getElementById('setupPassword').value);
            await db.collection('users').doc(cred.user.uid).set({
                name: document.getElementById('setupName').value,
                email: document.getElementById('setupEmail').value,
                role: 'admin', phone: '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (err) { showAuthError(authErr(err.code)); btn.disabled = false; btn.textContent = 'Crea Account Admin'; }
    });

    async function logout() { 
        if (confirm('Vuoi uscire?')) { 
            stopSessionCheck();
            stopNotificationListener();
            try {
                await auth.signOut(); 
            } catch (e) {
                console.error('Logout error:', e);
            }
            window.location.href = 'login.html'; 
        } 
    }
    function authErr(c) { return { 'auth/user-not-found': 'Utente non trovato', 'auth/wrong-password': 'Password errata', 'auth/invalid-email': 'Email non valida', 'auth/email-already-in-use': 'Email giÃ  registrata', 'auth/weak-password': 'Password troppo debole', 'auth/invalid-credential': 'Credenziali non valide' }[c] || 'Errore: ' + c; }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // APP SETUP & NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setupApp() {
        const badge = document.getElementById('headerBadge');
        badge.textContent = roleLabel(S.profile.role);
        badge.className = `header-badge ${S.profile.role}`;
        document.getElementById('headerAvatar').textContent = initials(S.profile.name);
        document.getElementById('headerName').textContent = S.profile.name;
        document.getElementById('headerRole').textContent = roleLabel(S.profile.role);
        
        // Start notification listener
        startNotificationListener();
        
        // Check scheduled notifications (admin only, once per session)
        if (isAdmin() && !window.scheduledNotifChecked) {
            window.scheduledNotifChecked = true;
            setTimeout(() => checkScheduledNotifications(), 5000);
        }
        
        // Search bar for admin only
        if (isAdmin()) {
            document.getElementById('searchContainer').innerHTML = `
                <div class="search-box">
                    <span>ğŸ”</span>
                    <input type="text" placeholder="Cerca clienti, immobili, documenti..." onkeyup="handleSearch(this.value)" id="globalSearch">
                </div>`;
        }
        
        buildNav();
        goTo('dashboard');
    }

    function buildNav() {
        const sb = document.getElementById('sidebar');
        const r = S.profile.role;
        
        if (r === 'admin') {
            const activeClients = S.clients.filter(c => !['completed', 'lost'].includes(c.stage)).length;
            const pendingInv = S.invoices.filter(i => i.status === 'pending').length;
            const openMaint = S.maintenance.filter(m => m.status === 'open').length;
            const overduePayments = S.payments.filter(p => p.status === 'pending' && isOverdue(p.dueDate)).length;
            
            sb.innerHTML = `
                <div class="nav-section"><div class="nav-label">Panoramica</div>
                    <div class="nav-item ${S.page==='dashboard'?'active':''}" onclick="goTo('dashboard')"><span class="nav-icon">ğŸ“Š</span> Dashboard</div>
                </div>
                <div class="nav-section"><div class="nav-label">Business</div>
                    <div class="nav-item ${S.page==='crm'?'active':''}" onclick="goTo('crm')"><span class="nav-icon">ğŸ’¼</span> CRM ${activeClients?`<span class="nav-badge gold">${activeClients}</span>`:''}</div>
                    <div class="nav-item ${S.page==='invoices'?'active':''}" onclick="goTo('invoices')"><span class="nav-icon">ğŸ§¾</span> Fatture ${pendingInv?`<span class="nav-badge gold">${pendingInv}</span>`:''}</div>
                    <div class="nav-item ${S.page==='templates'?'active':''}" onclick="goTo('templates')"><span class="nav-icon">ğŸ“œ</span> Template</div>
                </div>
                <div class="nav-section"><div class="nav-label">Gestione</div>
                    <div class="nav-item ${S.page==='users'?'active':''}" onclick="goTo('users')"><span class="nav-icon">ğŸ‘¥</span> Utenti</div>
                    <div class="nav-item ${S.page==='properties'?'active':''}" onclick="goTo('properties')"><span class="nav-icon">ğŸ </span> Immobili</div>
                    <div class="nav-item ${S.page==='contracts'?'active':''}" onclick="goTo('contracts')"><span class="nav-icon">ğŸ“‹</span> Contratti</div>
                    <div class="nav-item ${S.page==='payments'?'active':''}" onclick="goTo('payments')"><span class="nav-icon">ğŸ’³</span> Pagamenti ${overduePayments?`<span class="nav-badge">${overduePayments}</span>`:''}</div>
                    <div class="nav-item ${S.page==='maintenance'?'active':''}" onclick="goTo('maintenance')"><span class="nav-icon">ğŸ”§</span> Manutenzione ${openMaint?`<span class="nav-badge">${openMaint}</span>`:''}</div>
                    <div class="nav-item ${S.page==='documents'?'active':''}" onclick="goTo('documents')"><span class="nav-icon">ğŸ“</span> Documenti</div>
                </div>
                <div class="nav-section"><div class="nav-label">Admin Tools</div>
                    <div class="nav-item ${S.page==='adminflats'?'active':''}" onclick="goTo('adminflats')"><span class="nav-icon">ğŸ¢</span> AdminFlats</div>
                </div>
                <div class="sidebar-footer">
                    <div class="nav-item" onclick="goTo('settings')"><span class="nav-icon">âš™ï¸</span> Impostazioni</div>
                    <div class="nav-item" onclick="logout()"><span class="nav-icon">ğŸšª</span> Esci</div>
                </div>`;
        } else if (r === 'landlord') {
            const myMaint = getMyMaintenance().filter(m => m.status === 'open').length;
            const myOverdue = getMyPayments().filter(p => p.status === 'pending' && isOverdue(p.dueDate)).length;
            sb.innerHTML = `
                <div class="nav-section"><div class="nav-label">Home</div>
                    <div class="nav-item ${S.page==='dashboard'?'active':''}" onclick="goTo('dashboard')"><span class="nav-icon">ğŸ“Š</span> Dashboard</div>
                </div>
                <div class="nav-section"><div class="nav-label">I Miei Immobili</div>
                    <div class="nav-item ${S.page==='my-properties'?'active':''}" onclick="goTo('my-properties')"><span class="nav-icon">ğŸ </span> Immobili</div>
                    <div class="nav-item ${S.page==='my-contracts'?'active':''}" onclick="goTo('my-contracts')"><span class="nav-icon">ğŸ“‹</span> Contratti</div>
                    <div class="nav-item ${S.page==='my-payments'?'active':''}" onclick="goTo('my-payments')"><span class="nav-icon">ğŸ’³</span> Pagamenti ${myOverdue?`<span class="nav-badge">${myOverdue}</span>`:''}</div>
                    <div class="nav-item ${S.page==='my-maintenance'?'active':''}" onclick="goTo('my-maintenance')"><span class="nav-icon">ğŸ”§</span> Manutenzione ${myMaint?`<span class="nav-badge">${myMaint}</span>`:''}</div>
                    <div class="nav-item ${S.page==='my-documents'?'active':''}" onclick="goTo('my-documents')"><span class="nav-icon">ğŸ“</span> Documenti</div>
                </div>
                <div class="sidebar-footer">
                    <div class="nav-item" onclick="goTo('settings')"><span class="nav-icon">âš™ï¸</span> Impostazioni</div>
                    <div class="nav-item" onclick="logout()"><span class="nav-icon">ğŸšª</span> Esci</div>
                </div>`;
        } else { // tenant
            const myMaint = getMyMaintenance().filter(m => m.status !== 'resolved').length;
            const myOverdue = getMyPayments().filter(p => p.status === 'pending' && isOverdue(p.dueDate)).length;
            sb.innerHTML = `
                <div class="nav-section"><div class="nav-label">Home</div>
                    <div class="nav-item ${S.page==='dashboard'?'active':''}" onclick="goTo('dashboard')"><span class="nav-icon">ğŸ </span> Dashboard</div>
                </div>
                <div class="nav-section"><div class="nav-label">Il Mio Alloggio</div>
                    <div class="nav-item ${S.page==='my-contract'?'active':''}" onclick="goTo('my-contract')"><span class="nav-icon">ğŸ“‹</span> Contratto</div>
                    <div class="nav-item ${S.page==='my-payments'?'active':''}" onclick="goTo('my-payments')"><span class="nav-icon">ğŸ’³</span> Pagamenti ${myOverdue?`<span class="nav-badge">${myOverdue}</span>`:''}</div>
                    <div class="nav-item ${S.page==='my-maintenance'?'active':''}" onclick="goTo('my-maintenance')"><span class="nav-icon">ğŸ”§</span> Manutenzione ${myMaint?`<span class="nav-badge">${myMaint}</span>`:''}</div>
                    <div class="nav-item ${S.page==='my-documents'?'active':''}" onclick="goTo('my-documents')"><span class="nav-icon">ğŸ“</span> Documenti</div>
                </div>
                <div class="sidebar-footer">
                    <div class="nav-item" onclick="goTo('settings')"><span class="nav-icon">âš™ï¸</span> Impostazioni</div>
                    <div class="nav-item" onclick="logout()"><span class="nav-icon">ğŸšª</span> Esci</div>
                </div>`;
        }
    }

    function goTo(p) { S.page = p; buildNav(); renderPage(); closeSidebar(); window.scrollTo(0, 0); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('open'); }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('open'); }

    function renderPage() {
        const m = document.getElementById('main');
        const r = S.profile.role;
        switch(S.page) {
            case 'dashboard': m.innerHTML = r === 'admin' ? adminDashboard() : r === 'landlord' ? landlordDashboard() : tenantDashboard(); break;
            case 'crm': m.innerHTML = isAdmin() ? crmPage() : accessDenied(); break;
            case 'invoices': m.innerHTML = isAdmin() ? invoicesPage() : accessDenied(); break;
            case 'templates': m.innerHTML = isAdmin() ? templatesPage() : accessDenied(); break;
            case 'users': m.innerHTML = isAdmin() ? usersPage() : accessDenied(); break;
            case 'properties': m.innerHTML = isAdmin() ? propertiesPage() : accessDenied(); break;
            case 'contracts': m.innerHTML = isAdmin() ? contractsPage() : accessDenied(); break;
            case 'payments': m.innerHTML = isAdmin() ? paymentsPage() : accessDenied(); break;
            case 'maintenance': m.innerHTML = isAdmin() ? maintenancePage() : accessDenied(); break;
            case 'documents': m.innerHTML = isAdmin() ? documentsPage() : accessDenied(); break;
            case 'my-properties': m.innerHTML = isLandlord() ? myPropertiesPage() : accessDenied(); break;
            case 'my-contracts': m.innerHTML = isLandlord() ? myContractsPage() : accessDenied(); break;
            case 'my-contract': m.innerHTML = isTenant() ? tenantContractPage() : accessDenied(); break;
            case 'my-payments': m.innerHTML = (isLandlord() || isTenant()) ? myPaymentsPage() : accessDenied(); break;
            case 'my-maintenance': m.innerHTML = (isLandlord() || isTenant()) ? myMaintenancePage() : accessDenied(); break;
            case 'my-documents': m.innerHTML = (isLandlord() || isTenant()) ? myDocumentsPage() : accessDenied(); break;
            case 'settings': m.innerHTML = settingsPage(); break;
            case 'adminflats': m.innerHTML = isAdmin() ? adminflatsPage() : accessDenied(); break;
            default: m.innerHTML = r === 'admin' ? adminDashboard() : r === 'landlord' ? landlordDashboard() : tenantDashboard();
        }
    }

    function accessDenied() {
        return `<div class="empty-state" style="padding:80px 24px"><div class="empty-icon">ğŸš«</div><h2 class="empty-title">Accesso Negato</h2><p class="empty-text">Non hai i permessi per questa sezione.</p><button class="btn" onclick="goTo('dashboard')">Torna alla Dashboard</button></div>`;
    }

    function handleSearch(q) {
        if (!q || q.length < 2) return;
        // Quick search implementation
        const results = [];
        S.clients.filter(c => c.name.toLowerCase().includes(q.toLowerCase()) || c.email?.toLowerCase().includes(q.toLowerCase())).forEach(c => results.push({ type: 'client', item: c }));
        S.properties.filter(p => p.name.toLowerCase().includes(q.toLowerCase())).forEach(p => results.push({ type: 'property', item: p }));
        if (results.length > 0) {
            // Show first result
            const r = results[0];
            if (r.type === 'client') viewClient(r.item.id);
            else if (r.type === 'property') viewProperty(r.item.id);
            document.getElementById('globalSearch').value = '';
        }
    }

    function showNotifications() {
        if (S.notifications.length === 0) {
            toast('info', 'Nessuna notifica');
            return;
        }
        openModal('notifications');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DASHBOARDS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function adminDashboard() {
        const activeClients = S.clients.filter(c => !['completed', 'lost'].includes(c.stage));
        const paidInvoices = S.invoices.filter(i => i.status === 'paid');
        const thisMonthRev = paidInvoices.filter(i => isThisMonth(i.paidDate)).reduce((s, i) => s + (i.amount || 0), 0);
        const pipeline = activeClients.reduce((s, c) => s + (SERVICES[c.service]?.price || 0), 0);
        const pendingInv = S.invoices.filter(i => i.status === 'pending').reduce((s, i) => s + (i.amount || 0), 0);
        const openMaint = S.maintenance.filter(m => m.status === 'open').length;
        const overduePayments = S.payments.filter(p => p.status === 'pending' && isOverdue(p.dueDate));

        let alerts = '';
        if (overduePayments.length > 0) {
            alerts += `<div class="alert danger"><span class="alert-icon">âš ï¸</span><div class="alert-content"><div class="alert-title">${overduePayments.length} Pagamenti in Ritardo</div><div class="alert-text">Ci sono affitti non pagati che richiedono attenzione.</div></div><button class="btn btn-sm btn-danger" onclick="goTo('payments')">Gestisci</button></div>`;
        }

        return `
            <div class="welcome-card"><h1 class="welcome-title">ğŸ‘‘ Ciao ${S.profile.name.split(' ')[0]}</h1><p class="welcome-text">Pannello Amministratore Â· ${new Date().toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}</p></div>
            ${alerts}
            <div class="stats-grid">
                <div class="stat-card gold" onclick="goTo('invoices')"><div class="stat-icon">ğŸ’°</div><div class="stat-value">â‚¬${thisMonthRev.toLocaleString('it-IT')}</div><div class="stat-label">Fatturato Mese</div></div>
                <div class="stat-card blue" onclick="goTo('crm')"><div class="stat-icon">ğŸ“ˆ</div><div class="stat-value">â‚¬${pipeline.toLocaleString('it-IT')}</div><div class="stat-label">Pipeline (${activeClients.length})</div></div>
                <div class="stat-card orange" onclick="goTo('invoices')"><div class="stat-icon">â³</div><div class="stat-value">â‚¬${pendingInv.toLocaleString('it-IT')}</div><div class="stat-label">Da Incassare</div></div>
                <div class="stat-card ${openMaint > 0 ? 'red' : 'green'}" onclick="goTo('maintenance')"><div class="stat-icon">${openMaint > 0 ? 'âš ï¸' : 'âœ“'}</div><div class="stat-value">${openMaint}</div><div class="stat-label">Manutenzioni</div></div>
            </div>
            <div class="grid-2">
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸ’¼ Clienti CRM</h3><button class="btn btn-sm" onclick="goTo('crm')">Vedi</button></div><div class="card-body flush">
                    ${activeClients.slice(0, 4).map(c => `<div class="list-item clickable" onclick="viewClient('${c.id}')"><div class="avatar ${c.service === 'DAS' ? 'blue' : c.service === 'VV' ? 'purple' : ''}">${initials(c.name)}</div><div class="list-content"><div class="list-title">${c.name}</div><div class="list-subtitle">${stageLabel(c.stage)}</div></div><span class="badge ${SERVICES[c.service]?.color}">${c.service}</span></div>`).join('') || '<div class="empty-state" style="padding:30px"><div class="empty-text">Nessun cliente</div></div>'}
                </div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸš€ Azioni Rapide</h3></div><div class="card-body">
                    <div style="display:flex;gap:8px;margin-bottom:12px;justify-content:center">
                        <div class="lang-selector">
                            <button class="lang-btn ${S.lang === 'IT' ? 'active' : ''}" onclick="setLang('IT')">ğŸ‡®ğŸ‡¹ IT</button>
                            <button class="lang-btn ${S.lang === 'EN' ? 'active' : ''}" onclick="setLang('EN')">ğŸ‡¬ğŸ‡§ EN</button>
                        </div>
                    </div>
                    <div style="display:grid;gap:8px">
                        <button class="btn btn-block" onclick="openModal('addClient')">ğŸ’¼ Nuovo Cliente CRM</button>
                        <button class="btn btn-secondary btn-block" onclick="openModal('addInvoice')">ğŸ§¾ Crea Fattura</button>
                        <button class="btn btn-secondary btn-block" onclick="goTo('templates')">ğŸ“œ Template</button>
                        <button class="btn btn-secondary btn-block" onclick="goTo('adminflats')">ğŸ¢ AdminFlats</button>
                    </div>
                </div></div>
            </div>`;
    }

    function landlordDashboard() {
        const myProps = getMyProperties();
        const myContracts = getMyContracts();
        const activeContracts = myContracts.filter(c => c.status === 'active');
        const myPayments = getMyPayments();
        const paidThisMonth = myPayments.filter(p => p.status === 'paid' && isThisMonth(p.paidDate)).reduce((s, p) => s + (p.amount || 0), 0);
        const pendingPayments = myPayments.filter(p => p.status === 'pending');
        const overduePayments = pendingPayments.filter(p => isOverdue(p.dueDate));
        const myMaint = getMyMaintenance().filter(m => m.status === 'open');
        const occupancy = myProps.length > 0 ? Math.round((activeContracts.length / myProps.length) * 100) : 0;
        const expiringContracts = activeContracts.filter(c => { const d = daysUntil(c.endDate); return d !== null && d <= 60 && d >= 0; });

        let alerts = '';
        if (overduePayments.length > 0) {
            alerts += `<div class="alert danger"><span class="alert-icon">âš ï¸</span><div class="alert-content"><div class="alert-title">${overduePayments.length} Pagamenti in Ritardo</div><div class="alert-text">Alcuni inquilini non hanno pagato l'affitto.</div></div></div>`;
        }
        if (expiringContracts.length > 0) {
            alerts += `<div class="alert warning"><span class="alert-icon">ğŸ“‹</span><div class="alert-content"><div class="alert-title">${expiringContracts.length} Contratti in Scadenza</div><div class="alert-text">Contratti che scadono nei prossimi 60 giorni.</div></div></div>`;
        }

        return `
            <div class="welcome-card"><h1 class="welcome-title">ğŸ  Ciao ${S.profile.name.split(' ')[0]}</h1><p class="welcome-text">Area Proprietario Â· ${new Date().toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}</p></div>
            ${alerts}
            <div class="stats-grid">
                <div class="stat-card gold" onclick="goTo('my-properties')"><div class="stat-icon">ğŸ </div><div class="stat-value">${myProps.length}</div><div class="stat-label">Immobili</div></div>
                <div class="stat-card green"><div class="stat-icon">ğŸ“Š</div><div class="stat-value">${occupancy}%</div><div class="stat-label">Occupazione</div></div>
                <div class="stat-card blue" onclick="goTo('my-payments')"><div class="stat-icon">ğŸ’°</div><div class="stat-value">â‚¬${paidThisMonth.toLocaleString('it-IT')}</div><div class="stat-label">Incassi Mese</div></div>
                <div class="stat-card ${myMaint.length > 0 ? 'orange' : 'green'}" onclick="goTo('my-maintenance')"><div class="stat-icon">${myMaint.length > 0 ? 'ğŸ”§' : 'âœ“'}</div><div class="stat-value">${myMaint.length}</div><div class="stat-label">Manutenzioni</div></div>
            </div>
            <div class="grid-2">
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸ  I Miei Immobili</h3><button class="btn btn-sm" onclick="goTo('my-properties')">Vedi</button></div><div class="card-body flush">
                    ${myProps.slice(0, 4).map(p => {
                        const contract = myContracts.find(c => c.propertyId === p.id && c.status === 'active');
                        const tenant = contract ? S.users.find(u => u.id === contract.tenantId) : null;
                        return `<div class="list-item" onclick="viewPropertyLandlord('${p.id}')"><div class="list-icon">ğŸ </div><div class="list-content"><div class="list-title">${p.name}</div><div class="list-subtitle">${contract ? tenant?.name || 'Affittato' : 'Libero'}</div></div><span class="badge ${contract ? 'green' : 'gray'}">${contract ? 'â‚¬' + contract.rent : 'Libero'}</span></div>`;
                    }).join('') || '<div class="empty-state" style="padding:30px"><div class="empty-text">Nessun immobile</div></div>'}
                </div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸ’³ Pagamenti in Attesa</h3></div><div class="card-body flush">
                    ${pendingPayments.slice(0, 4).map(p => {
                        const c = myContracts.find(x => x.id === p.contractId);
                        const prop = c ? myProps.find(x => x.id === c.propertyId) : null;
                        const overdue = isOverdue(p.dueDate);
                        return `<div class="list-item"><div class="list-icon" style="background:${overdue ? 'var(--red-light)' : 'var(--orange-light)'}">${overdue ? 'âš ï¸' : 'â³'}</div><div class="list-content"><div class="list-title">${prop?.name || ''}</div><div class="list-subtitle">${p.month || ''} Â· Scade ${fmtDate(p.dueDate)}</div></div><div class="list-value ${overdue ? 'text-red' : 'text-gold'}">â‚¬${p.amount || 0}</div></div>`;
                    }).join('') || '<div class="empty-state" style="padding:30px"><div class="empty-icon">âœ“</div><div class="empty-text">Nessun pagamento in attesa</div></div>'}
                </div></div>
            </div>`;
    }

    function tenantDashboard() {
        const myContract = getMyContracts().find(c => c.status === 'active');
        const myProp = myContract ? S.properties.find(p => p.id === myContract.propertyId) : null;
        const myPayments = getMyPayments();
        const nextPayment = myPayments.filter(p => p.status === 'pending').sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))[0];
        const paidCount = myPayments.filter(p => p.status === 'paid').length;
        const myMaint = getMyMaintenance();
        const openMaint = myMaint.filter(m => m.status !== 'resolved').length;
        const landlord = getMyLandlord();
        const admin = getAdmin();

        // Calcoli per alert e countdown
        const contractDays = myContract ? daysUntil(myContract.endDate) : null;
        const paymentDays = nextPayment ? daysUntil(nextPayment.dueDate) : null;
        const paymentOverdue = nextPayment && isOverdue(nextPayment.dueDate);

        let alerts = '';
        if (paymentOverdue) {
            alerts += `<div class="alert danger"><span class="alert-icon">âš ï¸</span><div class="alert-content"><div class="alert-title">Pagamento in Ritardo!</div><div class="alert-text">L'affitto di â‚¬${nextPayment.amount} era dovuto il ${fmtDate(nextPayment.dueDate)}. Contatta il proprietario.</div></div></div>`;
        } else if (paymentDays !== null && paymentDays <= 5 && paymentDays >= 0) {
            alerts += `<div class="alert warning"><span class="alert-icon">â°</span><div class="alert-content"><div class="alert-title">Pagamento in Scadenza</div><div class="alert-text">L'affitto di â‚¬${nextPayment.amount} scade ${paymentDays === 0 ? 'oggi' : paymentDays === 1 ? 'domani' : 'tra ' + paymentDays + ' giorni'}.</div></div></div>`;
        }
        if (contractDays !== null && contractDays <= 60 && contractDays >= 0) {
            alerts += `<div class="alert warning"><span class="alert-icon">ğŸ“‹</span><div class="alert-content"><div class="alert-title">Contratto in Scadenza</div><div class="alert-text">Il tuo contratto scade tra ${contractDays} giorni (${fmtDate(myContract.endDate)}). Contatta il proprietario per il rinnovo.</div></div></div>`;
        }

        if (!myContract) {
            return `<div class="welcome-card"><h1 class="welcome-title">ğŸ”‘ Ciao ${S.profile.name.split(' ')[0]}</h1><p class="welcome-text">Area Inquilino</p></div>
                <div class="card"><div class="card-body"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">Nessun contratto attivo</div><div class="empty-text">Non hai ancora un contratto di locazione attivo. Contatta l'amministratore.</div></div></div></div>`;
        }

        return `
            <div class="welcome-card"><h1 class="welcome-title">ğŸ”‘ Ciao ${S.profile.name.split(' ')[0]}</h1><p class="welcome-text">Area Inquilino Â· ${new Date().toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}</p></div>
            ${alerts}
            <div class="stats-grid" style="grid-template-columns:repeat(4,1fr)">
                <div class="stat-card blue"><div class="stat-icon">ğŸ </div><div class="stat-value" style="font-size:18px">${myProp?.name || 'Casa'}</div><div class="stat-label">Il Mio Alloggio</div></div>
                <div class="stat-card gold"><div class="stat-icon">ğŸ’°</div><div class="stat-value">â‚¬${myContract.rent}</div><div class="stat-label">Affitto Mensile</div></div>
                <div class="stat-card ${paymentOverdue ? 'red' : nextPayment ? 'orange' : 'green'}">
                    <div class="stat-icon">${paymentOverdue ? 'âš ï¸' : nextPayment ? 'â³' : 'âœ“'}</div>
                    <div class="stat-value">${nextPayment ? 'â‚¬' + nextPayment.amount : 'OK'}</div>
                    <div class="stat-label">${paymentOverdue ? 'IN RITARDO' : nextPayment ? 'Prossimo: ' + fmtDate(nextPayment.dueDate) : 'Tutto Pagato'}</div>
                </div>
                <div class="stat-card purple"><div class="stat-icon">ğŸ”’</div><div class="stat-value">â‚¬${myContract.deposit || 0}</div><div class="stat-label">Deposito Versato</div></div>
            </div>
            <div class="grid-2">
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸ“‹ Il Mio Contratto</h3><button class="btn btn-sm" onclick="downloadMyContractPDF()">ğŸ“¥ Scarica</button></div><div class="card-body">
                    <div class="detail-grid">
                        <div><div class="detail-label">Immobile</div><div class="detail-value">${myProp?.name}</div></div>
                        <div><div class="detail-label">Indirizzo</div><div class="detail-value">${myProp?.address || 'Roma'}</div></div>
                        <div><div class="detail-label">Affitto</div><div class="detail-value text-gold">â‚¬${myContract.rent}/mese</div></div>
                        <div><div class="detail-label">Deposito</div><div class="detail-value">â‚¬${myContract.deposit || 0}</div></div>
                        <div><div class="detail-label">Data Inizio</div><div class="detail-value">${fmtDate(myContract.startDate)}</div></div>
                        <div><div class="detail-label">Data Fine</div><div class="detail-value">${fmtDate(myContract.endDate)}</div></div>
                    </div>
                    <div style="margin-top:16px;display:flex;align-items:center;gap:10px">
                        <span class="detail-label" style="margin:0">Tempo Rimanente:</span>
                        <span class="countdown ${getCountdownClass(contractDays)}">${contractDays !== null ? (contractDays > 0 ? contractDays + ' giorni' : 'Scaduto') : 'N/A'}</span>
                    </div>
                </div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸ“ Contatti</h3></div><div class="card-body">
                    ${landlord ? `
                        <div class="contact-card mb-16">
                            <div class="avatar">${initials(landlord.name)}</div>
                            <div class="contact-info">
                                <div class="contact-name">${landlord.name}</div>
                                <div class="contact-role">Proprietario</div>
                                <div class="contact-details">${landlord.email}${landlord.phone ? '<br>' + landlord.phone : ''}</div>
                            </div>
                            <div class="contact-actions">
                                <a href="mailto:${landlord.email}" class="btn btn-sm btn-secondary">ğŸ“§</a>
                                ${landlord.phone ? `<a href="tel:${landlord.phone}" class="btn btn-sm btn-secondary">ğŸ“</a>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    ${admin && admin.id !== landlord?.id ? `
                        <div class="contact-card">
                            <div class="avatar purple">${initials(admin.name)}</div>
                            <div class="contact-info">
                                <div class="contact-name">${admin.name}</div>
                                <div class="contact-role">Amministratore BOOM</div>
                                <div class="contact-details">${COMPANY.email}<br>${COMPANY.phone}</div>
                            </div>
                            <div class="contact-actions">
                                <a href="mailto:${COMPANY.email}" class="btn btn-sm btn-secondary">ğŸ“§</a>
                                <a href="tel:${COMPANY.phone}" class="btn btn-sm btn-secondary">ğŸ“</a>
                            </div>
                        </div>
                    ` : ''}
                </div></div>
            </div>
            <div class="grid-2">
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸ’³ Pagamenti Recenti</h3><button class="btn btn-sm" onclick="goTo('my-payments')">Vedi Tutti</button></div><div class="card-body flush">
                    ${myPayments.slice(0, 4).map(p => `
                        <div class="list-item">
                            <div class="list-icon" style="background:${p.status === 'paid' ? 'var(--green-light)' : isOverdue(p.dueDate) ? 'var(--red-light)' : 'var(--orange-light)'}">${p.status === 'paid' ? 'âœ“' : isOverdue(p.dueDate) ? 'âš ï¸' : 'â³'}</div>
                            <div class="list-content">
                                <div class="list-title">${p.month || 'Pagamento'}</div>
                                <div class="list-subtitle">${p.status === 'paid' ? 'Pagato ' + fmtDate(p.paidDate) : 'Scadenza ' + fmtDate(p.dueDate)}</div>
                            </div>
                            <div class="list-value ${p.status === 'paid' ? 'text-green' : isOverdue(p.dueDate) ? 'text-red' : 'text-gold'}">â‚¬${p.amount || 0}</div>
                        </div>
                    `).join('') || '<div class="empty-state" style="padding:30px"><div class="empty-text">Nessun pagamento</div></div>'}
                </div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">âš¡ Azioni</h3></div><div class="card-body">
                    <div style="display:grid;gap:8px">
                        <button class="btn btn-secondary btn-block" onclick="goTo('my-payments')">ğŸ’³ I Miei Pagamenti</button>
                        <button class="btn btn-secondary btn-block" onclick="openModal('addTenantMaintenance')">ğŸ”§ Richiedi Manutenzione</button>
                        <button class="btn btn-secondary btn-block" onclick="goTo('my-documents')">ğŸ“ I Miei Documenti</button>
                        <button class="btn btn-secondary btn-block" onclick="downloadMyContractPDF()">ğŸ“¥ Scarica Contratto</button>
                    </div>
                    <div class="info-box">
                        <div class="info-box-title">ğŸ’³ Come Pagare</div>
                        <div class="info-box-row"><span class="info-box-label">Intestatario</span><span class="info-box-value">${COMPANY.legal}</span></div>
                        <div class="info-box-row"><span class="info-box-label">IBAN</span><span class="info-box-value" style="font-size:11px">${COMPANY.iban}</span></div>
                        <div class="info-box-row"><span class="info-box-label">Causale</span><span class="info-box-value">Affitto ${myProp?.name || ''}</span></div>
                    </div>
                </div></div>
            </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADMIN PAGES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function crmPage() {
        const clients = S.clients || [];
        const active = clients.filter(c => !['completed', 'lost'].includes(c.stage));
        const pipeline = active.reduce((s, c) => s + (SERVICES[c.service]?.price || 0), 0);
        const pfs = clients.filter(c => c.service === 'PFS');
        const das = clients.filter(c => c.service === 'DAS');
        const vv = clients.filter(c => c.service === 'VV');
        const completed = clients.filter(c => c.stage === 'completed' || c.stage === 'paid');
        
        return `
            <div class="page-header">
                <div><h1 class="page-title">ğŸ’¼ CRM Clienti</h1><p class="page-subtitle">${active.length} attivi Â· â‚¬${pipeline.toLocaleString('it-IT')} pipeline</p></div>
                <div class="page-actions">
                    <button class="btn btn-secondary" onclick="goTo('templates')">ğŸ“œ Template</button>
                    <button class="btn" onclick="openModal('addClient')">+ Nuovo Cliente</button>
                </div>
            </div>
            
            <!-- Stats Row -->
            <div class="stats-grid" style="grid-template-columns:repeat(5,1fr);margin-bottom:20px">
                <div class="stat-card"><div class="stat-value">${clients.length}</div><div class="stat-label">Totali</div></div>
                <div class="stat-card gold"><div class="stat-value">${pfs.length}</div><div class="stat-label">ğŸ  PFS</div></div>
                <div class="stat-card blue"><div class="stat-value">${das.length}</div><div class="stat-label">ğŸ“‹ DAS</div></div>
                <div class="stat-card purple"><div class="stat-value">${vv.length}</div><div class="stat-label">ğŸ¥ VV</div></div>
                <div class="stat-card green"><div class="stat-value">â‚¬${completed.reduce((s,c) => s + (SERVICES[c.service]?.price || 0), 0).toLocaleString('it-IT')}</div><div class="stat-label">âœ“ Chiusi</div></div>
            </div>
            
            <!-- Tabs -->
            <div class="card" style="margin-bottom:20px">
                <div style="display:flex;gap:8px;padding:12px;border-bottom:1px solid var(--border);flex-wrap:wrap">
                    <button class="btn btn-sm" onclick="filterCRM('all',this)">Tutti (${clients.length})</button>
                    <button class="btn btn-sm btn-secondary" onclick="filterCRM('PFS',this)">ğŸ  PFS (${pfs.length})</button>
                    <button class="btn btn-sm btn-secondary" onclick="filterCRM('DAS',this)">ğŸ“‹ DAS (${das.length})</button>
                    <button class="btn btn-sm btn-secondary" onclick="filterCRM('VV',this)">ğŸ¥ VV (${vv.length})</button>
                    <div style="flex:1"></div>
                    <input type="text" class="form-input" placeholder="ğŸ” Cerca..." style="width:200px;padding:6px 12px" oninput="searchCRM(this.value)">
                </div>
                
                <!-- Client Table -->
                <div style="overflow-x:auto">
                    <table class="crm-table" id="crmTable">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Contatto</th>
                                <th>Servizio</th>
                                <th>Budget</th>
                                <th>Zona</th>
                                <th>Stage</th>
                                <th>Data</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clients.map(c => `
                                <tr class="crm-row" data-service="${c.service}" data-search="${(c.name + ' ' + c.email + ' ' + (c.zone || '')).toLowerCase()}">
                                    <td>
                                        <div style="display:flex;align-items:center;gap:10px">
                                            <div class="avatar sm ${c.service === 'DAS' ? 'blue' : c.service === 'VV' ? 'purple' : ''}">${initials(c.name)}</div>
                                            <div style="font-weight:600">${c.name}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-size:12px">
                                            <div><a href="mailto:${c.email}" style="color:var(--text-muted)">ğŸ“§ ${c.email}</a></div>
                                            ${c.phone ? `<div><a href="tel:${c.phone}" style="color:var(--text-muted)">ğŸ“ ${c.phone}</a></div>` : ''}
                                        </div>
                                    </td>
                                    <td><span class="badge ${SERVICES[c.service]?.color}">${c.service} â‚¬${SERVICES[c.service]?.price}</span></td>
                                    <td>${c.budget ? 'â‚¬' + c.budget + '/m' : 'â€”'}</td>
                                    <td>${c.zone || 'â€”'}</td>
                                    <td><span class="badge ${stageColor(c.stage)}">${stageLabel(c.stage)}</span></td>
                                    <td style="font-size:12px;color:var(--text-muted)">${fmtDate(c.createdAt)}</td>
                                    <td>
                                        <div style="display:flex;gap:4px">
                                            <button class="btn btn-xs btn-secondary" onclick="viewClient('${c.id}')" title="Dettagli">ğŸ‘</button>
                                            <button class="btn btn-xs btn-secondary" onclick="editClientModal('${c.id}')" title="Modifica">âœï¸</button>
                                            <button class="btn btn-xs btn-secondary" onclick="openTemplateForClient('${c.id}')" title="Documento">ğŸ“œ</button>
                                            <button class="btn btn-xs btn-secondary" onclick="createInvoiceFor('${c.id}')" title="Fattura">ğŸ§¾</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted)">Nessun cliente. Clicca + Nuovo Cliente per iniziare.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pipeline Kanban (collapsible) -->
            <div class="card">
                <div class="card-header" style="cursor:pointer" onclick="togglePipeline()">
                    <h3 class="card-title">ğŸ“Š Pipeline Kanban</h3>
                    <span id="pipelineToggle">â–¼</span>
                </div>
                <div id="pipelineView" class="card-body" style="display:none;padding:0">
                    <div class="pipeline">${PIPELINE_STAGES.filter(s => s.id !== 'lost').map(stage => {
                        const stageClients = clients.filter(c => c.stage === stage.id);
                        return `<div class="pipeline-col"><div class="pipeline-header"><span class="pipeline-title">${stage.icon} ${stage.name}</span><span class="pipeline-count">${stageClients.length}</span></div><div class="pipeline-cards">${stageClients.map(c => `<div class="pipeline-card" onclick="viewClient('${c.id}')"><span class="pipeline-card-service ${c.service.toLowerCase()}">${c.service}</span><div class="pipeline-card-name">${c.name}</div><div class="pipeline-card-meta">â‚¬${c.budget || '?'}/m Â· ${c.zone || 'Roma'}</div></div>`).join('') || '<div class="text-muted text-center" style="padding:16px;font-size:11px">â€”</div>'}</div></div>`;
                    }).join('')}</div>
                </div>
            </div>`;
    }
    
    function filterCRM(service, btn) {
        document.querySelectorAll('.card button.btn-sm').forEach(b => b.classList.remove('btn-secondary'));
        document.querySelectorAll('.card button.btn-sm').forEach(b => b.classList.add('btn-secondary'));
        btn.classList.remove('btn-secondary');
        document.querySelectorAll('.crm-row').forEach(row => {
            row.style.display = (service === 'all' || row.dataset.service === service) ? '' : 'none';
        });
    }
    
    function searchCRM(q) {
        const query = q.toLowerCase();
        document.querySelectorAll('.crm-row').forEach(row => {
            row.style.display = row.dataset.search.includes(query) ? '' : 'none';
        });
    }
    
    function togglePipeline() {
        const view = document.getElementById('pipelineView');
        const toggle = document.getElementById('pipelineToggle');
        if (view.style.display === 'none') { view.style.display = 'block'; toggle.textContent = 'â–²'; }
        else { view.style.display = 'none'; toggle.textContent = 'â–¼'; }
    }
    
    function stageColor(s) {
        return { lead: 'gray', contacted: 'blue', qualified: 'green', searching: 'purple', found: 'orange', closing: 'gold', paid: 'green', completed: 'green', lost: 'red' }[s] || 'gray';
    }
    
    function editClientModal(id) {
        const c = S.clients.find(x => x.id === id); if (!c) return;
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal lg">
            <div class="modal-header"><h3 class="modal-title">âœï¸ Modifica ${c.name}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body"><form id="editClientForm" onsubmit="updateClient(event,'${id}')">
                <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="name" value="${c.name}" required></div><div class="form-group"><label class="form-label">Email *</label><input type="email" class="form-input" name="email" value="${c.email}" required></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Telefono</label><input type="tel" class="form-input" name="phone" value="${c.phone || ''}"></div><div class="form-group"><label class="form-label">Servizio</label><select class="form-select" name="service"><option value="PFS" ${c.service==='PFS'?'selected':''}>ğŸ  PFS â‚¬350</option><option value="DAS" ${c.service==='DAS'?'selected':''}>ğŸ“‹ DAS â‚¬249</option><option value="VV" ${c.service==='VV'?'selected':''}>ğŸ¥ VV â‚¬89</option></select></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Budget â‚¬/mese</label><input type="number" class="form-input" name="budget" value="${c.budget || ''}"></div><div class="form-group"><label class="form-label">Zona</label><input type="text" class="form-input" name="zone" value="${c.zone || ''}"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Data Arrivo</label><input type="date" class="form-input" name="arrivalDate" value="${c.arrivalDate || ''}"></div><div class="form-group"><label class="form-label">Durata</label><input type="text" class="form-input" name="duration" value="${c.duration || ''}" placeholder="es. 12 mesi"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Stage</label><select class="form-select" name="stage">${PIPELINE_STAGES.map(s => `<option value="${s.id}" ${c.stage===s.id?'selected':''}>${s.icon} ${s.name}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Source</label><select class="form-select" name="source"><option value="website" ${c.source==='website'?'selected':''}>Website</option><option value="referral" ${c.source==='referral'?'selected':''}>Referral</option><option value="social" ${c.source==='social'?'selected':''}>Social</option><option value="google" ${c.source==='google'?'selected':''}>Google</option><option value="other" ${c.source==='other'?'selected':''}>Altro</option></select></div></div>
                <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes">${c.notes || ''}</textarea></div>
            </form></div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="deleteClient('${id}')">ğŸ—‘ Elimina</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annulla</button>
                <button class="btn" onclick="document.getElementById('editClientForm').requestSubmit()">ğŸ’¾ Salva</button>
            </div>
        </div></div>`;
    }
    
    async function updateClient(e, id) {
        e.preventDefault();
        const d = Object.fromEntries(new FormData(e.target));
        try {
            await db.collection('clients').doc(id).update({
                name: d.name, email: d.email, phone: d.phone || '', service: d.service,
                budget: parseInt(d.budget) || 0, zone: d.zone || '', arrivalDate: d.arrivalDate || null,
                duration: d.duration || '', source: d.source || 'other', stage: d.stage, notes: d.notes || ''
            });
            closeModal(); await refresh(); toast('success', 'Cliente aggiornato!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }
    
    async function deleteClient(id) {
        if (!confirm('Eliminare questo cliente?')) return;
        try { await db.collection('clients').doc(id).delete(); closeModal(); await refresh(); toast('success', 'Eliminato'); }
        catch (err) { toast('error', 'Errore', err.message); }
    }
    
    function createInvoiceFor(id) {
        const c = S.clients.find(x => x.id === id); if (!c) return;
        const num = 'BOOM-' + new Date().getFullYear() + '-' + String((S.invoices?.length || 0) + 1).padStart(4, '0');
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal">
            <div class="modal-header"><h3 class="modal-title">ğŸ§¾ Fattura per ${c.name}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body"><form id="quickInvForm" onsubmit="saveInvoice(event)">
                <input type="hidden" name="clientId" value="${id}">
                <div class="form-row"><div class="form-group"><label class="form-label">Numero</label><input type="text" class="form-input" name="number" value="${num}" required></div><div class="form-group"><label class="form-label">Importo â‚¬</label><input type="number" class="form-input" name="amount" value="${SERVICES[c.service]?.price || 0}" required></div></div>
                <div class="form-group"><label class="form-label">Servizio</label><input type="text" class="form-input" name="service" value="${SERVICES[c.service]?.name || c.service}"></div>
                <div class="form-group"><label class="form-label">Descrizione</label><textarea class="form-textarea" name="description">Servizio ${c.service} - ${c.name}</textarea></div>
            </form></div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('quickInvForm').requestSubmit()">ğŸ’¾ Crea</button></div>
        </div></div>`;
    }
    
    function openTemplateForClient(id) {
        const c = S.clients.find(x => x.id === id); if (!c) return;
        openTemplateModal(c.service.toLowerCase(), c);
    }

    function invoicesPage() {
        const pending = S.invoices.filter(i => i.status === 'pending');
        const paid = S.invoices.filter(i => i.status === 'paid');
        
        const getRecipientName = (inv) => {
            if (inv.recipientName) return inv.recipientName;
            const client = S.clients.find(c => c.id === inv.clientId || c.id === inv.recipientId);
            const user = S.users.find(u => u.id === inv.clientId || u.id === inv.recipientId);
            return client?.name || user?.name || 'N/A';
        };
        
        const getRecipientBadge = (inv) => {
            if (inv.recipientType === 'landlord') return '<span class="badge gold" style="font-size:10px">ğŸ </span>';
            if (inv.recipientType === 'tenant') return '<span class="badge blue" style="font-size:10px">ğŸ‘¤</span>';
            return '<span class="badge purple" style="font-size:10px">ğŸ’¼</span>';
        };
        
        return `
            <div class="page-header"><div><h1 class="page-title">Fatture</h1></div><div class="page-actions"><button class="btn btn-secondary btn-sm" onclick="exportInvoicesCSV()">ğŸ“Š Export</button><button class="btn" onclick="openModal('addInvoice')">+ Nuova</button></div></div>
            <div class="stats-grid" style="grid-template-columns:repeat(3,1fr)">
                <div class="stat-card green"><div class="stat-value">â‚¬${paid.reduce((s,i)=>s+(i.amount||0),0).toLocaleString('it-IT')}</div><div class="stat-label">Incassate (${paid.length})</div></div>
                <div class="stat-card orange"><div class="stat-value">â‚¬${pending.reduce((s,i)=>s+(i.amount||0),0).toLocaleString('it-IT')}</div><div class="stat-label">Da Incassare (${pending.length})</div></div>
                <div class="stat-card blue"><div class="stat-value">${S.invoices.length}</div><div class="stat-label">Totale</div></div>
            </div>
            <div class="card"><div class="card-body flush">${S.invoices.length ? S.invoices.map(inv => {
                return `<div class="list-item clickable" onclick="viewInvoice('${inv.id}')"><div class="list-icon" style="background:${inv.status === 'paid' ? 'var(--green-light)' : 'var(--orange-light)'}">ğŸ§¾</div><div class="list-content"><div class="list-title">${inv.number} - ${getRecipientName(inv)} ${getRecipientBadge(inv)}</div><div class="list-subtitle">${inv.service || ''} Â· ${fmtDate(inv.date || inv.createdAt)}</div></div><div class="list-meta"><div class="list-value ${inv.status === 'paid' ? 'text-green' : 'text-gold'}">â‚¬${(inv.amount || 0).toLocaleString('it-IT')}</div><span class="badge ${inv.status === 'paid' ? 'green' : 'orange'}">${inv.status === 'paid' ? 'Pagata' : 'In Attesa'}</span></div><button class="btn btn-xs btn-secondary" onclick="event.stopPropagation();downloadInvoicePDF('${inv.id}')">ğŸ“¥</button></div>`;
            }).join('') : '<div class="empty-state"><div class="empty-icon">ğŸ§¾</div><div class="empty-title">Nessuna fattura</div><button class="btn" onclick="openModal(\'addInvoice\')">+ Crea</button></div>'}</div></div>`;
    }

    function templatesPage() {
        return `<div class="page-header">
                <div><h1 class="page-title">ğŸ“œ Template & Modulistica</h1><p class="page-subtitle">Documenti professionali bilingue IT/EN</p></div>
                <div class="page-actions">
                    <div class="lang-selector">
                        <button class="lang-btn ${S.lang === 'IT' ? 'active' : ''}" onclick="setLang('IT')">ğŸ‡®ğŸ‡¹ IT</button>
                        <button class="lang-btn ${S.lang === 'EN' ? 'active' : ''}" onclick="setLang('EN')">ğŸ‡¬ğŸ‡§ EN</button>
                    </div>
                </div>
            </div>
            
            <div class="alert info" style="margin-bottom:20px">
                <span class="alert-icon">ğŸŒ</span>
                <div class="alert-content">
                    <div class="alert-title">Documenti Bilingue</div>
                    <div class="alert-text">I documenti saranno generati in <strong>${S.lang === 'IT' ? 'Italiano' : 'English'}</strong>. Cambia lingua con il selettore in alto.</div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:24px">
                <div class="stat-card gold"><div class="stat-value">3</div><div class="stat-label">Servizi BOOM</div></div>
                <div class="stat-card blue"><div class="stat-value">3</div><div class="stat-label">Contratti Locazione</div></div>
                <div class="stat-card green"><div class="stat-value">5</div><div class="stat-label">Ricevute & Proposte</div></div>
                <div class="stat-card purple"><div class="stat-value">4</div><div class="stat-label">Gestione</div></div>
            </div>
            
            <div class="grid-2">
                <!-- SERVIZI BOOM -->
                <div class="card">
                    <div class="card-header" style="background:var(--gold-light)">
                        <h3 class="card-title" style="color:var(--gold)">ğŸ’¼ Servizi BOOM</h3>
                    </div>
                    <div class="card-body">
                        <div style="display:grid;gap:10px">
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('pfs')">
                                <span style="flex:1;text-align:left">ğŸ  Property Finding Service</span>
                                <span class="badge gold">â‚¬350</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('das')">
                                <span style="flex:1;text-align:left">ğŸ“‹ Deal Assistance Service</span>
                                <span class="badge blue">â‚¬249</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('vv')">
                                <span style="flex:1;text-align:left">ğŸ¥ Virtual Viewing</span>
                                <span class="badge purple">â‚¬89</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('lettera_incarico')">
                                <span style="flex:1;text-align:left">ğŸ“ Lettera d'Incarico</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- PROPOSTE -->
                <div class="card">
                    <div class="card-header" style="background:var(--green-light)">
                        <h3 class="card-title" style="color:var(--green)">ğŸ¤ Proposte & Preventivi</h3>
                    </div>
                    <div class="card-body">
                        <div style="display:grid;gap:10px">
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('proposta_locazione')">
                                <span style="flex:1;text-align:left">ğŸ“¨ Proposta di Locazione</span>
                                <span class="badge gray">Inquilinoâ†’Prop.</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('accettazione_proposta')">
                                <span style="flex:1;text-align:left">âœ… Accettazione Proposta</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('proposal')">
                                <span style="flex:1;text-align:left">ğŸ“Š Proposta Servizi BOOM</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('quote')">
                                <span style="flex:1;text-align:left">ğŸ’° Preventivo</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- CONTRATTI LOCAZIONE -->
                <div class="card">
                    <div class="card-header" style="background:var(--blue-light)">
                        <h3 class="card-title" style="color:var(--blue)">ğŸ“‹ Contratti Locazione</h3>
                        <span class="badge blue">Canone Concordato</span>
                    </div>
                    <div class="card-body">
                        <p style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Conformi all'Accordo Territoriale Roma 25/07/2023</p>
                        <div style="display:grid;gap:10px">
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('rental_4plus4')">
                                <span style="flex:1;text-align:left">ğŸ¢ Locazione Ordinaria 4+4</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('rental_transitorio')">
                                <span style="flex:1;text-align:left">â±ï¸ Locazione Transitoria</span>
                                <span class="badge gray">1-18 mesi</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('rental_studenti')">
                                <span style="flex:1;text-align:left">ğŸ“ Locazione Studenti</span>
                                <span class="badge gray">6-36 mesi</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('disdetta')">
                                <span style="flex:1;text-align:left">âŒ Disdetta Contratto</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- RICEVUTE -->
                <div class="card">
                    <div class="card-header" style="background:var(--orange-light)">
                        <h3 class="card-title" style="color:var(--orange)">ğŸ§¾ Ricevute</h3>
                    </div>
                    <div class="card-body">
                        <div style="display:grid;gap:10px">
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('ricevuta_pigione')">
                                <span style="flex:1;text-align:left">ğŸ’° Ricevuta Pigione/Affitto</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('deposit_receipt')">
                                <span style="flex:1;text-align:left">ğŸ¦ Ricevuta Deposito Cauzionale</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('ricevuta_provvigione')">
                                <span style="flex:1;text-align:left">ğŸ’¼ Ricevuta Provvigione</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- GESTIONE IMMOBILIARE -->
                <div class="card">
                    <div class="card-header" style="background:var(--purple-light)">
                        <h3 class="card-title" style="color:var(--purple)">ğŸ  Gestione Immobiliare</h3>
                    </div>
                    <div class="card-body">
                        <div style="display:grid;gap:10px">
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('mandato_gestione')">
                                <span style="flex:1;text-align:left">ğŸ“œ Mandato di Gestione</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('rendiconto_annuale')">
                                <span style="flex:1;text-align:left">ğŸ“Š Rendiconto Annuale</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('comunicazione_istat')">
                                <span style="flex:1;text-align:left">ğŸ“ˆ Comunicazione Aumento ISTAT</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('sollecito_pagamento')">
                                <span style="flex:1;text-align:left">âš ï¸ Sollecito Pagamento</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- VERBALI E INVENTARI -->
                <div class="card">
                    <div class="card-header" style="background:var(--cyan-light)">
                        <h3 class="card-title" style="color:var(--cyan)">ğŸ”‘ Consegne & Inventari</h3>
                    </div>
                    <div class="card-body">
                        <div style="display:grid;gap:10px">
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('handover')">
                                <span style="flex:1;text-align:left">ğŸ”‘ Verbale Consegna Chiavi</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('inventory')">
                                <span style="flex:1;text-align:left">ğŸ“¦ Inventario Arredi</span>
                            </button>
                            <button class="btn btn-block btn-secondary" onclick="openTemplateModal('stato_immobile')">
                                <span style="flex:1;text-align:left">ğŸ  Stato dell'Immobile</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Info Box -->
            <div class="alert info" style="margin-top:24px">
                <span class="alert-icon">â„¹ï¸</span>
                <div class="alert-content">
                    <div class="alert-title">Compilazione Automatica</div>
                    <div class="alert-text">I template si compilano automaticamente con i dati di clienti, immobili e contratti giÃ  presenti nel sistema. Seleziona un record esistente o inserisci manualmente.</div>
                </div>
            </div>`;
    }

    function usersPage() {
        return `<div class="page-header"><h1 class="page-title">Utenti</h1><div class="page-actions"><button class="btn" onclick="openModal('addUser')">+ Nuovo</button></div></div>
            <div class="card"><div class="card-body flush">${S.users.map(u => `<div class="list-item clickable" onclick="viewUser('${u.id}')"><div class="avatar ${u.role === 'admin' ? 'purple' : u.role === 'landlord' ? '' : 'blue'}">${initials(u.name)}</div><div class="list-content"><div class="list-title">${u.name} ${u.id === S.profile.id ? '<span class="badge gray">Tu</span>' : ''}</div><div class="list-subtitle">${u.email}${u.phone ? ' Â· ' + u.phone : ''}</div></div><span class="badge ${u.role === 'admin' ? 'purple' : u.role === 'landlord' ? 'gold' : 'blue'}">${roleLabel(u.role)}</span></div>`).join('') || '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-title">Nessun utente</div></div>'}</div></div>`;
    }

    function propertiesPage() {
        return `<div class="page-header"><h1 class="page-title">Immobili</h1><div class="page-actions"><button class="btn" onclick="openModal('addProperty')">+ Nuovo</button></div></div>
            <div class="card"><div class="card-body flush">${S.properties.map(p => {
                const c = S.contracts.find(x => x.propertyId === p.id && x.status === 'active');
                const owner = S.users.find(u => u.id === p.ownerId);
                const tenant = c ? S.users.find(u => u.id === c.tenantId) : null;
                return `<div class="list-item clickable" onclick="viewProperty('${p.id}')"><div class="list-icon">ğŸ </div><div class="list-content"><div class="list-title">${p.name} <span class="badge ${c ? 'green' : 'gray'}">${c ? 'Affittato' : 'Libero'}</span></div><div class="list-subtitle">${owner?.name || 'N/A'}${c ? ' â†’ ' + (tenant?.name || '') : ''} Â· ${p.address || 'Roma'}</div></div><div class="list-value text-gold">â‚¬${p.rent || 0}/mese</div></div>`;
            }).join('') || '<div class="empty-state"><div class="empty-icon">ğŸ </div><div class="empty-title">Nessun immobile</div></div>'}</div></div>`;
    }

    function contractsPage() {
        const expiringCount = S.contracts.filter(c => c.status === 'active' && daysUntil(c.endDate) !== null && daysUntil(c.endDate) <= 30 && daysUntil(c.endDate) >= 0).length;
        return `<div class="page-header"><h1 class="page-title">Contratti</h1><div class="page-actions">${expiringCount ? `<span class="badge orange">${expiringCount} in scadenza</span>` : ''}<button class="btn" onclick="openModal('addContract')">+ Nuovo</button></div></div>
            <div class="card"><div class="card-body flush">${S.contracts.map(c => {
                const p = S.properties.find(x => x.id === c.propertyId);
                const t = S.users.find(x => x.id === c.tenantId);
                const days = daysUntil(c.endDate);
                const expiring = c.status === 'active' && days !== null && days <= 30 && days >= 0;
                return `<div class="list-item clickable" onclick="viewContract('${c.id}')"><div class="list-icon" style="background:${expiring ? 'var(--orange-light)' : c.status === 'active' ? 'var(--green-light)' : 'var(--red-light)'}">ğŸ“‹</div><div class="list-content"><div class="list-title">${p?.name || 'Immobile'} <span class="badge ${c.status === 'active' ? (expiring ? 'orange' : 'green') : 'red'}">${c.status === 'active' ? (expiring ? days + 'gg' : 'Attivo') : 'Scaduto'}</span></div><div class="list-subtitle">${t?.name || 'N/A'} Â· ${fmtDate(c.startDate)} â†’ ${fmtDate(c.endDate)}</div></div><div class="list-meta"><div class="list-value text-gold">â‚¬${c.rent || 0}/mese</div><div class="stat-sub">Dep: â‚¬${c.deposit || 0}</div></div></div>`;
            }).join('') || '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">Nessun contratto</div></div>'}</div></div>`;
    }

    function paymentsPage() {
        const overdueCount = S.payments.filter(p => p.status === 'pending' && isOverdue(p.dueDate)).length;
        const paidTotal = S.payments.filter(p => p.status === 'paid').reduce((s, p) => s + (p.amount || 0), 0);
        const pendingTotal = S.payments.filter(p => p.status === 'pending').reduce((s, p) => s + (p.amount || 0), 0);
        return `<div class="page-header"><h1 class="page-title">Pagamenti</h1><div class="page-actions">${overdueCount ? `<span class="badge red">${overdueCount} in ritardo</span>` : ''}<button class="btn btn-secondary btn-sm" onclick="exportPaymentsCSV()">ğŸ“Š Export</button><button class="btn btn-secondary" onclick="openModal('bulkPayments')">ğŸ“… Genera Multipli</button><button class="btn" onclick="openModal('addPayment')">+ Registra</button></div></div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">
                <div class="card" style="padding:16px;text-align:center"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase">Totale Pagamenti</div><div style="font-size:24px;font-weight:600;margin-top:4px">${S.payments.length}</div></div>
                <div class="card" style="padding:16px;text-align:center;background:var(--green-light)"><div style="font-size:11px;color:var(--green);text-transform:uppercase">Incassato</div><div style="font-size:24px;font-weight:600;margin-top:4px;color:var(--green)">â‚¬${paidTotal.toLocaleString('it-IT')}</div></div>
                <div class="card" style="padding:16px;text-align:center;background:var(--orange-light)"><div style="font-size:11px;color:var(--orange);text-transform:uppercase">In Attesa</div><div style="font-size:24px;font-weight:600;margin-top:4px;color:var(--orange)">â‚¬${pendingTotal.toLocaleString('it-IT')}</div></div>
            </div>
            <div class="card"><div class="card-body flush">${S.payments.sort((a,b) => (b.month || '').localeCompare(a.month || '')).map(p => {
                const c = S.contracts.find(x => x.id === p.contractId);
                const prop = c ? S.properties.find(x => x.id === c.propertyId) : null;
                const t = c ? S.users.find(x => x.id === c.tenantId) : null;
                const overdue = p.status === 'pending' && isOverdue(p.dueDate);
                return `<div class="list-item clickable" onclick="openModal('editPayment',S.payments.find(x=>x.id==='${p.id}'))"><div class="list-icon" style="background:${p.status === 'paid' ? 'var(--green-light)' : overdue ? 'var(--red-light)' : 'var(--orange-light)'}">${p.status === 'paid' ? 'âœ“' : overdue ? 'âš ï¸' : 'â³'}</div><div class="list-content"><div class="list-title">${prop?.name || 'Pagamento'} Â· ${p.month || ''}</div><div class="list-subtitle">${t?.name || ''} Â· ${p.status === 'paid' ? 'Pagato ' + fmtDate(p.paidDate) : 'Scadenza ' + fmtDate(p.dueDate)}</div></div><div class="list-value ${p.status === 'paid' ? 'text-green' : overdue ? 'text-red' : 'text-gold'}">â‚¬${p.amount || 0}</div>${p.status === 'pending' ? `<button class="btn btn-xs btn-success" onclick="event.stopPropagation();markPaymentPaid('${p.id}')">âœ“</button>` : ''}</div>`;
            }).join('') || '<div class="empty-state"><div class="empty-icon">ğŸ’³</div><div class="empty-title">Nessun pagamento</div><button class="btn" onclick="openModal(\'bulkPayments\')">ğŸ“… Genera Pagamenti</button></div>'}</div></div>`;
    }

    function maintenancePage() {
        return `<div class="page-header"><h1 class="page-title">Manutenzione</h1><div class="page-actions"><button class="btn" onclick="openModal('addMaintenance')">+ Nuova</button></div></div>
            <div class="card"><div class="card-body flush">${S.maintenance.map(m => {
                const p = S.properties.find(x => x.id === m.propertyId);
                const u = S.users.find(x => x.id === m.userId);
                return `<div class="list-item clickable" onclick="viewMaintenance('${m.id}')"><div class="list-icon" style="background:${m.priority === 'urgent' ? 'var(--red-light)' : m.status === 'resolved' ? 'var(--green-light)' : 'var(--orange-light)'}">${m.priority === 'urgent' ? 'ğŸš¨' : m.status === 'resolved' ? 'âœ“' : 'ğŸ”§'}</div><div class="list-content"><div class="list-title">${m.title} <span class="badge ${priorityColor(m.priority)}">${priorityLabel(m.priority)}</span></div><div class="list-subtitle">${p?.name || ''} Â· ${u?.name || ''} Â· ${fmtDate(m.createdAt)}</div></div><span class="badge ${statusColor(m.status)}">${statusLabel(m.status)}</span></div>`;
            }).join('') || '<div class="empty-state"><div class="empty-icon">ğŸ”§</div><div class="empty-title">Nessuna richiesta</div></div>'}</div></div>`;
    }

    function documentsPage() {
        const landlords = S.users.filter(u => u.role === 'landlord');
        const tenants = S.users.filter(u => u.role === 'tenant');
        return `<div class="page-header">
                <div><h1 class="page-title">ğŸ“ Documenti</h1><p class="page-subtitle">${S.documents.length} documenti Â· Assegna documenti a proprietari/inquilini</p></div>
                <div class="page-actions"><button class="btn" onclick="openDocUploadModal()">+ Carica Documento</button></div>
            </div>
            <div class="card" style="margin-bottom:20px">
                <div style="display:flex;gap:8px;padding:12px;border-bottom:1px solid var(--border);flex-wrap:wrap">
                    <button class="btn btn-sm" onclick="filterDocs('all',this)">Tutti (${S.documents.length})</button>
                    <button class="btn btn-sm btn-secondary" onclick="filterDocs('contract',this)">ğŸ“‹ Contratti</button>
                    <button class="btn btn-sm btn-secondary" onclick="filterDocs('receipt',this)">ğŸ§¾ Ricevute</button>
                    <button class="btn btn-sm btn-secondary" onclick="filterDocs('id',this)">ğŸªª ID</button>
                    <button class="btn btn-sm btn-secondary" onclick="filterDocs('shared',this)">ğŸ”— Condivisi</button>
                </div>
                <div class="card-body flush" id="docsContainer">
                    ${S.documents.map(d => {
                        const u = S.users.find(x => x.id === d.userId);
                        const prop = S.properties.find(x => x.id === d.propertyId);
                        return `<div class="list-item doc-item" data-type="${d.type}" data-shared="${d.shared}">
                            <div class="list-icon">${docIcon(d.type)}</div>
                            <div class="list-content">
                                <div class="list-title">${d.name} ${d.shared ? '<span class="badge blue">ğŸ”— Condiviso</span>' : ''}</div>
                                <div class="list-subtitle">
                                    ${u ? `<span style="background:${u.role==='landlord'?'var(--gold-light)':'var(--blue-light)'};padding:2px 8px;border-radius:4px;font-size:11px">${u.role === 'landlord' ? 'ğŸ ' : 'ğŸ‘¤'} ${u.name}</span>` : ''}
                                    ${prop ? ` Â· ${prop.name}` : ''} Â· ${fmtDate(d.createdAt)}
                                </div>
                            </div>
                            <div style="display:flex;gap:4px">
                                ${d.fileUrl ? `<button class="btn btn-xs btn-secondary" onclick="window.open('${d.fileUrl}','_blank')" title="Scarica">ğŸ“¥</button>` : ''}
                                <button class="btn btn-xs btn-secondary" onclick="editDocModal('${d.id}')" title="Modifica">âœï¸</button>
                                <button class="btn btn-xs btn-danger" onclick="confirmDelete('document','${d.id}','${d.name}')" title="Elimina">ğŸ—‘</button>
                            </div>
                        </div>`;
                    }).join('') || '<div class="empty-state"><div class="empty-icon">ğŸ“</div><div class="empty-title">Nessun documento</div><button class="btn" onclick="openDocUploadModal()">+ Carica</button></div>'}
                </div>
            </div>`;
    }
    
    function filterDocs(type, btn) {
        document.querySelectorAll('.card button.btn-sm').forEach(b => { b.classList.remove('btn-secondary'); b.classList.add('btn-secondary'); });
        btn.classList.remove('btn-secondary');
        document.querySelectorAll('.doc-item').forEach(item => {
            if (type === 'all') item.style.display = '';
            else if (type === 'shared') item.style.display = item.dataset.shared === 'true' ? '' : 'none';
            else item.style.display = item.dataset.type === type ? '' : 'none';
        });
    }
    
    function openDocUploadModal() {
        const landlords = S.users.filter(u => u.role === 'landlord');
        const tenants = S.users.filter(u => u.role === 'tenant');
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal lg">
            <div class="modal-header"><h3 class="modal-title">ğŸ“¤ Carica Documento</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body"><form id="docUploadForm" onsubmit="saveDocWithAssignment(event)">
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ“„ DETTAGLI DOCUMENTO</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="name" required placeholder="es. Contratto Locazione Rossi"></div><div class="form-group"><label class="form-label">Tipo</label><select class="form-select" name="type"><option value="contract">ğŸ“‹ Contratto</option><option value="id">ğŸªª Documento ID</option><option value="receipt">ğŸ§¾ Ricevuta</option><option value="utility">ğŸ’¡ Utenza</option><option value="other">ğŸ“„ Altro</option></select></div></div>
                    <div class="form-group">
                        <label class="form-label">File</label>
                        <div style="border:2px dashed var(--border);border-radius:8px;padding:24px;text-align:center;cursor:pointer" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" style="display:none" onchange="handleFile(this)" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            <div style="font-size:24px">ğŸ“</div>
                            <div style="font-weight:500">Clicca per selezionare</div>
                            <div style="font-size:11px;color:var(--text-muted)">PDF, DOC, JPG, PNG (max 10MB)</div>
                        </div>
                        <div id="filePreview"></div>
                    </div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ ASSEGNA A UTENTE</h4>
                    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Il documento sarÃ  visibile nell'account dell'utente selezionato</p>
                    <div class="form-group"><label class="form-label">Assegna a</label>
                        <select class="form-select" name="userId">
                            <option value="">-- Nessuna assegnazione (solo admin) --</option>
                            <optgroup label="ğŸ  Proprietari">${landlords.map(u => `<option value="${u.id}">${u.name} (${u.email})</option>`).join('')}</optgroup>
                            <optgroup label="ğŸ‘¤ Inquilini">${tenants.map(u => `<option value="${u.id}">${u.name} (${u.email})</option>`).join('')}</optgroup>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Immobile Collegato</label>
                        <select class="form-select" name="propertyId"><option value="">-- Nessuno --</option>${S.properties.map(p => `<option value="${p.id}">${p.name} - ${p.address || 'Roma'}</option>`).join('')}</select>
                    </div>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;padding:8px 0"><input type="checkbox" name="shared" value="true"> ğŸ”— Condividi con TUTTI gli utenti collegati all'immobile</label>
                </div>
                <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes" placeholder="Note opzionali..."></textarea></div>
            </form></div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('docUploadForm').requestSubmit()">ğŸ’¾ Salva</button></div>
        </div></div>`;
    }
    
    function openUserDocUpload(userId) {
        const u = S.users.find(x => x.id === userId);
        if (!u) return;
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal">
            <div class="modal-header"><h3 class="modal-title">ğŸ“¤ Carica Documento per ${u.name}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body"><form id="userDocForm" onsubmit="saveUserDoc(event,'${userId}')">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Nome Documento *</label><input type="text" class="form-input" name="name" required placeholder="es. Carta IdentitÃ "></div>
                    <div class="form-group"><label class="form-label">Tipo</label><select class="form-select" name="type">
                        <option value="id">ğŸªª Documento ID</option>
                        <option value="contract">ğŸ“‹ Contratto</option>
                        <option value="receipt">ğŸ§¾ Ricevuta</option>
                        <option value="utility">ğŸ’¡ Utenza</option>
                        <option value="other">ğŸ“„ Altro</option>
                    </select></div>
                </div>
                <div class="form-group">
                    <label class="form-label">File</label>
                    <div style="border:2px dashed var(--border);border-radius:8px;padding:24px;text-align:center;cursor:pointer" onclick="document.getElementById('userFileInput').click()">
                        <input type="file" id="userFileInput" style="display:none" onchange="handleFile(this)" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                        <div style="font-size:24px">ğŸ“</div>
                        <div style="font-weight:500">Clicca per selezionare</div>
                        <div style="font-size:11px;color:var(--text-muted)">PDF, DOC, JPG, PNG (max 10MB)</div>
                    </div>
                    <div id="filePreview"></div>
                </div>
                <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes" rows="2" placeholder="Note opzionali..."></textarea></div>
            </form></div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('userDocForm').requestSubmit()">ğŸ’¾ Carica</button></div>
        </div></div>`;
    }
    
    async function saveUserDoc(e, userId) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        if (!data.name) return toast('error', 'Inserisci nome documento');
        try {
            let fileUrl = null, fileName = null, fileSize = null;
            if (selectedFile) {
                toast('info', 'Caricamento file...');
                const path = `documents/${userId}/${Date.now()}_${selectedFile.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                const uploadTask = await storage.ref(path).put(selectedFile);
                fileUrl = await uploadTask.ref.getDownloadURL();
                fileName = selectedFile.name;
                fileSize = selectedFile.size;
            }
            await db.collection('documents').add({
                name: data.name,
                type: data.type || 'other',
                userId: userId,
                notes: data.notes || '',
                fileUrl, fileName, fileSize,
                uploadedBy: S.profile.id,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            selectedFile = null;
            closeModal(); await refresh();
            toast('success', 'Documento caricato!');
            // Riapri profilo utente
            setTimeout(() => viewUser(userId), 300);
        } catch (err) { toast('error', 'Errore', err.message); }
    }
    
    async function saveDocWithAssignment(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        if (!data.name) return toast('error', 'Inserisci nome documento');
        try {
            let fileUrl = null, fileName = null, fileSize = null;
            if (selectedFile) {
                toast('info', 'Caricamento file...');
                const path = `documents/${data.userId || 'admin'}/${Date.now()}_${selectedFile.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                const uploadTask = await storage.ref(path).put(selectedFile);
                fileUrl = await uploadTask.ref.getDownloadURL();
                fileName = selectedFile.name;
                fileSize = selectedFile.size;
            }
            const docRef = await db.collection('documents').add({
                name: data.name, type: data.type || 'other',
                userId: data.userId || S.profile.id,
                propertyId: data.propertyId || null,
                shared: data.shared === 'true',
                notes: data.notes || '',
                fileUrl, fileName, fileSize,
                uploadedBy: S.profile.id,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Notify assigned user (if not self)
            if (data.userId && data.userId !== S.profile.id) {
                await notifyNewDocument({ id: docRef.id, name: data.name, type: data.type }, data.userId);
            }
            
            selectedFile = null;
            closeModal(); await refresh();
            toast('success', 'Documento salvato!', data.userId ? 'Assegnato all\'utente' : '');
        } catch (err) { toast('error', 'Errore', err.message); }
    }
    
    function editDocModal(id) {
        const d = S.documents.find(x => x.id === id); if (!d) return;
        const landlords = S.users.filter(u => u.role === 'landlord');
        const tenants = S.users.filter(u => u.role === 'tenant');
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal">
            <div class="modal-header"><h3 class="modal-title">âœï¸ Modifica Documento</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body"><form id="editDocForm" onsubmit="updateDoc(event,'${id}')">
                <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="name" value="${d.name}" required></div><div class="form-group"><label class="form-label">Tipo</label><select class="form-select" name="type"><option value="contract" ${d.type==='contract'?'selected':''}>ğŸ“‹ Contratto</option><option value="id" ${d.type==='id'?'selected':''}>ğŸªª ID</option><option value="receipt" ${d.type==='receipt'?'selected':''}>ğŸ§¾ Ricevuta</option><option value="utility" ${d.type==='utility'?'selected':''}>ğŸ’¡ Utenza</option><option value="other" ${d.type==='other'?'selected':''}>ğŸ“„ Altro</option></select></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Assegna a</label><select class="form-select" name="userId"><option value="">-- Admin --</option><optgroup label="ğŸ  Proprietari">${landlords.map(u => `<option value="${u.id}" ${d.userId===u.id?'selected':''}>${u.name}</option>`).join('')}</optgroup><optgroup label="ğŸ‘¤ Inquilini">${tenants.map(u => `<option value="${u.id}" ${d.userId===u.id?'selected':''}>${u.name}</option>`).join('')}</optgroup></select></div><div class="form-group"><label class="form-label">Immobile</label><select class="form-select" name="propertyId"><option value="">-- Nessuno --</option>${S.properties.map(p => `<option value="${p.id}" ${d.propertyId===p.id?'selected':''}>${p.name}</option>`).join('')}</select></div></div>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;padding:8px 0"><input type="checkbox" name="shared" value="true" ${d.shared?'checked':''}> ğŸ”— Condiviso</label>
            </form></div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="confirmDelete('document','${id}','${d.name}')">ğŸ—‘ Elimina</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annulla</button>
                <button class="btn" onclick="document.getElementById('editDocForm').requestSubmit()">ğŸ’¾ Salva</button>
            </div>
        </div></div>`;
    }
    
    async function updateDoc(e, id) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
            await db.collection('documents').doc(id).update({
                name: data.name, type: data.type,
                userId: data.userId || null,
                propertyId: data.propertyId || null,
                shared: data.shared === 'true'
            });
            closeModal(); await refresh(); toast('success', 'Documento aggiornato!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LANDLORD PAGES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function myPropertiesPage() {
        const props = getMyProperties();
        const contracts = getMyContracts();
        return `<div class="page-header"><h1 class="page-title">ğŸ  I Miei Immobili</h1></div>
            <div class="card"><div class="card-body flush">${props.map(p => {
                const c = contracts.find(x => x.propertyId === p.id && x.status === 'active');
                const t = c ? S.users.find(u => u.id === c.tenantId) : null;
                return `<div class="list-item clickable" onclick="viewPropertyLandlord('${p.id}')"><div class="list-icon">ğŸ </div><div class="list-content"><div class="list-title">${p.name} <span class="badge ${c ? 'green' : 'gray'}">${c ? 'Affittato' : 'Libero'}</span></div><div class="list-subtitle">${c ? t?.name + ' Â· ' + t?.email : 'Nessun inquilino'}</div></div><div class="list-value text-gold">â‚¬${p.rent || 0}/mese</div></div>`;
            }).join('') || '<div class="empty-state"><div class="empty-icon">ğŸ </div><div class="empty-title">Nessun immobile</div></div>'}</div></div>`;
    }

    function myContractsPage() {
        const contracts = getMyContracts();
        return `<div class="page-header"><h1 class="page-title">ğŸ“‹ I Miei Contratti</h1></div>
            <div class="card"><div class="card-body flush">${contracts.map(c => {
                const p = S.properties.find(x => x.id === c.propertyId);
                const t = S.users.find(x => x.id === c.tenantId);
                const days = daysUntil(c.endDate);
                return `<div class="list-item clickable" onclick="viewContractLandlord('${c.id}')"><div class="list-icon">ğŸ“‹</div><div class="list-content"><div class="list-title">${p?.name || ''} <span class="badge ${c.status === 'active' ? 'green' : 'red'}">${c.status === 'active' ? 'Attivo' : 'Scaduto'}</span></div><div class="list-subtitle">${t?.name || ''} Â· ${fmtDate(c.startDate)} â†’ ${fmtDate(c.endDate)}${days !== null && days <= 60 && days >= 0 ? ' Â· <span class="text-orange">' + days + ' giorni</span>' : ''}</div></div><div class="list-meta"><div class="list-value text-gold">â‚¬${c.rent || 0}</div><div class="stat-sub">Dep: â‚¬${c.deposit || 0}</div></div></div>`;
            }).join('') || '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">Nessun contratto</div></div>'}</div></div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TENANT PAGES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function tenantContractPage() {
        const contract = getMyContracts().find(c => c.status === 'active');
        if (!contract) return `<div class="card"><div class="card-body"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">Nessun contratto attivo</div></div></div></div>`;
        const prop = S.properties.find(p => p.id === contract.propertyId);
        const landlord = getMyLandlord();
        const days = daysUntil(contract.endDate);

        return `<div class="page-header"><h1 class="page-title">ğŸ“‹ Il Mio Contratto</h1><div class="page-actions"><button class="btn" onclick="downloadMyContractPDF()">ğŸ“¥ Scarica PDF</button></div></div>
            <div class="grid-2">
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸ  ${prop?.name || 'Alloggio'}</h3><span class="badge green">Attivo</span></div><div class="card-body">
                    <div class="detail-grid">
                        <div><div class="detail-label">Indirizzo</div><div class="detail-value">${prop?.address || 'Roma, Italia'}</div></div>
                        <div><div class="detail-label">Affitto Mensile</div><div class="detail-value text-gold">â‚¬${contract.rent}</div></div>
                        <div><div class="detail-label">Deposito Cauzionale</div><div class="detail-value">â‚¬${contract.deposit || 0}</div></div>
                        <div><div class="detail-label">Data Inizio</div><div class="detail-value">${fmtDate(contract.startDate)}</div></div>
                        <div><div class="detail-label">Data Fine</div><div class="detail-value">${fmtDate(contract.endDate)}</div></div>
                        <div><div class="detail-label">Tempo Rimanente</div><div class="detail-value"><span class="countdown ${getCountdownClass(days)}">${days !== null ? (days > 0 ? days + ' giorni' : 'Scaduto') : 'N/A'}</span></div></div>
                    </div>
                </div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">ğŸ‘¤ Proprietario</h3></div><div class="card-body">
                    ${landlord ? `<div class="contact-card"><div class="avatar lg">${initials(landlord.name)}</div><div class="contact-info"><div class="contact-name">${landlord.name}</div><div class="contact-role">Proprietario dell'immobile</div><div class="contact-details">${landlord.email}${landlord.phone ? '<br>' + landlord.phone : ''}</div></div></div>` : '<p class="text-muted">Informazioni non disponibili</p>'}
                    <div class="info-box">
                        <div class="info-box-title">ğŸ’³ Dati per il Pagamento</div>
                        <div class="info-box-row"><span class="info-box-label">Intestatario</span><span class="info-box-value">${COMPANY.legal}</span></div>
                        <div class="info-box-row"><span class="info-box-label">IBAN</span><span class="info-box-value" style="font-size:11px">${COMPANY.iban}</span></div>
                        <div class="info-box-row"><span class="info-box-label">Causale</span><span class="info-box-value">Affitto ${prop?.name}</span></div>
                    </div>
                </div></div>
            </div>`;
    }

    function myPaymentsPage() {
        const payments = getMyPayments();
        const paid = payments.filter(p => p.status === 'paid');
        const pending = payments.filter(p => p.status === 'pending');
        const overdue = pending.filter(p => isOverdue(p.dueDate));

        return `<div class="page-header"><h1 class="page-title">ğŸ’³ ${isTenant() ? 'I Miei Pagamenti' : 'Pagamenti'}</h1></div>
            <div class="stats-grid" style="grid-template-columns:repeat(3,1fr)">
                <div class="stat-card green"><div class="stat-value">â‚¬${paid.reduce((s,p) => s + (p.amount || 0), 0).toLocaleString('it-IT')}</div><div class="stat-label">Pagati (${paid.length})</div></div>
                <div class="stat-card ${overdue.length ? 'red' : 'orange'}"><div class="stat-value">â‚¬${pending.reduce((s,p) => s + (p.amount || 0), 0).toLocaleString('it-IT')}</div><div class="stat-label">${overdue.length ? overdue.length + ' in ritardo' : 'Da Pagare'} (${pending.length})</div></div>
                <div class="stat-card blue"><div class="stat-value">${payments.length}</div><div class="stat-label">Totale</div></div>
            </div>
            <div class="card"><div class="card-body flush">${payments.length ? payments.map(p => {
                const c = S.contracts.find(x => x.id === p.contractId);
                const prop = c ? S.properties.find(x => x.id === c.propertyId) : null;
                const isOD = p.status === 'pending' && isOverdue(p.dueDate);
                return `<div class="list-item"><div class="list-icon" style="background:${p.status === 'paid' ? 'var(--green-light)' : isOD ? 'var(--red-light)' : 'var(--orange-light)'}">${p.status === 'paid' ? 'âœ“' : isOD ? 'âš ï¸' : 'â³'}</div><div class="list-content"><div class="list-title">${prop?.name || ''} Â· ${p.month || 'Pagamento'}</div><div class="list-subtitle">${p.status === 'paid' ? 'Pagato il ' + fmtDate(p.paidDate) : 'Scadenza: ' + fmtDate(p.dueDate) + (isOD ? ' (IN RITARDO)' : '')}</div></div><div class="list-meta"><div class="list-value ${p.status === 'paid' ? 'text-green' : isOD ? 'text-red' : 'text-gold'}">â‚¬${p.amount || 0}</div></div>${p.status === 'paid' && isTenant() ? `<button class="btn btn-xs btn-secondary" onclick="downloadPaymentReceipt('${p.id}')">ğŸ“¥</button>` : ''}${p.status === 'pending' && isLandlord() ? `<button class="btn btn-xs btn-success" onclick="markPaymentPaid('${p.id}')">âœ“</button>` : ''}</div>`;
            }).join('') : '<div class="empty-state"><div class="empty-icon">ğŸ’³</div><div class="empty-title">Nessun pagamento</div></div>'}</div></div>`;
    }

    function myMaintenancePage() {
        const maint = getMyMaintenance();
        return `<div class="page-header"><h1 class="page-title">ğŸ”§ Manutenzione</h1><div class="page-actions">${isTenant() ? '<button class="btn" onclick="openModal(\'addTenantMaintenance\')">+ Richiedi</button>' : ''}</div></div>
            <div class="card"><div class="card-body flush">${maint.length ? maint.map(m => {
                const p = S.properties.find(x => x.id === m.propertyId);
                return `<div class="list-item clickable" onclick="viewMaintenanceUser('${m.id}')"><div class="list-icon" style="background:${m.status === 'resolved' ? 'var(--green-light)' : m.priority === 'urgent' ? 'var(--red-light)' : 'var(--orange-light)'}">${m.status === 'resolved' ? 'âœ“' : m.priority === 'urgent' ? 'ğŸš¨' : 'ğŸ”§'}</div><div class="list-content"><div class="list-title">${m.title}</div><div class="list-subtitle">${p?.name || ''} Â· ${fmtDate(m.createdAt)}</div></div><span class="badge ${statusColor(m.status)}">${statusLabel(m.status)}</span></div>`;
            }).join('') : '<div class="empty-state"><div class="empty-icon">ğŸ”§</div><div class="empty-title">Nessuna richiesta</div>' + (isTenant() ? '<button class="btn" onclick="openModal(\'addTenantMaintenance\')">+ Richiedi</button>' : '') + '</div>'}</div></div>`;
    }

    function myDocumentsPage() {
        const docs = getMyDocuments();
        return `<div class="page-header"><h1 class="page-title">ğŸ“ I Miei Documenti</h1><div class="page-actions"><button class="btn" onclick="openModal('addDocument')">+ Carica</button></div></div>
            <div class="card"><div class="card-body flush">${docs.length ? docs.map(d => `<div class="list-item clickable" onclick="downloadDocument('${d.id}')"><div class="list-icon">${docIcon(d.type)}</div><div class="list-content"><div class="list-title">${d.name} ${d.shared ? '<span class="badge blue">Condiviso</span>' : ''}</div><div class="list-subtitle">${fmtDate(d.createdAt)}</div></div>${d.fileUrl ? '<span class="badge green">ğŸ“¥</span>' : ''}</div>`).join('') : '<div class="empty-state"><div class="empty-icon">ğŸ“</div><div class="empty-title">Nessun documento</div><button class="btn" onclick="openModal(\'addDocument\')">+ Carica</button></div>'}</div></div>`;
    }

    function settingsPage() {
        return `<div class="page-header"><h1 class="page-title">âš™ï¸ Impostazioni</h1></div>
            <div class="card"><div class="card-header"><h3 class="card-title">ğŸ‘¤ Profilo</h3></div><div class="card-body">
                <form onsubmit="updateProfile(event)">
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome</label><input type="text" class="form-input" id="setName" value="${S.profile.name}"></div><div class="form-group"><label class="form-label">Telefono</label><input type="tel" class="form-input" id="setPhone" value="${S.profile.phone || ''}"></div></div>
                    <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" value="${S.profile.email}" disabled></div>
                    <div class="form-group"><label class="form-label">Ruolo</label><input type="text" class="form-input" value="${roleLabel(S.profile.role)}" disabled></div>
                    <button type="submit" class="btn">Salva Modifiche</button>
                </form>
            </div></div>
            <div class="card"><div class="card-header"><h3 class="card-title">ğŸŒ Lingua Documenti</h3></div><div class="card-body">
                <p style="margin-bottom:16px;color:var(--text-secondary);font-size:13px">Seleziona la lingua per la generazione dei PDF e documenti</p>
                <div class="lang-selector" style="width:fit-content">
                    <button class="lang-btn ${S.lang === 'IT' ? 'active' : ''}" onclick="setLang('IT')">ğŸ‡®ğŸ‡¹ Italiano</button>
                    <button class="lang-btn ${S.lang === 'EN' ? 'active' : ''}" onclick="setLang('EN')">ğŸ‡¬ğŸ‡§ English</button>
                </div>
            </div></div>
            <div class="card"><div class="card-header"><h3 class="card-title">ğŸ” Sicurezza</h3></div><div class="card-body">
                <button class="btn btn-secondary" onclick="logout()">ğŸšª Esci dall'account</button>
            </div></div>
            <div class="card"><div class="card-header"><h3 class="card-title">ğŸ”— Collegamenti</h3></div><div class="card-body">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <a href="https://www.boomrome.com" target="_blank" class="btn btn-secondary">ğŸŒ Sito Web</a>
                    <a href="https://www.boomrome.com/apartments.html" target="_blank" class="btn btn-secondary">ğŸ  Appartamenti</a>
                    <a href="https://console.firebase.google.com" target="_blank" class="btn btn-secondary">ğŸ”¥ Firebase</a>
                    <a href="https://wa.me/393313251961" target="_blank" class="btn btn-secondary">ğŸ’¬ WhatsApp</a>
                </div>
            </div></div>`;
    }

    async function updateProfile(e) {
        e.preventDefault();
        try {
            await db.collection('users').doc(S.profile.id).update({ name: document.getElementById('setName').value, phone: document.getElementById('setPhone').value || '' });
            S.profile.name = document.getElementById('setName').value;
            S.profile.phone = document.getElementById('setPhone').value;
            document.getElementById('headerAvatar').textContent = initials(S.profile.name);
            document.getElementById('headerName').textContent = S.profile.name;
            toast('success', 'Profilo aggiornato');
        } catch (e) { toast('error', 'Errore', e.message); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADMINFLATS PAGE - Website Listings Management (REAL SYNC)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function adminflatsPage() {
        const available = S.listings.filter(l => l.status === 'available').length;
        const waitlist = S.listings.filter(l => l.status === 'waitlist').length;
        const rented = S.listings.filter(l => l.status === 'rented').length;
        
        return `<div class="page-header">
                <div><h1 class="page-title">ğŸ¢ AdminFlats</h1><p class="page-subtitle">Gestione appartamenti boomrome.com â€” Sincronizzazione LIVE</p></div>
                <div class="page-actions">
                    <a href="https://www.boomrome.com/apartments.html" target="_blank" class="btn btn-secondary">ğŸ‘ï¸ Vedi Sito</a>
                    <button class="btn" onclick="openModal('addListing')">+ Nuovo Listing</button>
                </div>
            </div>
            
            <div class="alert success" style="margin-bottom:20px">
                <span class="alert-icon">ğŸ”„</span>
                <div class="alert-content">
                    <div class="alert-title">Sincronizzazione Attiva</div>
                    <div class="alert-text">Le modifiche qui si riflettono AUTOMATICAMENTE su boomrome.com/apartments.html in tempo reale.</div>
                </div>
            </div>
            
            <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:24px">
                <div class="stat-card green"><div class="stat-value">${available}</div><div class="stat-label">ğŸŸ¢ Disponibili</div></div>
                <div class="stat-card orange"><div class="stat-value">${waitlist}</div><div class="stat-label">ğŸŸ¡ Waitlist</div></div>
                <div class="stat-card red"><div class="stat-value">${rented}</div><div class="stat-label">ğŸ”´ Affittati</div></div>
                <div class="stat-card blue"><div class="stat-value">${S.listings.length}</div><div class="stat-label">Totale</div></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“‹ Tutti gli Appartamenti</h3>
                    <span class="badge gray">${S.listings.length} listings</span>
                </div>
                <div class="card-body flush">
                    ${S.listings.length > 0 ? `<div class="table-wrapper"><table>
                        <thead><tr>
                            <th style="width:50px">Img</th>
                            <th>Appartamento</th>
                            <th>Zona</th>
                            <th>Prezzo</th>
                            <th>Dettagli</th>
                            <th>Status</th>
                            <th>Disponibile</th>
                            <th style="width:130px">Azioni</th>
                        </tr></thead>
                        <tbody>
                            ${S.listings.sort((a,b) => (a.price || 0) - (b.price || 0)).map(l => `
                                <tr>
                                    <td><div style="width:45px;height:45px;border-radius:8px;background:url('${l.image || 'https://via.placeholder.com/45/111/333'}') center/cover;border:1px solid var(--border)"></div></td>
                                    <td>
                                        <strong style="color:var(--text)">${l.name || 'Senza nome'}</strong><br>
                                        <small style="color:var(--text-muted)">${l.address || l.zone || 'â€”'}</small>
                                    </td>
                                    <td><span class="badge gray">${l.zone || 'â€”'}</span></td>
                                    <td style="color:var(--gold);font-weight:600;font-size:16px">â‚¬${(l.price || 0).toLocaleString()}</td>
                                    <td>
                                        <small style="color:var(--text-secondary)">
                                            ${l.beds || (l.bedrooms ? l.bedrooms + ' cam' : 'â€”')} Â· ${l.size || (l.sqm ? l.sqm + 'mÂ²' : 'â€”')}<br>
                                            ${l.floor || 'â€”'} Â· ${l.type || 'Appartamento'}
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge ${l.status === 'available' ? 'green' : l.status === 'waitlist' ? 'orange' : l.status === 'rented' ? 'red' : 'gray'}">
                                            ${l.status === 'available' ? 'ğŸŸ¢ Disponibile' : l.status === 'waitlist' ? 'ğŸŸ¡ Waitlist' : l.status === 'rented' ? 'ğŸ”´ Affittato' : l.status || 'draft'}
                                        </span>
                                    </td>
                                    <td><small>${l.availableDate || 'â€”'}</small></td>
                                    <td>
                                        <div style="display:flex;gap:5px">
                                            <button class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="editListing('${l.id}')" title="Modifica">âœï¸</button>
                                            <button class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="cycleListing('${l.id}','${l.status}')" title="Cambia status">ğŸ”„</button>
                                            <button class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="duplicateListing('${l.id}')" title="Duplica">ğŸ“‹</button>
                                            <button class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="confirmDelete('listings','${l.id}','${l.name}')" title="Elimina">ğŸ—‘ï¸</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table></div>` : `
                    <div class="empty-state" style="padding:60px 24px">
                        <div class="empty-icon">ğŸ </div>
                        <h3 class="empty-title">Nessun Listing</h3>
                        <p class="empty-text" style="margin-bottom:20px">Inizia aggiungendo i tuoi appartamenti o importa quelli esistenti.</p>
                        <div style="display:flex;gap:10px;justify-content:center">
                            <button class="btn" onclick="openModal('addListing')">+ Aggiungi Manualmente</button>
                            <a href="/seed-listings.html" target="_blank" class="btn btn-secondary">ğŸ“¥ Importa Esistenti</a>
                        </div>
                    </div>`}
                </div>
            </div>
            
            <div class="card" style="margin-top:20px">
                <div class="card-header"><h3 class="card-title">â„¹ï¸ Guida Rapida</h3></div>
                <div class="card-body">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;font-size:13px">
                        <div>
                            <strong style="color:var(--green)">ğŸŸ¢ Disponibile</strong>
                            <p style="color:var(--text-secondary);margin-top:5px">Visibile sul sito, pronto per affitto</p>
                        </div>
                        <div>
                            <strong style="color:var(--orange)">ğŸŸ¡ Waitlist</strong>
                            <p style="color:var(--text-secondary);margin-top:5px">Visibile come "Coming Soon"</p>
                        </div>
                        <div>
                            <strong style="color:var(--red)">ğŸ”´ Affittato</strong>
                            <p style="color:var(--text-secondary);margin-top:5px">Nascosto dal sito pubblico</p>
                        </div>
                        <div>
                            <strong style="color:var(--text-muted)">ğŸ“„ File</strong>
                            <p style="color:var(--text-secondary);margin-top:5px">Collega a pagina dettaglio (es: apartment_levico.html)</p>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    async function saveListing(e) {
        e.preventDefault();
        
        // Check if upload is still in progress
        if (uploadingImage) {
            return toast('warning', 'Attendi', 'Upload immagine in corso...');
        }
        
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));
        
        if (!data.name || !data.price) return toast('error', 'Nome e prezzo obbligatori');
        
        // Determine image URL: prefer uploaded (hidden input), then manual URL input
        const imageUrl = data.image || data.imageUrl || listingImageUrl || '';
        
        // Process tags from comma-separated string to array
        const tagsArray = data.tags ? data.tags.split(',').map(t => t.trim()).filter(t => t) : [];
        const featuresArray = data.features ? data.features.split(',').map(t => t.trim()).filter(t => t) : [];
        
        const listingData = {
            name: data.name,
            address: data.address || '',
            zone: data.zone || '',
            price: parseInt(data.price) || 0,
            type: data.type || 'Apartment',
            beds: data.beds || '',
            bedrooms: parseInt(data.bedrooms) || 1,
            size: data.size || '',
            sqm: parseInt(data.sqm) || null,
            floor: data.floor || '',
            image: imageUrl,
            tags: tagsArray,
            features: featuresArray,
            status: data.status || 'available',
            availableDate: data.availableDate || '',
            description: data.description || '',
            file: data.file || '',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (data.id) {
                await db.collection('listings').doc(data.id).update(listingData);
                toast('success', 'Listing aggiornato!', 'Visibile su boomrome.com');
            } else {
                listingData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                // Create new listing and get the document reference
                const docRef = await db.collection('listings').add(listingData);
                // If no custom file was set, auto-generate the detail page URL
                if (!listingData.file || listingData.file.trim() === '') {
                    await docRef.update({ file: 'apartment-detail.html?id=' + docRef.id });
                }
                toast('success', 'Listing creato!', 'Ora visibile su boomrome.com');
            }
            closeModal(); 
            await refresh();
        } catch (err) { 
            console.error('Save listing error:', err);
            toast('error', 'Errore salvataggio', err.message); 
        }
    }

    function editListing(id) {
        const l = S.listings.find(x => x.id === id);
        if (!l) return toast('error', 'Listing non trovato');
        openModal('editListing', l);
    }

    async function cycleListing(id, currentStatus) {
        // Cycle through: available -> waitlist -> rented -> available
        const statusCycle = { 'available': 'waitlist', 'waitlist': 'rented', 'rented': 'available' };
        const newStatus = statusCycle[currentStatus] || 'available';
        const statusLabels = { 'available': 'ğŸŸ¢ Disponibile', 'waitlist': 'ğŸŸ¡ Waitlist', 'rented': 'ğŸ”´ Affittato' };
        
        try {
            await db.collection('listings').doc(id).update({ 
                status: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await refresh();
            toast('success', 'Status aggiornato', statusLabels[newStatus]);
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function duplicateListing(id) {
        const l = S.listings.find(x => x.id === id);
        if (!l) return;
        
        try {
            const { id: _, createdAt, updatedAt, ...listingData } = l;
            await db.collection('listings').add({
                ...listingData,
                name: l.name + ' (copia)',
                status: 'rented', // Start as hidden
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await refresh();
            toast('success', 'Listing duplicato!', 'Modifica i dettagli');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // IMAGE UPLOAD SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let listingImageUrl = '';
    let uploadingImage = false;

    function initImageUpload() {
        const zone = document.getElementById('imageUploadZone');
        const input = document.getElementById('imageFileInput');
        if (!zone || !input) return;

        // Click to select file
        zone.addEventListener('click', () => input.click());

        // Drag & drop
        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('dragover');
        });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleImageSelect(files[0]);
        });

        // File input change
        input.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleImageSelect(e.target.files[0]);
        });
    }

    async function handleImageSelect(file) {
        // Validate file
        if (!file.type.startsWith('image/')) {
            return toast('error', 'File non valido', 'Seleziona un\'immagine (JPG, PNG, WebP)');
        }
        if (file.size > 10 * 1024 * 1024) {
            return toast('error', 'File troppo grande', 'Massimo 10MB');
        }

        const zone = document.getElementById('imageUploadZone');
        const preview = document.getElementById('imagePreview');
        const progress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const urlInput = document.getElementById('listingImageUrl');

        // Show uploading state
        zone.classList.add('uploading');
        progress.style.display = 'block';
        progressBar.style.width = '0%';
        progressText.textContent = 'Caricamento in corso...';
        uploadingImage = true;

        try {
            // Create unique filename
            const timestamp = Date.now();
            const safeName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
            const path = `listings/${timestamp}_${safeName}`;
            
            // Upload to Firebase Storage
            const ref = storage.ref(path);
            const uploadTask = ref.put(file);

            // Monitor progress
            uploadTask.on('state_changed', 
                (snapshot) => {
                    const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                    progressBar.style.width = pct + '%';
                    progressText.textContent = `Caricamento: ${pct}%`;
                },
                (error) => {
                    console.error('Upload error:', error);
                    toast('error', 'Errore upload', error.message);
                    zone.classList.remove('uploading');
                    progress.style.display = 'none';
                    uploadingImage = false;
                },
                async () => {
                    // Upload complete - get URL
                    const url = await uploadTask.snapshot.ref.getDownloadURL();
                    listingImageUrl = url;
                    
                    // Update UI
                    progressBar.style.width = '100%';
                    progressText.textContent = 'âœ“ Caricamento completato!';
                    
                    // Show preview
                    preview.innerHTML = `
                        <div class="image-preview">
                            <img src="${url}" alt="Preview">
                            <button type="button" class="remove-btn" onclick="removeListingImage()">Ã—</button>
                        </div>
                    `;
                    
                    // Update hidden input
                    if (urlInput) urlInput.value = url;
                    
                    zone.classList.remove('uploading');
                    uploadingImage = false;
                    
                    setTimeout(() => {
                        progress.style.display = 'none';
                    }, 2000);
                    
                    toast('success', 'Immagine caricata!');
                }
            );
        } catch (error) {
            console.error('Upload error:', error);
            toast('error', 'Errore upload', error.message);
            zone.classList.remove('uploading');
            progress.style.display = 'none';
            uploadingImage = false;
        }
    }

    function removeListingImage() {
        listingImageUrl = '';
        const preview = document.getElementById('imagePreview');
        const urlInput = document.getElementById('listingImageUrl');
        if (preview) preview.innerHTML = '';
        if (urlInput) urlInput.value = '';
        toast('info', 'Immagine rimossa');
    }

    function setExistingImage(url) {
        if (!url) return;
        listingImageUrl = url;
        const preview = document.getElementById('imagePreview');
        const urlInput = document.getElementById('listingImageUrl');
        if (preview) {
            preview.innerHTML = `
                <div class="image-preview">
                    <img src="${url}" alt="Preview">
                    <button type="button" class="remove-btn" onclick="removeListingImage()">Ã—</button>
                </div>
            `;
        }
        if (urlInput) urlInput.value = url;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MODALS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openModal(type, data) { 
        document.getElementById('modals').innerHTML = getModal(type, data); 
        setTimeout(() => {
            document.querySelector('.modal-overlay')?.classList.add('active');
            // Initialize image upload for listing modals
            if (type === 'addListing' || type === 'editListing') {
                listingImageUrl = '';
                initImageUpload();
                if (type === 'editListing' && data?.image) {
                    setExistingImage(data.image);
                }
            }
        }, 10); 
    }
    function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); setTimeout(() => { document.getElementById('modals').innerHTML = ''; selectedFile = null; listingImageUrl = ''; }, 200); }

    function getModal(type, data) {
        if (type === 'notifications') return `<div class="modal-overlay"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ”” Notifiche</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body">${S.notifications.map(n => `<div class="alert ${n.type} mb-8"><span class="alert-icon">${n.type === 'danger' ? 'âš ï¸' : 'ğŸ“‹'}</span><div class="alert-content"><div class="alert-title">${n.title}</div><div class="alert-text">${n.text}</div></div></div>`).join('')}</div><div class="modal-footer"><button class="btn" onclick="closeModal()">Chiudi</button></div></div></div>`;

        if (type === 'addClient') return `<div class="modal-overlay"><div class="modal lg"><div class="modal-header"><h3 class="modal-title">ğŸ’¼ Nuovo Cliente CRM</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="saveClient(event)"><div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="name" required></div><div class="form-group"><label class="form-label">Servizio *</label><select class="form-select" name="service" required><option value="PFS">ğŸ  PFS â‚¬350</option><option value="DAS">ğŸ“ DAS â‚¬249</option><option value="VV">ğŸ‘ï¸ VV â‚¬89</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Email *</label><input type="email" class="form-input" name="email" required></div><div class="form-group"><label class="form-label">Telefono</label><input type="tel" class="form-input" name="phone"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Budget â‚¬</label><input type="number" class="form-input" name="budget"></div><div class="form-group"><label class="form-label">Zona</label><input type="text" class="form-input" name="zone"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Data Arrivo</label><input type="date" class="form-input" name="arrivalDate"></div><div class="form-group"><label class="form-label">Durata</label><input type="text" class="form-input" name="duration" placeholder="6 mesi"></div></div><div class="form-group"><label class="form-label">Source</label><select class="form-select" name="source"><option value="google">Google</option><option value="instagram">Instagram</option><option value="referral">Referral</option><option value="website">Website</option><option value="other">Altro</option></select></div><div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes"></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Salva</button></div></div></div>`;

        if (type === 'addInvoice') { const num = 'BOOM-' + new Date().getFullYear() + '-' + String(S.invoices.length + 1).padStart(4, '0'); const landlords = S.users.filter(u => u.role === 'landlord'); const tenants = S.users.filter(u => u.role === 'tenant'); return `<div class="modal-overlay"><div class="modal lg"><div class="modal-header"><h3 class="modal-title">ğŸ§¾ Nuova Fattura</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="saveInvoice(event)"><div class="form-row"><div class="form-group"><label class="form-label">Numero</label><input type="text" class="form-input" name="number" value="${num}" readonly></div><div class="form-group"><label class="form-label">Data</label><input type="date" class="form-input" name="date" value="${new Date().toISOString().split('T')[0]}"></div></div><div class="form-group"><label class="form-label">Destinatario *</label><select class="form-select" name="recipientId" required><option value="">Seleziona...</option><optgroup label="ğŸ  Proprietari">${landlords.map(l => `<option value="${l.id}" data-type="landlord">${l.name}</option>`).join('')}</optgroup><optgroup label="ğŸ‘¤ Inquilini">${tenants.map(t => `<option value="${t.id}" data-type="tenant">${t.name}</option>`).join('')}</optgroup><optgroup label="ğŸ’¼ Clienti CRM">${S.clients.map(c => `<option value="${c.id}" data-type="client" data-service="${c.service}" data-price="${SERVICES[c.service]?.price || 0}">${c.name} (${c.service})</option>`).join('')}</optgroup></select></div><div class="form-row"><div class="form-group"><label class="form-label">Servizio/Descrizione *</label><input type="text" class="form-input" name="service" placeholder="Es: Gestione immobiliare, PFS, Commissione..." required></div><div class="form-group"><label class="form-label">Importo â‚¬ *</label><input type="number" class="form-input" name="amount" required></div></div><div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="description" rows="2" placeholder="Dettagli aggiuntivi..."></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Crea Fattura</button></div></div></div>`; }

        if (type === 'addDocument') return `<div class="modal-overlay"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ“ Carica Documento</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="saveDocument(event)"><div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="name" required></div><div class="form-group"><label class="form-label">Tipo</label><select class="form-select" name="type"><option value="contract">ğŸ“‹ Contratto</option><option value="id">ğŸªª Documento ID</option><option value="receipt">ğŸ§¾ Ricevuta</option><option value="utility">ğŸ’¡ Utenza</option><option value="other">ğŸ“„ Altro</option></select></div></div>${isAdmin() ? `<div class="form-group"><label class="form-label">Condividi con inquilino/proprietario</label><select class="form-select" name="shared"><option value="false">No - Solo io</option><option value="true">SÃ¬ - Condividi</option></select></div>` : ''}<div class="form-group"><label class="form-label">File</label><div class="file-zone" onclick="document.getElementById('fileInput').click()"><div class="file-zone-icon">ğŸ“</div><div class="file-zone-text">Clicca per selezionare</div></div><input type="file" id="fileInput" class="file-input" onchange="handleFile(this)"><div id="filePreview"></div></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Carica</button></div></div></div>`;

        if (type === 'addUser') return `<div class="modal-overlay"><div class="modal lg"><div class="modal-header"><h3 class="modal-title">ğŸ‘¥ Nuovo Utente</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="saveUser(event)"><div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="name" required></div><div class="form-group"><label class="form-label">Email *</label><input type="email" class="form-input" name="email" required></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ruolo</label><select class="form-select" name="role"><option value="tenant">ğŸ”‘ Inquilino</option><option value="landlord">ğŸ  Proprietario</option><option value="admin">ğŸ‘‘ Admin</option></select></div><div class="form-group"><label class="form-label">Password *</label><input type="password" class="form-input" name="password" required minlength="6"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Telefono</label><input type="tel" class="form-input" name="phone" placeholder="+39..."></div><div class="form-group"><label class="form-label">Codice Fiscale</label><input type="text" class="form-input" name="codiceFiscale" placeholder="RSSMRA85M01H501Z" maxlength="16" style="text-transform:uppercase"></div></div><div class="form-group"><label class="form-label">Indirizzo</label><input type="text" class="form-input" name="address" placeholder="Via Roma 123, 00100 Roma"></div><div class="form-group"><label class="form-label">IBAN</label><input type="text" class="form-input" name="iban" placeholder="IT60X0542811101000000123456"></div><div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes" rows="2" placeholder="Note interne..."></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Crea</button></div></div></div>`;

        if (type === 'editUser') { const u = data; if (!u) return ''; return `<div class="modal-overlay"><div class="modal lg"><div class="modal-header"><h3 class="modal-title">âœï¸ Modifica Utente</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="updateUser(event)"><input type="hidden" name="id" value="${u.id}"><div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="name" value="${u.name || ''}" required></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" value="${u.email || ''}" disabled style="opacity:0.6"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ruolo</label><select class="form-select" name="role"><option value="tenant" ${u.role === 'tenant' ? 'selected' : ''}>ğŸ”‘ Inquilino</option><option value="landlord" ${u.role === 'landlord' ? 'selected' : ''}>ğŸ  Proprietario</option><option value="admin" ${u.role === 'admin' ? 'selected' : ''}>ğŸ‘‘ Admin</option></select></div><div class="form-group"><label class="form-label">Telefono</label><input type="tel" class="form-input" name="phone" value="${u.phone || ''}" placeholder="+39..."></div></div><div class="form-row"><div class="form-group"><label class="form-label">Codice Fiscale</label><input type="text" class="form-input" name="codiceFiscale" value="${u.codiceFiscale || ''}" placeholder="RSSMRA85M01H501Z" maxlength="16" style="text-transform:uppercase"></div><div class="form-group"><label class="form-label">IBAN</label><input type="text" class="form-input" name="iban" value="${u.iban || ''}" placeholder="IT60X0542811101000000123456"></div></div><div class="form-group"><label class="form-label">Indirizzo</label><input type="text" class="form-input" name="address" value="${u.address || ''}" placeholder="Via Roma 123, 00100 Roma"></div><div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes" rows="2" placeholder="Note interne...">${u.notes || ''}</textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Salva</button></div></div></div>`; }

        if (type === 'addProperty') { const landlords = S.users.filter(u => u.role === 'landlord'); return `<div class="modal-overlay"><div class="modal lg"><div class="modal-header"><h3 class="modal-title">ğŸ  Nuovo Immobile</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="saveProperty(event)"><div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="name" required placeholder="Es: Trastevere Terrace"></div><div class="form-group"><label class="form-label">Proprietario *</label><select class="form-select" name="ownerId" required><option value="">Seleziona...</option>${landlords.map(l => `<option value="${l.id}">${l.name}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Indirizzo</label><input type="text" class="form-input" name="address" placeholder="Via Roma 123, 00100 Roma"></div><div class="form-row"><div class="form-group"><label class="form-label">Affitto â‚¬/mese *</label><input type="number" class="form-input" name="rent" required></div><div class="form-group"><label class="form-label">Superficie mÂ²</label><input type="number" class="form-input" name="sqm" placeholder="65"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Stanze</label><input type="number" class="form-input" name="rooms" placeholder="3"></div><div class="form-group"><label class="form-label">Bagni</label><input type="number" class="form-input" name="bathrooms" placeholder="1"></div><div class="form-group"><label class="form-label">Piano</label><input type="text" class="form-input" name="floor" placeholder="3Â° / 5"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Anno Costruzione</label><input type="number" class="form-input" name="yearBuilt" placeholder="1965"></div><div class="form-group"><label class="form-label">Tipo</label><select class="form-select" name="propertyType"><option value="apartment">Appartamento</option><option value="studio">Monolocale</option><option value="room">Stanza</option><option value="house">Casa</option><option value="loft">Loft</option></select></div></div><div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes" rows="2" placeholder="Caratteristiche, condizioni..."></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Crea</button></div></div></div>`; }

        if (type === 'editProperty') { const p = data; if (!p) return ''; const landlords = S.users.filter(u => u.role === 'landlord'); return `<div class="modal-overlay"><div class="modal lg"><div class="modal-header"><h3 class="modal-title">âœï¸ Modifica Immobile</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="updateProperty(event,'${p.id}')"><div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="name" value="${p.name || ''}" required></div><div class="form-group"><label class="form-label">Proprietario *</label><select class="form-select" name="ownerId" required><option value="">Seleziona...</option>${landlords.map(l => `<option value="${l.id}" ${p.ownerId === l.id ? 'selected' : ''}>${l.name}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Indirizzo</label><input type="text" class="form-input" name="address" value="${p.address || ''}"></div><div class="form-row"><div class="form-group"><label class="form-label">Affitto â‚¬/mese *</label><input type="number" class="form-input" name="rent" value="${p.rent || ''}" required></div><div class="form-group"><label class="form-label">Superficie mÂ²</label><input type="number" class="form-input" name="sqm" value="${p.sqm || ''}"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Stanze</label><input type="number" class="form-input" name="rooms" value="${p.rooms || ''}"></div><div class="form-group"><label class="form-label">Bagni</label><input type="number" class="form-input" name="bathrooms" value="${p.bathrooms || ''}"></div><div class="form-group"><label class="form-label">Piano</label><input type="text" class="form-input" name="floor" value="${p.floor || ''}"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Anno Costruzione</label><input type="number" class="form-input" name="yearBuilt" value="${p.yearBuilt || ''}"></div><div class="form-group"><label class="form-label">Tipo</label><select class="form-select" name="propertyType"><option value="apartment" ${p.propertyType === 'apartment' || !p.propertyType ? 'selected' : ''}>Appartamento</option><option value="studio" ${p.propertyType === 'studio' ? 'selected' : ''}>Monolocale</option><option value="room" ${p.propertyType === 'room' ? 'selected' : ''}>Stanza</option><option value="house" ${p.propertyType === 'house' ? 'selected' : ''}>Casa</option><option value="loft" ${p.propertyType === 'loft' ? 'selected' : ''}>Loft</option></select></div></div><div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes" rows="2">${p.notes || ''}</textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Salva</button></div></div></div>`; }

        if (type === 'addContract') { const tenants = S.users.filter(u => u.role === 'tenant'); const props = S.properties.filter(p => !S.contracts.some(c => c.propertyId === p.id && c.status === 'active')); return `<div class="modal-overlay"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ“‹ Nuovo Contratto</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="saveContract(event)"><div class="form-row"><div class="form-group"><label class="form-label">Immobile *</label><select class="form-select" name="propertyId" required onchange="fillContractRent(this)"><option value="">Seleziona...</option>${props.map(p => `<option value="${p.id}" data-rent="${p.rent}">${p.name} â‚¬${p.rent}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Inquilino *</label><select class="form-select" name="tenantId" required><option value="">Seleziona...</option>${tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Inizio *</label><input type="date" class="form-input" name="startDate" required></div><div class="form-group"><label class="form-label">Fine *</label><input type="date" class="form-input" name="endDate" required></div></div><div class="form-row"><div class="form-group"><label class="form-label">Affitto â‚¬ *</label><input type="number" class="form-input" name="rent" id="cRent" required></div><div class="form-group"><label class="form-label">Deposito â‚¬</label><input type="number" class="form-input" name="deposit"></div></div><div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes" rows="2" placeholder="Condizioni particolari..."></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Crea</button></div></div></div>`; }

        if (type === 'editContract') { const c = data; if (!c) return ''; const tenants = S.users.filter(u => u.role === 'tenant'); const props = S.properties; return `<div class="modal-overlay"><div class="modal"><div class="modal-header"><h3 class="modal-title">âœï¸ Modifica Contratto</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="updateContract(event,'${c.id}')"><div class="form-row"><div class="form-group"><label class="form-label">Immobile</label><select class="form-select" name="propertyId">${props.map(p => `<option value="${p.id}" ${c.propertyId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Inquilino</label><select class="form-select" name="tenantId">${tenants.map(t => `<option value="${t.id}" ${c.tenantId === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Inizio</label><input type="date" class="form-input" name="startDate" value="${c.startDate || ''}"></div><div class="form-group"><label class="form-label">Fine</label><input type="date" class="form-input" name="endDate" value="${c.endDate || ''}"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Affitto â‚¬</label><input type="number" class="form-input" name="rent" value="${c.rent || ''}"></div><div class="form-group"><label class="form-label">Deposito â‚¬</label><input type="number" class="form-input" name="deposit" value="${c.deposit || ''}"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Stato</label><select class="form-select" name="status"><option value="active" ${c.status === 'active' ? 'selected' : ''}>Attivo</option><option value="expired" ${c.status === 'expired' ? 'selected' : ''}>Scaduto</option><option value="terminated" ${c.status === 'terminated' ? 'selected' : ''}>Terminato</option></select></div></div><div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes" rows="2">${c.notes || ''}</textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Salva</button></div></div></div>`; }

        if (type === 'renewContract') { const c = data; if (!c) return ''; const p = S.properties.find(x => x.id === c.propertyId); const currentEnd = c.endDate ? new Date(c.endDate) : new Date(); const newEnd = new Date(currentEnd); newEnd.setFullYear(newEnd.getFullYear() + 1); return `<div class="modal-overlay"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ”„ Rinnova Contratto</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><div style="background:var(--surface);padding:16px;border-radius:8px;margin-bottom:16px"><div style="font-weight:600;margin-bottom:8px">${p?.name || 'Immobile'}</div><div style="font-size:13px;color:var(--text-muted)">Scadenza attuale: ${fmtDate(c.endDate)}</div></div><form id="mForm" onsubmit="renewContract(event,'${c.id}')"><div class="form-group"><label class="form-label">Nuova Data Fine *</label><input type="date" class="form-input" name="newEndDate" value="${newEnd.toISOString().split('T')[0]}" required></div><div class="form-row"><div class="form-group"><label class="form-label">Nuovo Affitto â‚¬</label><input type="number" class="form-input" name="newRent" value="${c.rent || ''}" placeholder="Lascia vuoto per mantenere"></div><div class="form-group"><label class="form-label">Adeguamento %</label><input type="number" class="form-input" name="adjustment" placeholder="Es: 2 per +2%"></div></div><div class="form-group"><label class="form-label">Note Rinnovo</label><textarea class="form-textarea" name="renewalNotes" rows="2" placeholder="Es: Rinnovo annuale con adeguamento ISTAT..."></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">ğŸ”„ Rinnova</button></div></div></div>`; }

        if (type === 'terminateContract') { const c = data; if (!c) return ''; const p = S.properties.find(x => x.id === c.propertyId); const t = S.users.find(x => x.id === c.tenantId); return `<div class="modal-overlay"><div class="modal"><div class="modal-header"><h3 class="modal-title">â›” Termina Contratto</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><div style="background:var(--red-light);padding:16px;border-radius:8px;margin-bottom:16px;border:1px solid var(--red)"><div style="font-weight:600;color:var(--red);margin-bottom:8px">âš ï¸ Attenzione</div><div style="font-size:13px">Stai per terminare anticipatamente il contratto per <strong>${p?.name}</strong> con <strong>${t?.name}</strong>.</div></div><form id="mForm" onsubmit="terminateContract(event,'${c.id}')"><div class="form-group"><label class="form-label">Data Termine Effettivo *</label><input type="date" class="form-input" name="terminationDate" value="${new Date().toISOString().split('T')[0]}" required></div><div class="form-group"><label class="form-label">Motivo Termine</label><select class="form-select" name="terminationReason"><option value="mutual">Accordo reciproco</option><option value="tenant_request">Richiesta inquilino</option><option value="landlord_request">Richiesta proprietario</option><option value="breach">Violazione contrattuale</option><option value="other">Altro</option></select></div><div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="terminationNotes" rows="2" placeholder="Dettagli sulla chiusura..."></textarea></div><div class="form-row"><div class="form-group"><label class="form-label">Deposito Restituito â‚¬</label><input type="number" class="form-input" name="depositReturned" value="${c.deposit || 0}"></div><div class="form-group"><label class="form-label">Trattenute â‚¬</label><input type="number" class="form-input" name="depositWithheld" value="0"></div></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn btn-danger" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">â›” Termina</button></div></div></div>`; }

        if (type === 'addPayment') { const contracts = S.contracts.filter(c => c.status === 'active'); return `<div class="modal-overlay"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ’³ Registra Pagamento</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="savePayment(event)"><div class="form-group"><label class="form-label">Contratto *</label><select class="form-select" name="contractId" required onchange="fillPayAmount(this)"><option value="">Seleziona...</option>${contracts.map(c => { const p = S.properties.find(x => x.id === c.propertyId); const t = S.users.find(x => x.id === c.tenantId); return `<option value="${c.id}" data-rent="${c.rent}">${p?.name} - ${t?.name} â‚¬${c.rent}</option>`; }).join('')}</select></div><div class="form-row"><div class="form-group"><label class="form-label">Mese</label><input type="month" class="form-input" name="month" value="${new Date().toISOString().slice(0, 7)}"></div><div class="form-group"><label class="form-label">Importo â‚¬ *</label><input type="number" class="form-input" name="amount" id="pAmount" required></div></div><div class="form-row"><div class="form-group"><label class="form-label">Scadenza</label><input type="date" class="form-input" name="dueDate" value="${new Date(new Date().getFullYear(), new Date().getMonth() + 1, 5).toISOString().split('T')[0]}"></div><div class="form-group"><label class="form-label">Stato</label><select class="form-select" name="status"><option value="pending">In Attesa</option><option value="paid">Pagato</option></select></div></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Registra</button></div></div></div>`; }

        if (type === 'editPayment') { const pay = data; if (!pay) return ''; const contracts = S.contracts; return `<div class="modal-overlay"><div class="modal"><div class="modal-header"><h3 class="modal-title">âœï¸ Modifica Pagamento</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="updatePayment(event,'${pay.id}')"><div class="form-group"><label class="form-label">Contratto</label><select class="form-select" name="contractId">${contracts.map(c => { const p = S.properties.find(x => x.id === c.propertyId); return `<option value="${c.id}" ${pay.contractId === c.id ? 'selected' : ''}>${p?.name}</option>`; }).join('')}</select></div><div class="form-row"><div class="form-group"><label class="form-label">Mese</label><input type="month" class="form-input" name="month" value="${pay.month || ''}"></div><div class="form-group"><label class="form-label">Importo â‚¬</label><input type="number" class="form-input" name="amount" value="${pay.amount || ''}"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Scadenza</label><input type="date" class="form-input" name="dueDate" value="${pay.dueDate || ''}"></div><div class="form-group"><label class="form-label">Stato</label><select class="form-select" name="status"><option value="pending" ${pay.status === 'pending' ? 'selected' : ''}>In Attesa</option><option value="paid" ${pay.status === 'paid' ? 'selected' : ''}>Pagato</option></select></div></div><div class="form-group"><label class="form-label">Data Pagamento</label><input type="date" class="form-input" name="paidDate" value="${pay.paidDate ? pay.paidDate.split('T')[0] : ''}"></div><div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes" rows="2">${pay.notes || ''}</textarea></div></form></div><div class="modal-footer"><button class="btn btn-danger btn-sm" onclick="confirmDelete('payment','${pay.id}','Pagamento ${pay.month}')">ğŸ—‘</button><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Salva</button></div></div></div>`; }

        if (type === 'bulkPayments') { const contracts = S.contracts.filter(c => c.status === 'active'); return `<div class="modal-overlay"><div class="modal lg"><div class="modal-header"><h3 class="modal-title">ğŸ“… Genera Pagamenti Multipli</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="generateBulkPayments(event)"><div class="form-group"><label class="form-label">Contratto *</label><select class="form-select" name="contractId" required><option value="">Seleziona...</option>${contracts.map(c => { const p = S.properties.find(x => x.id === c.propertyId); const t = S.users.find(x => x.id === c.tenantId); return `<option value="${c.id}" data-rent="${c.rent}">${p?.name} - ${t?.name} â‚¬${c.rent}</option>`; }).join('')}</select></div><div class="form-row"><div class="form-group"><label class="form-label">Da Mese *</label><input type="month" class="form-input" name="startMonth" value="${new Date().toISOString().slice(0, 7)}" required></div><div class="form-group"><label class="form-label">Numero Mesi *</label><select class="form-select" name="numMonths"><option value="3">3 mesi</option><option value="6">6 mesi</option><option value="12" selected>12 mesi (1 anno)</option><option value="24">24 mesi (2 anni)</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Giorno Scadenza</label><input type="number" class="form-input" name="dueDay" value="5" min="1" max="28"></div><div class="form-group"><label class="form-label">Importo â‚¬ (vuoto = da contratto)</label><input type="number" class="form-input" name="amount" placeholder="Auto"></div></div></form><div style="background:var(--surface);padding:12px;border-radius:8px;margin-top:16px;font-size:12px;color:var(--text-muted)">ğŸ’¡ Verranno generati pagamenti mensili con stato "In Attesa". I mesi giÃ  esistenti verranno saltati.</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">ğŸ“… Genera</button></div></div></div>`; }

        if (type === 'addMaintenance') return `<div class="modal-overlay"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ”§ Nuova Manutenzione</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="saveMaintenance(event)"><div class="form-group"><label class="form-label">Titolo *</label><input type="text" class="form-input" name="title" required></div><div class="form-group"><label class="form-label">Immobile *</label><select class="form-select" name="propertyId" required><option value="">Seleziona...</option>${S.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select></div><div class="form-row"><div class="form-group"><label class="form-label">Categoria</label><select class="form-select" name="category"><option value="plumbing">Idraulica</option><option value="electrical">ElettricitÃ </option><option value="heating">Riscaldamento</option><option value="other">Altro</option></select></div><div class="form-group"><label class="form-label">PrioritÃ </label><select class="form-select" name="priority"><option value="low">Bassa</option><option value="medium" selected>Media</option><option value="high">Alta</option><option value="urgent">Urgente</option></select></div></div><div class="form-group"><label class="form-label">Descrizione</label><textarea class="form-textarea" name="description"></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Invia</button></div></div></div>`;

        if (type === 'editMaintenance') { const m = data; if (!m) return ''; return `<div class="modal-overlay"><div class="modal"><div class="modal-header"><h3 class="modal-title">âœï¸ Modifica Manutenzione</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="updateMaintenance(event,'${m.id}')"><div class="form-group"><label class="form-label">Titolo *</label><input type="text" class="form-input" name="title" value="${m.title || ''}" required></div><div class="form-group"><label class="form-label">Immobile</label><select class="form-select" name="propertyId">${S.properties.map(p => `<option value="${p.id}" ${m.propertyId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}</select></div><div class="form-row"><div class="form-group"><label class="form-label">Categoria</label><select class="form-select" name="category"><option value="plumbing" ${m.category === 'plumbing' ? 'selected' : ''}>Idraulica</option><option value="electrical" ${m.category === 'electrical' ? 'selected' : ''}>ElettricitÃ </option><option value="heating" ${m.category === 'heating' ? 'selected' : ''}>Riscaldamento</option><option value="appliance" ${m.category === 'appliance' ? 'selected' : ''}>Elettrodomestici</option><option value="other" ${m.category === 'other' ? 'selected' : ''}>Altro</option></select></div><div class="form-group"><label class="form-label">PrioritÃ </label><select class="form-select" name="priority"><option value="low" ${m.priority === 'low' ? 'selected' : ''}>Bassa</option><option value="medium" ${m.priority === 'medium' ? 'selected' : ''}>Media</option><option value="high" ${m.priority === 'high' ? 'selected' : ''}>Alta</option><option value="urgent" ${m.priority === 'urgent' ? 'selected' : ''}>Urgente</option></select></div></div><div class="form-group"><label class="form-label">Stato</label><select class="form-select" name="status"><option value="pending" ${m.status === 'pending' ? 'selected' : ''}>ğŸŸ¡ In Attesa</option><option value="in_progress" ${m.status === 'in_progress' ? 'selected' : ''}>ğŸ”µ In Corso</option><option value="resolved" ${m.status === 'resolved' ? 'selected' : ''}>ğŸŸ¢ Risolto</option></select></div><div class="form-group"><label class="form-label">Descrizione</label><textarea class="form-textarea" name="description" rows="3">${m.description || ''}</textarea></div><div class="form-row"><div class="form-group"><label class="form-label">Costo â‚¬</label><input type="number" class="form-input" name="cost" value="${m.cost || ''}"></div><div class="form-group"><label class="form-label">Tecnico/Fornitore</label><input type="text" class="form-input" name="technician" value="${m.technician || ''}"></div></div><div class="form-group"><label class="form-label">Note Risoluzione</label><textarea class="form-textarea" name="resolutionNotes" rows="2">${m.resolutionNotes || ''}</textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Salva</button></div></div></div>`; }

        if (type === 'addTenantMaintenance') { const myContract = getMyContracts().find(c => c.status === 'active'); const myProp = myContract ? S.properties.find(p => p.id === myContract.propertyId) : null; return `<div class="modal-overlay"><div class="modal"><div class="modal-header"><h3 class="modal-title">ğŸ”§ Richiedi Manutenzione</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body"><form id="mForm" onsubmit="saveTenantMaintenance(event)"><div class="form-group"><label class="form-label">Immobile</label><input type="text" class="form-input" value="${myProp?.name || 'N/A'}" readonly><input type="hidden" name="propertyId" value="${myProp?.id || ''}"></div><div class="form-group"><label class="form-label">Titolo *</label><input type="text" class="form-input" name="title" required placeholder="Es: Rubinetto perde"></div><div class="form-row"><div class="form-group"><label class="form-label">Categoria</label><select class="form-select" name="category"><option value="plumbing">Idraulica</option><option value="electrical">ElettricitÃ </option><option value="heating">Riscaldamento</option><option value="appliance">Elettrodomestici</option><option value="other">Altro</option></select></div><div class="form-group"><label class="form-label">Urgenza</label><select class="form-select" name="priority"><option value="low">Non urgente</option><option value="medium" selected>Normale</option><option value="high">Urgente</option></select></div></div><div class="form-group"><label class="form-label">Descrizione</label><textarea class="form-textarea" name="description" placeholder="Descrivi il problema in dettaglio..."></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">Invia Richiesta</button></div></div></div>`; }

        if (type === 'confirm') return `<div class="modal-overlay"><div class="modal" style="max-width:400px"><div class="modal-body"><div class="confirm-modal"><div class="confirm-icon">${data.icon || 'âš ï¸'}</div><h3 class="confirm-title">${data.title}</h3><p class="confirm-text">${data.text}</p><div style="display:flex;gap:10px;justify-content:center"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn ${data.danger ? 'btn-danger' : ''}" onclick="${data.action}">${data.btnText || 'Conferma'}</button></div></div></div></div></div>`;

        // LISTING MODALS - Complete fields for website sync
        if (type === 'addListing') return `<div class="modal-overlay"><div class="modal xl" style="max-width:700px"><div class="modal-header"><h3 class="modal-title">ğŸ¢ Nuovo Appartamento</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body" style="max-height:70vh;overflow-y:auto"><form id="mForm" onsubmit="saveListing(event)">
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ“ Informazioni Base</h4>
                <div class="form-row"><div class="form-group"><label class="form-label">Nome Appartamento *</label><input type="text" class="form-input" name="name" required placeholder="Es: Levico Garden"></div><div class="form-group"><label class="form-label">Tipo *</label><input type="text" class="form-input" name="type" placeholder="Es: Garden Floor, Attic, Loft"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Indirizzo</label><input type="text" class="form-input" name="address" placeholder="Via Levico 15, Trieste"></div><div class="form-group"><label class="form-label">Zona *</label><input type="text" class="form-input" name="zone" required placeholder="Es: Trieste, Trastevere, Centro"></div></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ’° Prezzo & DisponibilitÃ </h4>
                <div class="form-row"><div class="form-group"><label class="form-label">Prezzo â‚¬/mese *</label><input type="number" class="form-input" name="price" required placeholder="1200"></div><div class="form-group"><label class="form-label">Status *</label><select class="form-select" name="status"><option value="available">ğŸŸ¢ Disponibile</option><option value="waitlist">ğŸŸ¡ Waitlist</option><option value="rented">ğŸ”´ Affittato</option></select></div></div>
                <div class="form-group"><label class="form-label">Disponibile da</label><input type="text" class="form-input" name="availableDate" placeholder="Es: Feb 1, Sep 2026, Immediate"></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ  Caratteristiche</h4>
                <div class="form-row"><div class="form-group"><label class="form-label">Camere da Letto</label><input type="number" class="form-input" name="bedrooms" value="1" min="0"></div><div class="form-group"><label class="form-label">Configurazione Letti</label><input type="text" class="form-input" name="beds" placeholder="Es: 1 Bedroom, 2BR, 1 Room in 3BR"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Superficie mÂ²</label><input type="number" class="form-input" name="sqm" placeholder="65"></div><div class="form-group"><label class="form-label">Formato Superficie</label><input type="text" class="form-input" name="size" placeholder="Es: 65mÂ², 110mÂ²"></div></div>
                <div class="form-group"><label class="form-label">Piano</label><input type="text" class="form-input" name="floor" placeholder="Es: 2nd Floor, Ground Floor, 5th Floor"></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ·ï¸ Tags & Features</h4>
                <div class="form-group"><label class="form-label">Tags (separati da virgola)</label><input type="text" class="form-input" name="tags" placeholder="All Inclusive, Balcony, AC, WiFi, Central"></div>
                <div class="form-group"><label class="form-label">Features (separati da virgola)</label><input type="text" class="form-input" name="features" placeholder="Balcone, Aria Condizionata, Lavatrice, WiFi"></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ“· Immagine Principale</h4>
                <div class="image-upload-zone" id="imageUploadZone">
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">Trascina un'immagine qui o clicca per selezionare</div>
                    <div class="upload-hint">JPG, PNG, WebP â€¢ Max 10MB</div>
                </div>
                <input type="file" id="imageFileInput" accept="image/*" style="display:none">
                <div class="upload-progress" id="uploadProgress" style="display:none">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                    <div class="progress-text" id="progressText">Caricamento...</div>
                </div>
                <div id="imagePreview"></div>
                <input type="hidden" name="image" id="listingImageUrl">
                <div class="form-group" style="margin-top:12px;margin-bottom:0"><label class="form-label">Oppure incolla URL immagine</label><input type="url" class="form-input" name="imageUrl" placeholder="https://i.imgur.com/..." onchange="if(this.value){document.getElementById('listingImageUrl').value=this.value}"></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ”— Link</h4>
                <div class="form-group" style="margin-bottom:0"><label class="form-label">File Pagina Dettaglio</label><input type="text" class="form-input" name="file" placeholder="Es: apartment_levico.html (opzionale)"></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ“ Descrizione</h4>
                <div class="form-group" style="margin-bottom:0"><label class="form-label">Descrizione Appartamento</label><textarea class="form-textarea" name="description" rows="3" placeholder="Descrizione dettagliata dell'appartamento..."></textarea></div>
            </div>
        </form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">ğŸ’¾ Salva & Pubblica</button></div></div></div>`;

        if (type === 'editListing') { 
            const tagsStr = Array.isArray(data.tags) ? data.tags.join(', ') : (data.tags || '');
            const featuresStr = Array.isArray(data.features) ? data.features.join(', ') : (data.features || '');
            return `<div class="modal-overlay"><div class="modal xl" style="max-width:700px"><div class="modal-header"><h3 class="modal-title">âœï¸ Modifica: ${data.name || 'Appartamento'}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body" style="max-height:70vh;overflow-y:auto"><form id="mForm" onsubmit="saveListing(event)">
            <input type="hidden" name="id" value="${data.id}">
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ“ Informazioni Base</h4>
                <div class="form-row"><div class="form-group"><label class="form-label">Nome Appartamento *</label><input type="text" class="form-input" name="name" value="${data.name || ''}" required></div><div class="form-group"><label class="form-label">Tipo</label><input type="text" class="form-input" name="type" value="${data.type || ''}"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Indirizzo</label><input type="text" class="form-input" name="address" value="${data.address || ''}"></div><div class="form-group"><label class="form-label">Zona *</label><input type="text" class="form-input" name="zone" value="${data.zone || ''}" required></div></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ’° Prezzo & DisponibilitÃ </h4>
                <div class="form-row"><div class="form-group"><label class="form-label">Prezzo â‚¬/mese *</label><input type="number" class="form-input" name="price" value="${data.price || ''}" required></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" name="status"><option value="available" ${data.status === 'available' ? 'selected' : ''}>ğŸŸ¢ Disponibile</option><option value="waitlist" ${data.status === 'waitlist' ? 'selected' : ''}>ğŸŸ¡ Waitlist</option><option value="rented" ${data.status === 'rented' ? 'selected' : ''}>ğŸ”´ Affittato</option></select></div></div>
                <div class="form-group"><label class="form-label">Disponibile da</label><input type="text" class="form-input" name="availableDate" value="${data.availableDate || ''}"></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ  Caratteristiche</h4>
                <div class="form-row"><div class="form-group"><label class="form-label">Camere</label><input type="number" class="form-input" name="bedrooms" value="${data.bedrooms || 1}" min="0"></div><div class="form-group"><label class="form-label">Config. Letti</label><input type="text" class="form-input" name="beds" value="${data.beds || ''}"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Superficie mÂ²</label><input type="number" class="form-input" name="sqm" value="${data.sqm || ''}"></div><div class="form-group"><label class="form-label">Formato</label><input type="text" class="form-input" name="size" value="${data.size || ''}"></div></div>
                <div class="form-group"><label class="form-label">Piano</label><input type="text" class="form-input" name="floor" value="${data.floor || ''}"></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ·ï¸ Tags & Features</h4>
                <div class="form-group"><label class="form-label">Tags</label><input type="text" class="form-input" name="tags" value="${tagsStr}"></div>
                <div class="form-group"><label class="form-label">Features</label><input type="text" class="form-input" name="features" value="${featuresStr}"></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ“· Immagine Principale</h4>
                <div class="image-upload-zone" id="imageUploadZone">
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">Trascina una nuova immagine o clicca per cambiare</div>
                    <div class="upload-hint">JPG, PNG, WebP â€¢ Max 10MB</div>
                </div>
                <input type="file" id="imageFileInput" accept="image/*" style="display:none">
                <div class="upload-progress" id="uploadProgress" style="display:none">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                    <div class="progress-text" id="progressText">Caricamento...</div>
                </div>
                <div id="imagePreview"></div>
                <input type="hidden" name="image" id="listingImageUrl" value="${data.image || ''}">
                <div class="form-group" style="margin-top:12px;margin-bottom:0"><label class="form-label">Oppure incolla URL immagine</label><input type="url" class="form-input" name="imageUrl" value="${data.image || ''}" placeholder="https://i.imgur.com/..." onchange="if(this.value){document.getElementById('listingImageUrl').value=this.value}"></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ”— Link</h4>
                <div class="form-group" style="margin-bottom:0"><label class="form-label">File Pagina Dettaglio</label><input type="text" class="form-input" name="file" value="${data.file || ''}"></div>
            </div>
            <div style="background:var(--bg);padding:16px;border-radius:8px">
                <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:1px">ğŸ“ Descrizione</h4>
                <div class="form-group" style="margin-bottom:0"><textarea class="form-textarea" name="description" rows="3">${data.description || ''}</textarea></div>
            </div>
        </form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="document.getElementById('mForm').dispatchEvent(new Event('submit'))">ğŸ’¾ Salva Modifiche</button></div></div></div>`;
        }

        return '';
    }

    function updateInvAmount(sel) { const opt = sel.options[sel.selectedIndex]; document.getElementById('invService').value = opt.dataset.service || ''; document.getElementById('invAmount').value = opt.dataset.price || ''; }
    function fillContractRent(sel) { document.getElementById('cRent').value = sel.options[sel.selectedIndex].dataset.rent || ''; }
    function fillPayAmount(sel) { document.getElementById('pAmount').value = sel.options[sel.selectedIndex].dataset.rent || ''; }
    function handleFile(input) { const file = input.files[0]; if (!file) return; if (file.size > 10*1024*1024) { toast('error', 'File troppo grande (max 10MB)'); return; } selectedFile = file; document.getElementById('filePreview').innerHTML = `<div class="file-preview"><span>ğŸ“„</span><div style="flex:1"><div>${file.name}</div><div style="font-size:11px;color:var(--text-muted)">${(file.size/1024).toFixed(1)} KB</div></div></div>`; }

    function confirmDelete(type, id, name) { openModal('confirm', { icon: 'ğŸ—‘', title: 'Eliminare?', text: `Sei sicuro di voler eliminare "${name}"? Questa azione non puÃ² essere annullata.`, action: `deleteRecord('${type}','${id}')`, btnText: 'Elimina', danger: true }); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CRUD OPERATIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function saveClient(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        if (!data.name || !data.email || !data.service) return toast('error', 'Compila i campi obbligatori');
        try {
            await db.collection('clients').add({
                name: data.name, email: data.email, phone: data.phone || '', service: data.service,
                budget: parseInt(data.budget) || 0, zone: data.zone || '', arrivalDate: data.arrivalDate || null,
                duration: data.duration || '', source: data.source || 'other', notes: data.notes || '',
                stage: 'lead', contractGenerated: false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Cliente salvato!', data.name);
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function saveInvoice(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        if (!data.recipientId || !data.amount || !data.service) return toast('error', 'Compila i campi obbligatori');
        
        // Determine recipient type and name
        let recipientType = 'client';
        let recipientName = '';
        const landlord = S.users.find(u => u.id === data.recipientId && u.role === 'landlord');
        const tenant = S.users.find(u => u.id === data.recipientId && u.role === 'tenant');
        const client = S.clients.find(c => c.id === data.recipientId);
        
        if (landlord) { recipientType = 'landlord'; recipientName = landlord.name; }
        else if (tenant) { recipientType = 'tenant'; recipientName = tenant.name; }
        else if (client) { recipientType = 'client'; recipientName = client.name; }
        
        try {
            await db.collection('invoices').add({
                number: data.number, 
                recipientId: data.recipientId,
                recipientType,
                recipientName,
                clientId: data.recipientId, // Backward compatibility
                service: data.service || '', 
                amount: parseInt(data.amount) || 0,
                date: data.date || new Date().toISOString().split('T')[0],
                description: data.description || '', 
                status: 'pending', 
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Fattura creata!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function saveDocument(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        if (!data.name) return toast('error', 'Inserisci nome');
        try {
            let fileUrl = null, fileName = null, fileSize = null;
            if (selectedFile) {
                toast('info', 'Caricamento file...');
                const path = `documents/${S.profile.id}/${Date.now()}_${selectedFile.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                const uploadTask = await storage.ref(path).put(selectedFile);
                fileUrl = await uploadTask.ref.getDownloadURL();
                fileName = selectedFile.name;
                fileSize = selectedFile.size;
            }
            await db.collection('documents').add({
                name: data.name, type: data.type || 'other', userId: S.profile.id,
                shared: data.shared === 'true', propertyId: data.propertyId || null,
                fileUrl, fileName, fileSize, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); selectedFile = null; await refresh(); toast('success', 'Documento salvato!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function saveUser(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
            const cred = await auth.createUserWithEmailAndPassword(data.email, data.password);
            await db.collection('users').doc(cred.user.uid).set({
                name: data.name, 
                email: data.email, 
                role: data.role || 'tenant', 
                phone: data.phone || '',
                codiceFiscale: data.codiceFiscale?.toUpperCase() || '',
                address: data.address || '',
                iban: data.iban?.toUpperCase() || '',
                notes: data.notes || '',
                documents: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Utente creato!', data.name);
        } catch (err) { toast('error', 'Errore', authErr(err.code)); }
    }

    async function updateUser(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        const userId = data.id;
        if (!userId) { toast('error', 'ID utente mancante'); return; }
        try {
            await db.collection('users').doc(userId).update({
                name: data.name,
                phone: data.phone || '',
                codiceFiscale: data.codiceFiscale?.toUpperCase() || '',
                address: data.address || '',
                iban: data.iban?.toUpperCase() || '',
                notes: data.notes || '',
                role: data.role,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Utente aggiornato!', data.name);
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function saveProperty(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
            await db.collection('properties').add({
                name: data.name, 
                address: data.address || '', 
                ownerId: data.ownerId,
                rent: parseInt(data.rent) || 0, 
                sqm: parseInt(data.sqm) || null,
                rooms: parseInt(data.rooms) || null,
                bathrooms: parseInt(data.bathrooms) || null,
                floor: data.floor || '',
                yearBuilt: parseInt(data.yearBuilt) || null,
                propertyType: data.propertyType || 'apartment',
                notes: data.notes || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Immobile creato!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function saveContract(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
            await db.collection('contracts').add({
                propertyId: data.propertyId, 
                tenantId: data.tenantId,
                startDate: data.startDate, 
                endDate: data.endDate,
                rent: parseInt(data.rent) || 0, 
                deposit: parseInt(data.deposit) || 0,
                notes: data.notes || '',
                status: 'active', 
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Contratto creato!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function savePayment(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
            await db.collection('payments').add({
                contractId: data.contractId, month: data.month || '', amount: parseInt(data.amount) || 0,
                dueDate: data.dueDate || null, status: data.status || 'pending',
                paidDate: data.status === 'paid' ? new Date().toISOString() : null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Pagamento registrato!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function markPaymentPaid(id) {
        try {
            const payment = S.payments.find(p => p.id === id);
            await db.collection('payments').doc(id).update({ status: 'paid', paidDate: new Date().toISOString() });
            // Notify landlord of payment received
            if (payment) {
                await notifyPaymentReceived({ id, ...payment });
            }
            await refresh(); toast('success', 'Pagamento confermato âœ“');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function saveMaintenance(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
            await db.collection('maintenance').add({
                title: data.title, propertyId: data.propertyId, category: data.category || 'other',
                priority: data.priority || 'medium', description: data.description || '',
                userId: S.profile.id, status: 'open', createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Richiesta inviata!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function saveTenantMaintenance(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        if (!data.propertyId) return toast('error', 'Nessun immobile associato');
        try {
            const docRef = await db.collection('maintenance').add({
                title: data.title, propertyId: data.propertyId, category: data.category || 'other',
                priority: data.priority || 'medium', description: data.description || '',
                userId: S.profile.id, status: 'open', createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // Notify landlord
            await notifyMaintenanceRequest({ id: docRef.id, ...data, userId: S.profile.id });
            closeModal(); await refresh(); toast('success', 'Richiesta inviata!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UPDATE FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function updateProperty(e, id) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
            await db.collection('properties').doc(id).update({
                name: data.name,
                address: data.address || '',
                ownerId: data.ownerId,
                rent: parseInt(data.rent) || 0,
                sqm: parseInt(data.sqm) || null,
                rooms: parseInt(data.rooms) || null,
                bathrooms: parseInt(data.bathrooms) || null,
                floor: data.floor || '',
                yearBuilt: parseInt(data.yearBuilt) || null,
                propertyType: data.propertyType || 'apartment',
                notes: data.notes || '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Immobile aggiornato!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function updateContract(e, id) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
            await db.collection('contracts').doc(id).update({
                propertyId: data.propertyId,
                tenantId: data.tenantId,
                startDate: data.startDate,
                endDate: data.endDate,
                rent: parseInt(data.rent) || 0,
                deposit: parseInt(data.deposit) || 0,
                status: data.status,
                notes: data.notes || '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Contratto aggiornato!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function renewContract(e, id) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        const contract = S.contracts.find(c => c.id === id);
        if (!contract) return;
        
        let newRent = contract.rent;
        if (data.newRent) {
            newRent = parseInt(data.newRent);
        } else if (data.adjustment) {
            newRent = Math.round(contract.rent * (1 + parseFloat(data.adjustment) / 100));
        }
        
        try {
            await db.collection('contracts').doc(id).update({
                endDate: data.newEndDate,
                rent: newRent,
                renewalHistory: firebase.firestore.FieldValue.arrayUnion({
                    date: new Date().toISOString(),
                    previousEnd: contract.endDate,
                    newEnd: data.newEndDate,
                    previousRent: contract.rent,
                    newRent: newRent,
                    notes: data.renewalNotes || ''
                }),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Contratto rinnovato!', `Nuova scadenza: ${fmtDate(data.newEndDate)}`);
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function terminateContract(e, id) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
            await db.collection('contracts').doc(id).update({
                status: 'terminated',
                terminatedAt: data.terminationDate,
                terminationReason: data.terminationReason || 'other',
                terminationNotes: data.terminationNotes || '',
                depositReturned: parseInt(data.depositReturned) || 0,
                depositWithheld: parseInt(data.depositWithheld) || 0,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Contratto terminato');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function updatePayment(e, id) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
            await db.collection('payments').doc(id).update({
                contractId: data.contractId,
                month: data.month || '',
                amount: parseInt(data.amount) || 0,
                dueDate: data.dueDate || null,
                status: data.status,
                paidDate: data.status === 'paid' && data.paidDate ? data.paidDate : (data.status === 'paid' ? new Date().toISOString() : null),
                notes: data.notes || '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(); await refresh(); toast('success', 'Pagamento aggiornato!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function generateBulkPayments(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        const contract = S.contracts.find(c => c.id === data.contractId);
        if (!contract) return toast('error', 'Contratto non trovato');
        
        const amount = data.amount ? parseInt(data.amount) : contract.rent;
        const dueDay = parseInt(data.dueDay) || 5;
        const numMonths = parseInt(data.numMonths) || 12;
        const startMonth = new Date(data.startMonth + '-01');
        
        const existingMonths = S.payments
            .filter(p => p.contractId === data.contractId)
            .map(p => p.month);
        
        let created = 0, skipped = 0;
        
        try {
            for (let i = 0; i < numMonths; i++) {
                const payMonth = new Date(startMonth);
                payMonth.setMonth(payMonth.getMonth() + i);
                const monthStr = payMonth.toISOString().slice(0, 7);
                
                if (existingMonths.includes(monthStr)) {
                    skipped++;
                    continue;
                }
                
                const dueDate = new Date(payMonth.getFullYear(), payMonth.getMonth(), dueDay);
                
                await db.collection('payments').add({
                    contractId: data.contractId,
                    month: monthStr,
                    amount: amount,
                    dueDate: dueDate.toISOString().split('T')[0],
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                created++;
            }
            
            closeModal(); await refresh();
            toast('success', `${created} pagamenti creati!`, skipped > 0 ? `${skipped} giÃ  esistenti saltati` : '');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function updateMaintenance(e, id) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        const oldMaint = S.maintenance.find(m => m.id === id);
        const updateData = {
            title: data.title,
            propertyId: data.propertyId,
            category: data.category || 'other',
            priority: data.priority || 'medium',
            status: data.status || 'pending',
            description: data.description || '',
            cost: data.cost ? parseInt(data.cost) : null,
            technician: data.technician || '',
            resolutionNotes: data.resolutionNotes || '',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (data.status === 'resolved') {
            updateData.resolvedAt = firebase.firestore.FieldValue.serverTimestamp();
        }
        
        try {
            await db.collection('maintenance').doc(id).update(updateData);
            // Notify tenant if status changed to resolved
            if (data.status === 'resolved' && oldMaint?.status !== 'resolved' && oldMaint?.userId) {
                await notifyMaintenanceResolved({ id, title: data.title, propertyId: data.propertyId, userId: oldMaint.userId });
            }
            closeModal(); await refresh(); toast('success', 'Manutenzione aggiornata!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function deleteRecord(type, id) {
        try {
            await db.collection(type + 's').doc(id).delete();
            closeModal(); await refresh(); toast('success', 'Eliminato!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    async function downloadDocument(id) {
        const doc = S.documents.find(d => d.id === id);
        if (doc?.fileUrl) { window.open(doc.fileUrl, '_blank'); toast('success', 'Download avviato'); }
        else toast('info', 'Documento senza file allegato');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VIEW MODALS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function viewClient(id) {
        const c = S.clients.find(x => x.id === id); if (!c) return;
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal lg">
            <div class="modal-header"><h3 class="modal-title">ğŸ’¼ ${c.name}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body">
                <div class="detail-header"><div class="avatar xl ${c.service === 'DAS' ? 'blue' : c.service === 'VV' ? 'purple' : ''}">${initials(c.name)}</div>
                    <div class="detail-info"><h2 class="detail-title">${c.name}</h2><p class="detail-subtitle">${c.email}${c.phone ? ' Â· ' + c.phone : ''}</p>
                        <div class="detail-badges"><span class="badge ${SERVICES[c.service]?.color}">${c.service} â‚¬${SERVICES[c.service]?.price}</span><span class="badge ${stageBadgeColor(c.stage)}">${stageLabel(c.stage)}</span></div>
                    </div>
                </div>
                <div class="detail-grid mt-16">
                    <div><div class="detail-label">Budget</div><div class="detail-value">${c.budget ? 'â‚¬' + c.budget + '/mese' : 'N/A'}</div></div>
                    <div><div class="detail-label">Zona</div><div class="detail-value">${c.zone || 'N/A'}</div></div>
                    <div><div class="detail-label">Arrivo</div><div class="detail-value">${c.arrivalDate || 'N/A'}</div></div>
                    <div><div class="detail-label">Durata</div><div class="detail-value">${c.duration || 'N/A'}</div></div>
                    <div><div class="detail-label">Source</div><div class="detail-value">${c.source || 'N/A'}</div></div>
                    <div><div class="detail-label">Creato</div><div class="detail-value">${fmtDate(c.createdAt)}</div></div>
                </div>
                ${c.notes ? `<div class="mt-16"><div class="detail-label">Note</div><p style="background:var(--bg);padding:12px;border-radius:8px;margin-top:6px;font-size:13px">${c.notes}</p></div>` : ''}
                <div class="mt-16"><div class="detail-label">Cambia Stage</div><div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:8px">${PIPELINE_STAGES.map(s => `<button class="btn btn-xs ${c.stage === s.id ? '' : 'btn-secondary'}" onclick="updateClientStage('${c.id}','${s.id}')">${s.icon} ${s.name}</button>`).join('')}</div></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="confirmDelete('client','${c.id}','${c.name}')">ğŸ—‘ Elimina</button>
                <button class="btn btn-secondary" onclick="generateServiceContractPDF('${c.id}')">ğŸ“œ Contratto PDF</button>
                <button class="btn" onclick="closeModal()">Chiudi</button>
            </div>
        </div></div>`;
    }

    async function updateClientStage(id, stage) {
        try { await db.collection('clients').doc(id).update({ stage }); await refresh(); viewClient(id); toast('success', 'Stage aggiornato'); }
        catch (err) { toast('error', 'Errore', err.message); }
    }

    function viewInvoice(id) {
        const inv = S.invoices.find(x => x.id === id); if (!inv) return;
        const client = S.clients.find(c => c.id === inv.clientId);
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal">
            <div class="modal-header"><h3 class="modal-title">ğŸ§¾ ${inv.number}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div><div class="detail-label">Cliente</div><div class="detail-value">${client?.name || 'N/A'}</div></div>
                    <div><div class="detail-label">Servizio</div><div class="detail-value">${inv.service || 'N/A'}</div></div>
                    <div><div class="detail-label">Importo</div><div class="detail-value text-gold" style="font-size:20px">â‚¬${inv.amount || 0}</div></div>
                    <div><div class="detail-label">Stato</div><div class="detail-value"><span class="badge ${inv.status === 'paid' ? 'green' : 'orange'}">${inv.status === 'paid' ? 'Pagata' : 'In Attesa'}</span></div></div>
                    <div><div class="detail-label">Data</div><div class="detail-value">${fmtDate(inv.createdAt)}</div></div>
                    ${inv.paidDate ? `<div><div class="detail-label">Pagata il</div><div class="detail-value">${fmtDate(inv.paidDate)}</div></div>` : ''}
                </div>
                ${inv.description ? `<div class="mt-16"><div class="detail-label">Descrizione</div><p style="background:var(--bg);padding:12px;border-radius:8px;margin-top:6px">${inv.description}</p></div>` : ''}
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="confirmDelete('invoice','${inv.id}','${inv.number}')">ğŸ—‘</button>
                <button class="btn btn-secondary" onclick="downloadInvoicePDF('${inv.id}')">ğŸ“¥ PDF</button>
                ${inv.status === 'pending' ? `<button class="btn btn-success" onclick="markInvoicePaid('${inv.id}')">âœ“ Segna Pagata</button>` : ''}
                <button class="btn" onclick="closeModal()">Chiudi</button>
            </div>
        </div></div>`;
    }

    async function markInvoicePaid(id) {
        try {
            await db.collection('invoices').doc(id).update({ status: 'paid', paidDate: new Date().toISOString() });
            const inv = S.invoices.find(i => i.id === id);
            if (inv?.clientId) await db.collection('clients').doc(inv.clientId).update({ stage: 'paid' });
            await refresh(); closeModal(); toast('success', 'Fattura pagata!');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    function viewUser(id) {
        const u = S.users.find(x => x.id === id); if (!u) return;
        const userProps = S.properties.filter(p => p.ownerId === id);
        const userContracts = S.contracts.filter(c => c.tenantId === id);
        const userDocs = S.documents.filter(d => d.userId === id);
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal lg">
            <div class="modal-header"><h3 class="modal-title">ğŸ‘¤ ${u.name}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto">
                <div class="detail-header"><div class="avatar xl ${u.role === 'admin' ? 'purple' : u.role === 'landlord' ? '' : 'blue'}">${initials(u.name)}</div>
                    <div class="detail-info"><h2 class="detail-title">${u.name}</h2><p class="detail-subtitle">${u.email}</p>
                        <div class="detail-badges"><span class="badge ${u.role === 'admin' ? 'purple' : u.role === 'landlord' ? 'gold' : 'blue'}">${roleLabel(u.role)}</span></div>
                    </div>
                </div>
                
                <div class="section-title mt-16" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px">ğŸ“‹ Informazioni Personali</div>
                <div class="detail-grid">
                    <div><div class="detail-label">Email</div><div class="detail-value">${u.email}</div></div>
                    <div><div class="detail-label">Telefono</div><div class="detail-value">${u.phone || 'â€”'}</div></div>
                    <div><div class="detail-label">Codice Fiscale</div><div class="detail-value" style="font-family:monospace">${u.codiceFiscale || 'â€”'}</div></div>
                    <div><div class="detail-label">IBAN</div><div class="detail-value" style="font-family:monospace;font-size:12px">${u.iban || 'â€”'}</div></div>
                    <div style="grid-column:1/-1"><div class="detail-label">Indirizzo</div><div class="detail-value">${u.address || 'â€”'}</div></div>
                    ${u.notes ? `<div style="grid-column:1/-1"><div class="detail-label">Note</div><div class="detail-value" style="background:var(--surface);padding:10px;border-radius:8px;font-size:13px">${u.notes}</div></div>` : ''}
                </div>
                
                <div class="section-title mt-16" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px">ğŸ“Š Account</div>
                <div class="detail-grid">
                    <div><div class="detail-label">Registrato</div><div class="detail-value">${fmtDate(u.createdAt)}</div></div>
                    <div><div class="detail-label">Ultimo Accesso</div><div class="detail-value">${fmtDate(u.lastLogin)}</div></div>
                </div>
                
                ${u.role === 'landlord' && userProps.length ? `<div class="mt-16"><div class="section-title" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px">ğŸ  Immobili (${userProps.length})</div><div style="display:flex;flex-wrap:wrap;gap:6px">${userProps.map(p => `<span class="badge gold">${p.name}</span>`).join('')}</div></div>` : ''}
                ${u.role === 'tenant' && userContracts.length ? `<div class="mt-16"><div class="section-title" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px">ğŸ“‹ Contratti (${userContracts.length})</div><div style="display:flex;flex-wrap:wrap;gap:6px">${userContracts.map(c => { const p = S.properties.find(x => x.id === c.propertyId); return `<span class="badge ${c.status === 'active' ? 'green' : 'gray'}">${p?.name || 'Contratto'}</span>`; }).join('')}</div></div>` : ''}
                
                <div class="mt-16">
                    <div class="section-title" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
                        <span>ğŸ“ Documenti (${userDocs.length})</span>
                        <button class="btn btn-sm" onclick="openUserDocUpload('${u.id}')">+ Aggiungi</button>
                    </div>
                    ${userDocs.length ? `<div style="display:flex;flex-direction:column;gap:8px">${userDocs.map(d => `<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface);border-radius:8px">
                        <span style="font-size:20px">${docIcon(d.type)}</span>
                        <div style="flex:1;min-width:0"><div style="font-weight:500;font-size:13px">${d.name}</div><div style="font-size:11px;color:var(--text-muted)">${docTypeLabel(d.type)} Â· ${fmtDate(d.createdAt)}</div></div>
                        <button class="btn btn-xs btn-secondary" onclick="downloadDocument('${d.id}')" title="Scarica">ğŸ“¥</button>
                        <button class="btn btn-xs btn-danger" onclick="confirmDelete('document','${d.id}','${d.name}')" title="Elimina">ğŸ—‘</button>
                    </div>`).join('')}</div>` : '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">Nessun documento caricato</div>'}
                </div>
            </div>
            <div class="modal-footer">
                ${u.id !== S.profile.id ? `<button class="btn btn-danger btn-sm" onclick="confirmDelete('user','${u.id}','${u.name}')">ğŸ—‘ Elimina</button>` : ''}
                <button class="btn btn-secondary" onclick="closeModal()">Chiudi</button>
                <button class="btn" onclick="const uid='${u.id}';closeModal();setTimeout(()=>openModal('editUser',S.users.find(x=>x.id===uid)),250)">âœï¸ Modifica</button>
            </div>
        </div></div>`;
    }

    function viewProperty(id) {
        const p = S.properties.find(x => x.id === id); if (!p) return;
        const owner = S.users.find(u => u.id === p.ownerId);
        const contracts = S.contracts.filter(c => c.propertyId === id);
        const activeContract = contracts.find(c => c.status === 'active');
        const tenant = activeContract ? S.users.find(u => u.id === activeContract.tenantId) : null;
        const propTypeLabels = { apartment: 'Appartamento', studio: 'Monolocale', room: 'Stanza', house: 'Casa', loft: 'Loft' };
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal lg">
            <div class="modal-header"><h3 class="modal-title">ğŸ  ${p.name}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto">
                <div class="detail-badges mb-16">
                    <span class="badge ${activeContract ? 'green' : 'gray'}">${activeContract ? 'Affittato' : 'Libero'}</span>
                    <span class="badge gray">${propTypeLabels[p.propertyType] || 'Appartamento'}</span>
                </div>
                <div class="section-title" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px">ğŸ“ Dettagli Immobile</div>
                <div class="detail-grid">
                    <div><div class="detail-label">Indirizzo</div><div class="detail-value">${p.address || 'Roma'}</div></div>
                    <div><div class="detail-label">Affitto</div><div class="detail-value text-gold">â‚¬${p.rent}/mese</div></div>
                    <div><div class="detail-label">Superficie</div><div class="detail-value">${p.sqm ? p.sqm + ' mÂ²' : 'â€”'}</div></div>
                    <div><div class="detail-label">Stanze</div><div class="detail-value">${p.rooms || 'â€”'}</div></div>
                    <div><div class="detail-label">Bagni</div><div class="detail-value">${p.bathrooms || 'â€”'}</div></div>
                    <div><div class="detail-label">Piano</div><div class="detail-value">${p.floor || 'â€”'}</div></div>
                    <div><div class="detail-label">Anno</div><div class="detail-value">${p.yearBuilt || 'â€”'}</div></div>
                    <div><div class="detail-label">Proprietario</div><div class="detail-value">${owner?.name || 'N/A'}</div></div>
                </div>
                ${p.notes ? `<div class="mt-16"><div class="detail-label">Note</div><div class="detail-value" style="background:var(--surface);padding:10px;border-radius:8px;font-size:13px;margin-top:6px">${p.notes}</div></div>` : ''}
                ${activeContract ? `
                <div class="section-title mt-16" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px">ğŸ‘¤ Inquilino Attuale</div>
                <div class="detail-grid">
                    <div><div class="detail-label">Nome</div><div class="detail-value">${tenant?.name || 'N/A'}</div></div>
                    <div><div class="detail-label">Email</div><div class="detail-value">${tenant?.email || 'N/A'}</div></div>
                    <div><div class="detail-label">Contratto</div><div class="detail-value">${fmtDate(activeContract.startDate)} â†’ ${fmtDate(activeContract.endDate)}</div></div>
                    <div><div class="detail-label">Deposito</div><div class="detail-value">â‚¬${activeContract.deposit || 0}</div></div>
                </div>` : ''}
                ${contracts.length ? `<div class="mt-16"><div class="section-title" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px">ğŸ“‹ Storico Contratti (${contracts.length})</div><div style="background:var(--surface);border-radius:8px;overflow:hidden">${contracts.map(c => { const t = S.users.find(u => u.id === c.tenantId); return `<div style="padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;display:flex;align-items:center;gap:10px"><span class="badge ${c.status === 'active' ? 'green' : c.status === 'terminated' ? 'red' : 'gray'}">${c.status === 'active' ? 'Attivo' : c.status === 'terminated' ? 'Terminato' : 'Scaduto'}</span><span style="flex:1">${t?.name || 'Inquilino'} Â· ${fmtDate(c.startDate)} â†’ ${fmtDate(c.endDate)}</span><span class="text-gold">â‚¬${c.rent}/mese</span></div>`; }).join('')}</div></div>` : ''}
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="confirmDelete('propert','${p.id}','${p.name}')">ğŸ—‘</button>
                <button class="btn btn-secondary" onclick="closeModal()">Chiudi</button>
                <button class="btn" onclick="const pid='${p.id}';closeModal();setTimeout(()=>openModal('editProperty',S.properties.find(x=>x.id===pid)),250)">âœï¸ Modifica</button>
            </div>
        </div></div>`;
    }

    function viewPropertyLandlord(id) {
        const p = S.properties.find(x => x.id === id); if (!p) return;
        const contracts = getMyContracts().filter(c => c.propertyId === id);
        const activeContract = contracts.find(c => c.status === 'active');
        const tenant = activeContract ? S.users.find(u => u.id === activeContract.tenantId) : null;
        const payments = getMyPayments().filter(pay => { const c = contracts.find(x => x.id === pay.contractId); return c !== undefined; });
        const totalPaid = payments.filter(pay => pay.status === 'paid').reduce((s, pay) => s + (pay.amount || 0), 0);
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal lg">
            <div class="modal-header"><h3 class="modal-title">ğŸ  ${p.name}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body">
                <div class="detail-badges mb-16"><span class="badge ${activeContract ? 'green' : 'gray'}">${activeContract ? 'Affittato' : 'Libero'}</span></div>
                <div class="detail-grid">
                    <div><div class="detail-label">Indirizzo</div><div class="detail-value">${p.address || 'Roma'}</div></div>
                    <div><div class="detail-label">Affitto</div><div class="detail-value text-gold">â‚¬${p.rent}/mese</div></div>
                    ${activeContract ? `
                    <div><div class="detail-label">Inquilino</div><div class="detail-value">${tenant?.name || 'N/A'}</div></div>
                    <div><div class="detail-label">Contatto</div><div class="detail-value">${tenant?.email || ''}${tenant?.phone ? ' Â· ' + tenant.phone : ''}</div></div>
                    <div><div class="detail-label">Contratto</div><div class="detail-value">${fmtDate(activeContract.startDate)} â†’ ${fmtDate(activeContract.endDate)}</div></div>
                    <div><div class="detail-label">Deposito</div><div class="detail-value">â‚¬${activeContract.deposit || 0}</div></div>` : ''}
                    <div><div class="detail-label">Incassato Totale</div><div class="detail-value text-green">â‚¬${totalPaid.toLocaleString('it-IT')}</div></div>
                </div>
                ${tenant ? `<div class="contact-card mt-16"><div class="avatar">${initials(tenant.name)}</div><div class="contact-info"><div class="contact-name">${tenant.name}</div><div class="contact-role">Inquilino attuale</div><div class="contact-details">${tenant.email}${tenant.phone ? '<br>' + tenant.phone : ''}</div></div><div class="contact-actions"><a href="mailto:${tenant.email}" class="btn btn-sm btn-secondary">ğŸ“§</a>${tenant.phone ? `<a href="tel:${tenant.phone}" class="btn btn-sm btn-secondary">ğŸ“</a><a href="https://wa.me/${tenant.phone.replace(/\D/g,'')}" class="btn btn-sm btn-success" target="_blank">ğŸ’¬</a>` : ''}</div></div>` : ''}
            </div>
            <div class="modal-footer"><button class="btn" onclick="closeModal()">Chiudi</button></div>
        </div></div>`;
    }

    function viewContract(id) {
        const c = S.contracts.find(x => x.id === id); if (!c) return;
        const p = S.properties.find(x => x.id === c.propertyId);
        const t = S.users.find(x => x.id === c.tenantId);
        const o = S.users.find(x => x.id === p?.ownerId);
        const days = daysUntil(c.endDate);
        const payments = S.payments.filter(pay => pay.contractId === id);
        const paidTotal = payments.filter(pay => pay.status === 'paid').reduce((s, pay) => s + (pay.amount || 0), 0);
        const pendingTotal = payments.filter(pay => pay.status === 'pending').reduce((s, pay) => s + (pay.amount || 0), 0);
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal lg">
            <div class="modal-header"><h3 class="modal-title">ğŸ“‹ Contratto ${p?.name || ''}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto">
                <div class="detail-badges mb-16">
                    <span class="badge ${c.status === 'active' ? 'green' : c.status === 'terminated' ? 'red' : 'gray'}">${c.status === 'active' ? 'Attivo' : c.status === 'terminated' ? 'Terminato' : 'Scaduto'}</span>
                    ${c.status === 'active' && days !== null && days <= 60 && days >= 0 ? `<span class="badge orange">â± ${days} giorni alla scadenza</span>` : ''}
                </div>
                <div class="section-title" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px">ğŸ“ Dettagli Contratto</div>
                <div class="detail-grid">
                    <div><div class="detail-label">Immobile</div><div class="detail-value">${p?.name || 'N/A'}</div></div>
                    <div><div class="detail-label">Indirizzo</div><div class="detail-value">${p?.address || 'Roma'}</div></div>
                    <div><div class="detail-label">Proprietario</div><div class="detail-value">${o?.name || 'N/A'} ${o?.phone ? 'Â· ' + o.phone : ''}</div></div>
                    <div><div class="detail-label">Inquilino</div><div class="detail-value">${t?.name || 'N/A'} ${t?.phone ? 'Â· ' + t.phone : ''}</div></div>
                    <div><div class="detail-label">Data Inizio</div><div class="detail-value">${fmtDate(c.startDate)}</div></div>
                    <div><div class="detail-label">Data Fine</div><div class="detail-value">${fmtDate(c.endDate)}</div></div>
                    <div><div class="detail-label">Affitto Mensile</div><div class="detail-value text-gold">â‚¬${c.rent}</div></div>
                    <div><div class="detail-label">Deposito Cauzionale</div><div class="detail-value">â‚¬${c.deposit || 0}</div></div>
                </div>
                ${c.notes ? `<div class="mt-16"><div class="detail-label">Note</div><div class="detail-value" style="background:var(--surface);padding:10px;border-radius:8px;font-size:13px;margin-top:6px">${c.notes}</div></div>` : ''}
                ${payments.length ? `
                <div class="section-title mt-16" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px">ğŸ’³ Riepilogo Pagamenti</div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
                    <div style="background:var(--surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:var(--text-muted)">Totale</div><div style="font-size:18px;font-weight:600">${payments.length}</div></div>
                    <div style="background:var(--green-light);padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:var(--green)">Incassato</div><div style="font-size:18px;font-weight:600;color:var(--green)">â‚¬${paidTotal.toLocaleString('it-IT')}</div></div>
                    <div style="background:var(--orange-light);padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:var(--orange)">In Attesa</div><div style="font-size:18px;font-weight:600;color:var(--orange)">â‚¬${pendingTotal.toLocaleString('it-IT')}</div></div>
                </div>` : ''}
                ${c.renewalHistory?.length ? `
                <div class="section-title mt-16" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:12px">ğŸ”„ Storico Rinnovi</div>
                <div style="background:var(--surface);border-radius:8px;overflow:hidden">${c.renewalHistory.map(r => `<div style="padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px">${fmtDate(r.date)} - Esteso fino a ${fmtDate(r.newEnd)} ${r.newRent !== r.previousRent ? `Â· Affitto: â‚¬${r.previousRent} â†’ â‚¬${r.newRent}` : ''}</div>`).join('')}</div>` : ''}
            </div>
            <div class="modal-footer" style="flex-wrap:wrap;gap:8px">
                <button class="btn btn-danger btn-sm" onclick="confirmDelete('contract','${c.id}','Contratto ${p?.name}')">ğŸ—‘</button>
                ${c.status === 'active' ? `<button class="btn btn-sm" style="background:var(--red);color:white" onclick="const cid='${c.id}';closeModal();setTimeout(()=>openModal('terminateContract',S.contracts.find(x=>x.id===cid)),250)">â›” Termina</button>` : ''}
                ${c.status === 'active' ? `<button class="btn btn-sm" style="background:var(--green);color:white" onclick="const cid='${c.id}';closeModal();setTimeout(()=>openModal('renewContract',S.contracts.find(x=>x.id===cid)),250)">ğŸ”„ Rinnova</button>` : ''}
                <button class="btn btn-secondary btn-sm" onclick="downloadContractPDF('${c.id}')">ğŸ“¥ PDF</button>
                <button class="btn btn-secondary" onclick="closeModal()">Chiudi</button>
                <button class="btn" onclick="const cid='${c.id}';closeModal();setTimeout(()=>openModal('editContract',S.contracts.find(x=>x.id===cid)),250)">âœï¸ Modifica</button>
            </div>
        </div></div>`;
    }

    function viewContractLandlord(id) { viewContract(id); }

    function viewMaintenance(id) {
        const m = S.maintenance.find(x => x.id === id); if (!m) return;
        const p = S.properties.find(x => x.id === m.propertyId);
        const u = S.users.find(x => x.id === m.userId);
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal lg">
            <div class="modal-header"><h3 class="modal-title">ğŸ”§ ${m.title}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body">
                <div class="detail-badges mb-16"><span class="badge ${statusColor(m.status)}">${statusLabel(m.status)}</span><span class="badge ${priorityColor(m.priority)}">${priorityLabel(m.priority)}</span></div>
                <div class="detail-grid">
                    <div><div class="detail-label">Immobile</div><div class="detail-value">${p?.name || 'N/A'}</div></div>
                    <div><div class="detail-label">Categoria</div><div class="detail-value">${catLabel(m.category)}</div></div>
                    <div><div class="detail-label">Richiesto da</div><div class="detail-value">${u?.name || 'N/A'}</div></div>
                    <div><div class="detail-label">Data</div><div class="detail-value">${fmtDate(m.createdAt)}</div></div>
                    ${m.cost ? `<div><div class="detail-label">Costo</div><div class="detail-value text-gold">â‚¬${m.cost}</div></div>` : ''}
                    ${m.technician ? `<div><div class="detail-label">Tecnico</div><div class="detail-value">${m.technician}</div></div>` : ''}
                    ${m.resolvedAt ? `<div><div class="detail-label">Risolto il</div><div class="detail-value">${fmtDate(m.resolvedAt)}</div></div>` : ''}
                </div>
                ${m.description ? `<div class="mt-16"><div class="detail-label">Descrizione</div><p style="background:var(--surface);padding:12px;border-radius:8px;margin-top:6px;font-size:13px">${m.description}</p></div>` : ''}
                ${m.resolutionNotes ? `<div class="mt-16"><div class="detail-label">Note Risoluzione</div><p style="background:var(--green-light);padding:12px;border-radius:8px;margin-top:6px;font-size:13px">${m.resolutionNotes}</p></div>` : ''}
                ${isAdmin() ? `<div class="mt-16"><div class="detail-label">Cambia Stato Rapido</div><div style="display:flex;gap:6px;margin-top:8px"><button class="btn btn-xs ${m.status==='pending'||m.status==='open'?'':'btn-secondary'}" onclick="updateMaintStatus('${m.id}','pending')">ğŸŸ¡ In Attesa</button><button class="btn btn-xs ${m.status==='in_progress'?'':'btn-secondary'}" onclick="updateMaintStatus('${m.id}','in_progress')">ğŸ”µ In Corso</button><button class="btn btn-xs ${m.status==='resolved'?'btn-success':'btn-secondary'}" onclick="updateMaintStatus('${m.id}','resolved')">ğŸŸ¢ Risolto</button></div></div>` : ''}
            </div>
            <div class="modal-footer">
                ${isAdmin() ? `<button class="btn btn-danger btn-sm" onclick="confirmDelete('maintenance','${m.id}','${m.title}')">ğŸ—‘</button>` : ''}
                <button class="btn btn-secondary" onclick="closeModal()">Chiudi</button>
                ${isAdmin() ? `<button class="btn" onclick="const mid='${m.id}';closeModal();setTimeout(()=>openModal('editMaintenance',S.maintenance.find(x=>x.id===mid)),250)">âœï¸ Modifica</button>` : ''}
            </div>
        </div></div>`;
    }

    function viewMaintenanceUser(id) { viewMaintenance(id); }

    async function updateMaintStatus(id, status) {
        try {
            const oldMaint = S.maintenance.find(m => m.id === id);
            const updateData = { status, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
            if (status === 'resolved') {
                updateData.resolvedAt = firebase.firestore.FieldValue.serverTimestamp();
            }
            await db.collection('maintenance').doc(id).update(updateData);
            
            // Notify tenant if resolved
            if (status === 'resolved' && oldMaint?.status !== 'resolved' && oldMaint?.userId) {
                await notifyMaintenanceResolved({ 
                    id, 
                    title: oldMaint.title, 
                    propertyId: oldMaint.propertyId, 
                    userId: oldMaint.userId 
                });
            }
            
            await refresh(); 
            viewMaintenance(id); 
            toast('success', 'Stato aggiornato');
        } catch (err) { toast('error', 'Errore', err.message); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PDF GENERATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function downloadMyContractPDF() {
        const contract = getMyContracts().find(c => c.status === 'active');
        if (!contract) return toast('error', 'Nessun contratto attivo');
        downloadContractPDF(contract.id);
    }

    function downloadContractPDF(id) {
        const c = S.contracts.find(x => x.id === id); if (!c) return;
        const p = S.properties.find(x => x.id === c.propertyId);
        const t = S.users.find(x => x.id === c.tenantId);
        const o = S.users.find(x => x.id === p?.ownerId);
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Header
        doc.setFillColor(0, 0, 0); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(212, 175, 55); doc.setFontSize(28); doc.setFont('helvetica', 'bold'); doc.text('BOOM', 20, 25);
        doc.setTextColor(255, 255, 255); doc.setFontSize(14); doc.text('CONTRATTO DI LOCAZIONE', 190, 25, { align: 'right' });
        
        let y = 55;
        doc.setTextColor(0, 0, 0);
        
        // Info box
        doc.setFillColor(245, 245, 245); doc.rect(15, y - 5, 180, 20, 'F');
        doc.setFontSize(10); doc.text(`Data: ${new Date().toLocaleDateString('it-IT')}`, 20, y + 5);
        doc.text(`Ref: CTR-${c.id.slice(-8).toUpperCase()}`, 150, y + 5);
        
        y += 30;
        doc.setFont('helvetica', 'bold'); doc.setFontSize(11); doc.text('LOCATORE (Proprietario)', 20, y);
        doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
        y += 7; doc.text(`Nome: ${o?.name || 'N/A'}`, 20, y);
        y += 5; doc.text(`Email: ${o?.email || 'N/A'}`, 20, y);
        y += 5; doc.text(`Telefono: ${o?.phone || 'N/A'}`, 20, y);
        
        y += 12;
        doc.setFont('helvetica', 'bold'); doc.setFontSize(11); doc.text('CONDUTTORE (Inquilino)', 20, y);
        doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
        y += 7; doc.text(`Nome: ${t?.name || 'N/A'}`, 20, y);
        y += 5; doc.text(`Email: ${t?.email || 'N/A'}`, 20, y);
        y += 5; doc.text(`Telefono: ${t?.phone || 'N/A'}`, 20, y);
        
        y += 12;
        doc.setFont('helvetica', 'bold'); doc.setFontSize(11); doc.text('IMMOBILE', 20, y);
        doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
        y += 7; doc.text(`Denominazione: ${p?.name || 'N/A'}`, 20, y);
        y += 5; doc.text(`Indirizzo: ${p?.address || 'Roma, Italia'}`, 20, y);
        
        y += 12;
        doc.setFont('helvetica', 'bold'); doc.setFontSize(11); doc.text('CONDIZIONI CONTRATTUALI', 20, y);
        doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
        y += 7; doc.text(`Durata: dal ${fmtDate(c.startDate)} al ${fmtDate(c.endDate)}`, 20, y);
        y += 5; doc.text(`Canone mensile: EUR ${c.rent},00 (Euro ${numberToWords(c.rent)}/00)`, 20, y);
        y += 5; doc.text(`Deposito cauzionale: EUR ${c.deposit || 0},00`, 20, y);
        y += 5; doc.text(`Pagamento: entro il 5 di ogni mese`, 20, y);
        
        y += 12;
        doc.setFont('helvetica', 'bold'); doc.setFontSize(11); doc.text('MODALITA DI PAGAMENTO', 20, y);
        doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
        y += 7; doc.text(`Intestatario: ${COMPANY.legal}`, 20, y);
        y += 5; doc.text(`IBAN: ${COMPANY.iban}`, 20, y);
        y += 5; doc.text(`Causale: Affitto ${p?.name} - [Mese/Anno]`, 20, y);
        
        // Signatures
        y = 230;
        doc.setDrawColor(200); doc.line(20, y, 90, y); doc.line(120, y, 190, y);
        doc.setFontSize(9); doc.text('Firma Locatore', 55, y + 5, { align: 'center' }); doc.text('Firma Conduttore', 155, y + 5, { align: 'center' });
        
        // Footer
        doc.setFillColor(0, 0, 0); doc.rect(0, 280, 210, 20, 'F');
        doc.setTextColor(150); doc.setFontSize(8); doc.text(`${COMPANY.legal} | P.IVA ${COMPANY.piva} | ${COMPANY.website}`, 105, 288, { align: 'center' });
        
        doc.save(`Contratto_${p?.name?.replace(/\s+/g, '_') || 'Immobile'}_${t?.name?.replace(/\s+/g, '_') || 'Inquilino'}.pdf`);
        toast('success', 'Contratto scaricato!');
    }

    function downloadPaymentReceipt(id) {
        const pay = S.payments.find(x => x.id === id); if (!pay || pay.status !== 'paid') return toast('error', 'Pagamento non trovato o non pagato');
        const c = S.contracts.find(x => x.id === pay.contractId);
        const p = c ? S.properties.find(x => x.id === c.propertyId) : null;
        const t = c ? S.users.find(x => x.id === c.tenantId) : null;
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(0, 0, 0); doc.rect(0, 0, 210, 35, 'F');
        doc.setTextColor(212, 175, 55); doc.setFontSize(28); doc.setFont('helvetica', 'bold'); doc.text('BOOM', 20, 22);
        doc.setTextColor(255); doc.setFontSize(14); doc.text('RICEVUTA DI PAGAMENTO', 190, 22, { align: 'right' });
        
        let y = 50;
        doc.setTextColor(0);
        doc.setFillColor(245, 245, 245); doc.rect(15, y - 5, 180, 18, 'F');
        doc.setFontSize(10); doc.text(`Data: ${fmtDate(pay.paidDate)}`, 20, y + 5);
        doc.text(`NÂ°: RIC-${pay.id.slice(-8).toUpperCase()}`, 150, y + 5);
        
        y += 30;
        doc.setFont('helvetica', 'bold'); doc.text('RICEVUTO DA:', 20, y);
        doc.setFont('helvetica', 'normal'); y += 7; doc.text(t?.name || 'Inquilino', 20, y);
        
        y += 15;
        doc.setFont('helvetica', 'bold'); doc.text('IMMOBILE:', 20, y);
        doc.setFont('helvetica', 'normal'); y += 7; doc.text(p?.name || 'N/A', 20, y);
        y += 5; doc.text(p?.address || 'Roma', 20, y);
        
        y += 15;
        doc.setFont('helvetica', 'bold'); doc.text('PERIODO:', 20, y);
        doc.setFont('helvetica', 'normal'); y += 7; doc.text(pay.month || 'N/A', 20, y);
        
        y += 20;
        doc.setFillColor(212, 175, 55); doc.rect(15, y - 5, 180, 25, 'F');
        doc.setTextColor(0); doc.setFontSize(12); doc.setFont('helvetica', 'bold');
        doc.text('IMPORTO RICEVUTO', 20, y + 5);
        doc.setFontSize(20); doc.text(`EUR ${pay.amount},00`, 190, y + 8, { align: 'right' });
        
        doc.setTextColor(0); doc.setFontSize(10); doc.setFont('helvetica', 'normal');
        y += 35;
        doc.text(`(Euro ${numberToWords(pay.amount)}/00)`, 20, y);
        
        y += 20;
        doc.text('Pagamento per canone di locazione mensile.', 20, y);
        
        doc.setFillColor(0, 0, 0); doc.rect(0, 275, 210, 25, 'F');
        doc.setTextColor(150); doc.setFontSize(8); doc.text(`${COMPANY.legal} | ${COMPANY.website}`, 105, 285, { align: 'center' });
        
        doc.save(`Ricevuta_${p?.name?.replace(/\s+/g, '_') || ''}_${pay.month || ''}.pdf`);
        toast('success', 'Ricevuta scaricata!');
    }

    function downloadInvoicePDF(id) {
        const inv = S.invoices.find(i => i.id === id); if (!inv) return;
        const client = S.clients.find(c => c.id === inv.clientId);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(0, 0, 0); doc.rect(0, 0, 210, 35, 'F');
        doc.setTextColor(212, 175, 55); doc.setFontSize(28); doc.setFont('helvetica', 'bold'); doc.text('BOOM', 20, 22);
        doc.setTextColor(255); doc.setFontSize(16); doc.text('FATTURA', 190, 22, { align: 'right' });
        
        doc.setTextColor(0); doc.setFillColor(245); doc.rect(120, 45, 75, 25, 'F');
        doc.setFontSize(10); doc.setFont('helvetica', 'bold');
        doc.text('NÂ°:', 125, 53); doc.text('Data:', 125, 61);
        doc.setFont('helvetica', 'normal'); doc.text(inv.number, 145, 53); doc.text(fmtDate(inv.createdAt), 145, 61);
        
        let y = 50;
        doc.setFont('helvetica', 'bold'); doc.text('DA:', 20, y); doc.setFont('helvetica', 'normal');
        y += 6; doc.text(COMPANY.legal, 20, y); y += 5; doc.text(`P.IVA: ${COMPANY.piva}`, 20, y);
        
        y = 85; doc.setFont('helvetica', 'bold'); doc.text('A:', 20, y); doc.setFont('helvetica', 'normal');
        y += 6; doc.text(client?.name || 'Cliente', 20, y); if (client?.email) { y += 5; doc.text(client.email, 20, y); }
        
        y = 115; doc.setFillColor(0); doc.rect(15, y, 180, 10, 'F');
        doc.setTextColor(255); doc.setFont('helvetica', 'bold'); doc.text('Descrizione', 20, y + 7); doc.text('Importo', 175, y + 7, { align: 'right' });
        
        y += 15; doc.setTextColor(0); doc.setFont('helvetica', 'normal');
        doc.text(inv.service || 'Servizio BOOM', 20, y); doc.text(`EUR ${inv.amount || 0}`, 175, y, { align: 'right' });
        
        y += 20; doc.setDrawColor(200); doc.line(120, y, 195, y);
        y += 10; doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.text('TOTALE:', 130, y);
        doc.setTextColor(212, 175, 55); doc.text(`EUR ${inv.amount || 0}`, 175, y, { align: 'right' });
        
        y += 25; doc.setTextColor(0); doc.setFontSize(10); doc.setFont('helvetica', 'bold');
        doc.text('Pagamento:', 20, y); doc.setFont('helvetica', 'normal'); y += 7; doc.text(`IBAN: ${COMPANY.iban}`, 20, y);
        
        doc.setFillColor(0); doc.rect(0, 275, 210, 25, 'F');
        doc.setTextColor(150); doc.setFontSize(8); doc.text(`${COMPANY.legal} | ${COMPANY.website}`, 105, 285, { align: 'center' });
        
        doc.save(`BOOM_Fattura_${inv.number}.pdf`);
        toast('success', 'Fattura scaricata!');
    }

    function generateServiceContractPDF(clientId) {
        const c = S.clients.find(x => x.id === clientId); if (!c) return;
        openTemplateModal(c.service.toLowerCase());
        setTimeout(() => fillClientData(clientId), 100);
    }

    function openTemplateModal(type, prefillClient = null) {
        const titles = { 
            pfs: 'ğŸ  Property Finding Service â‚¬350', 
            das: 'ğŸ“‹ Deal Assistance Service â‚¬249', 
            vv: 'ğŸ¥ Virtual Viewing â‚¬89', 
            lettera_incarico: 'ğŸ“ Lettera d\'Incarico',
            proposal: 'ğŸ“Š Proposta Servizi', 
            quote: 'ğŸ’° Preventivo',
            proposta_locazione: 'ğŸ“¨ Proposta di Locazione',
            accettazione_proposta: 'âœ… Accettazione Proposta',
            rental_transitorio: 'â±ï¸ Contratto Transitorio', 
            rental_studenti: 'ğŸ“ Contratto Studenti', 
            rental_4plus4: 'ğŸ¢ Contratto 4+4',
            disdetta: 'âŒ Disdetta Contratto',
            ricevuta_pigione: 'ğŸ’° Ricevuta Pigione',
            deposit_receipt: 'ğŸ¦ Ricevuta Deposito', 
            ricevuta_provvigione: 'ğŸ’¼ Ricevuta Provvigione',
            mandato_gestione: 'ğŸ“œ Mandato di Gestione',
            rendiconto_annuale: 'ğŸ“Š Rendiconto Annuale',
            comunicazione_istat: 'ğŸ“ˆ Comunicazione ISTAT',
            sollecito_pagamento: 'âš ï¸ Sollecito Pagamento',
            handover: 'ğŸ”‘ Verbale Consegna', 
            inventory: 'ğŸ“¦ Inventario',
            stato_immobile: 'ğŸ  Stato dell\'Immobile'
        };
        
        let formFields = '';
        
        // Service contracts (PFS, DAS, VV)
        if (['pfs', 'das', 'vv'].includes(type)) {
            const svcClients = S.clients.filter(c => c.service === type.toUpperCase());
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ DATI CLIENTE</h4>
                    <div class="form-group"><label class="form-label">Seleziona Cliente Esistente</label>
                        <select class="form-select" name="clientId" onchange="fillClientData(this.value)">
                            <option value="">-- Inserisci manualmente --</option>
                            ${svcClients.map(c => `<option value="${c.id}" ${prefillClient?.id === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" id="tplName" value="${prefillClient?.name || ''}" required></div><div class="form-group"><label class="form-label">Email *</label><input type="email" class="form-input" name="clientEmail" id="tplEmail" value="${prefillClient?.email || ''}" required></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Telefono</label><input type="tel" class="form-input" name="clientPhone" id="tplPhone" value="${prefillClient?.phone || ''}"></div><div class="form-group"><label class="form-label">Codice Fiscale</label><input type="text" class="form-input" name="clientCF" placeholder="RSSMRA85M01H501Z"></div></div>
                    <div class="form-group"><label class="form-label">Indirizzo Residenza</label><input type="text" class="form-input" name="clientAddress" placeholder="Via Roma 1, 00100 Roma"></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ  REQUISITI RICERCA</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Budget Max â‚¬/mese *</label><input type="number" class="form-input" name="budget" id="tplBudget" value="${prefillClient?.budget || ''}" required></div><div class="form-group"><label class="form-label">Zona *</label><input type="text" class="form-input" name="zone" id="tplZone" value="${prefillClient?.zone || ''}" required></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Data Arrivo</label><input type="date" class="form-input" name="arrivalDate" value="${prefillClient?.arrivalDate || ''}"></div><div class="form-group"><label class="form-label">Durata</label><input type="text" class="form-input" name="duration" id="tplDuration" value="${prefillClient?.duration || ''}" placeholder="es. 12 mesi"></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Tipologia</label><select class="form-select" name="propertyType"><option value="any">Qualsiasi</option><option value="apartment">Appartamento</option><option value="room">Stanza</option><option value="studio">Monolocale</option></select></div><div class="form-group"><label class="form-label">NÂ° Persone</label><input type="number" class="form-input" name="numPeople" value="1" min="1"></div></div>
                    <div class="form-group"><label class="form-label">Requisiti Specifici</label><textarea class="form-textarea" name="requirements" placeholder="Animali, balcone, parcheggio..."></textarea></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ’° SERVIZIO</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Importo â‚¬</label><input type="number" class="form-input" name="serviceAmount" value="${SERVICES[type.toUpperCase()]?.price || 0}" readonly></div><div class="form-group"><label class="form-label">Data Contratto</label><input type="date" class="form-input" name="contractDate" value="${new Date().toISOString().split('T')[0]}"></div></div>
                </div>`;
        }
        // Rental contracts
        else if (['rental_transitorio', 'rental_studenti', 'rental_4plus4'].includes(type)) {
            const landlords = S.users.filter(u => u.role === 'landlord');
            const tenants = S.users.filter(u => u.role === 'tenant');
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ LOCATORE (Proprietario)</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="landlordId" onchange="fillUserData(this.value,'landlord')"><option value="">-- Inserisci --</option>${landlords.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="landlordName" id="tplLandlordName" required></div><div class="form-group"><label class="form-label">C.F. *</label><input type="text" class="form-input" name="landlordCF" id="tplLandlordCF" required></div></div>
                    <div class="form-group"><label class="form-label">Residenza *</label><input type="text" class="form-input" name="landlordAddress" id="tplLandlordAddress" required></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ CONDUTTORE (Inquilino)</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="tenantId" onchange="fillUserData(this.value,'tenant')"><option value="">-- Inserisci --</option>${tenants.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="tenantName" id="tplTenantName" required></div><div class="form-group"><label class="form-label">C.F. *</label><input type="text" class="form-input" name="tenantCF" id="tplTenantCF" required></div></div>
                    <div class="form-group"><label class="form-label">Residenza *</label><input type="text" class="form-input" name="tenantAddress" id="tplTenantAddress" required></div>
                    ${type === 'rental_studenti' ? `<div class="form-group"><label class="form-label">UniversitÃ  / Corso *</label><input type="text" class="form-input" name="university" required placeholder="es. Sapienza - Medicina"></div>` : ''}
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ  IMMOBILE</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="propertyId" onchange="fillPropertyData(this.value)"><option value="">-- Inserisci --</option>${S.properties.map(p => `<option value="${p.id}">${p.name} - ${p.address || 'Roma'}</option>`).join('')}</select></div>
                    <div class="form-group"><label class="form-label">Indirizzo *</label><input type="text" class="form-input" name="propertyAddress" id="tplPropertyAddress" required></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Dati Catastali</label><input type="text" class="form-input" name="cadastral" placeholder="Foglio X, Part. Y, Sub. Z"></div><div class="form-group"><label class="form-label">Classe Energetica</label><select class="form-select" name="energyClass"><option value="G" selected>G</option><option value="F">F</option><option value="E">E</option><option value="D">D</option><option value="C">C</option><option value="B">B</option><option value="A">A</option></select></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ“… DURATA E CANONE</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Data Inizio *</label><input type="date" class="form-input" name="startDate" required></div><div class="form-group"><label class="form-label">Data Fine *</label><input type="date" class="form-input" name="endDate" required></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Canone â‚¬/mese *</label><input type="number" class="form-input" name="rent" id="tplRent" required></div><div class="form-group"><label class="form-label">Deposito â‚¬</label><input type="number" class="form-input" name="deposit" id="tplDeposit"></div></div>
                    ${type === 'rental_transitorio' ? `<div class="form-group"><label class="form-label">Motivazione Transitoria *</label><textarea class="form-textarea" name="transitoryReason" required placeholder="es. Motivi di lavoro temporaneo"></textarea></div>` : ''}
                </div>`;
        }
        // Receipts
        else if (['deposit_receipt', 'payment_receipt'].includes(type)) {
            const tenants = S.users.filter(u => u.role === 'tenant');
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ RICEVENTE</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="receiverName" value="${COMPANY.legal}" required></div><div class="form-group"><label class="form-label">C.F./P.IVA</label><input type="text" class="form-input" name="receiverCF" value="${COMPANY.piva}"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ PAGANTE</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="payerId" onchange="fillUserData(this.value,'tenant')"><option value="">-- Inserisci --</option>${tenants.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="payerName" id="tplTenantName" required></div><div class="form-group"><label class="form-label">C.F.</label><input type="text" class="form-input" name="payerCF" id="tplTenantCF"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ’° PAGAMENTO</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Importo â‚¬ *</label><input type="number" class="form-input" name="amount" required></div><div class="form-group"><label class="form-label">Data *</label><input type="date" class="form-input" name="paymentDate" value="${new Date().toISOString().split('T')[0]}" required></div></div>
                    ${type === 'payment_receipt' ? `<div class="form-group"><label class="form-label">Periodo</label><input type="text" class="form-input" name="period" placeholder="es. Gennaio 2025"></div>` : ''}
                    <div class="form-group"><label class="form-label">Immobile</label><select class="form-select" name="propertyId" onchange="fillPropertyData(this.value)"><option value="">-- Seleziona --</option>${S.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
                    <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes"></textarea></div>
                </div>`;
        }
        // Handover / Inventory
        else if (['handover', 'inventory'].includes(type)) {
            const landlords = S.users.filter(u => u.role === 'landlord');
            const tenants = S.users.filter(u => u.role === 'tenant');
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ  IMMOBILE</h4>
                    <div class="form-group"><label class="form-label">Seleziona *</label><select class="form-select" name="propertyId" onchange="fillPropertyData(this.value)" required><option value="">-- Seleziona --</option>${S.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
                    <div class="form-group"><label class="form-label">Indirizzo</label><input type="text" class="form-input" name="propertyAddress" id="tplPropertyAddress"></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¥ PARTI</h4>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Proprietario</label><select class="form-select" name="landlordId" onchange="fillUserData(this.value,'landlord')"><option value="">--</option>${landlords.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                        <div class="form-group"><label class="form-label">Inquilino</label><select class="form-select" name="tenantId" onchange="fillUserData(this.value,'tenant')"><option value="">--</option>${tenants.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    </div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome Proprietario</label><input type="text" class="form-input" name="landlordName" id="tplLandlordName"></div><div class="form-group"><label class="form-label">Nome Inquilino</label><input type="text" class="form-input" name="tenantName" id="tplTenantName"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ“‹ ${type === 'handover' ? 'VERBALE' : 'INVENTARIO'}</h4>
                    <div class="form-group"><label class="form-label">Data *</label><input type="date" class="form-input" name="date" value="${new Date().toISOString().split('T')[0]}" required></div>
                    ${type === 'handover' ? `
                        <div class="form-group"><label class="form-label">Tipo</label><select class="form-select" name="handoverType"><option value="checkin">Check-in (Ingresso)</option><option value="checkout">Check-out (Uscita)</option></select></div>
                        <div class="form-row"><input type="text" class="form-input" name="meterElectric" placeholder="Luce: kWh"><input type="text" class="form-input" name="meterGas" placeholder="Gas: mc"><input type="text" class="form-input" name="meterWater" placeholder="Acqua: mc"></div>
                        <div class="form-group"><label class="form-label">Chiavi</label><input type="text" class="form-input" name="keys" placeholder="es. 2 portone, 2 appartamento"></div>
                    ` : `
                        <div class="form-group"><label class="form-label">Elenco Arredi</label><textarea class="form-textarea" name="inventoryList" rows="8" placeholder="Soggiorno:\n- 1 divano\n- 1 TV\n\nCucina:\n- 1 frigorifero"></textarea></div>
                    `}
                    <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes"></textarea></div>
                </div>`;
        }
        // Proposal / Quote
        else if (['proposal', 'quote'].includes(type)) {
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ CLIENTE</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="clientId" onchange="fillClientData(this.value)"><option value="">-- Inserisci --</option>${S.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" id="tplName" required></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" name="clientEmail" id="tplEmail"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ’¼ SERVIZI</h4>
                    <div style="display:flex;flex-direction:column;gap:8px">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" name="includePFS" value="1"> ğŸ  Property Finding Service - â‚¬350</label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" name="includeDAS" value="1"> ğŸ“‹ Deal Assistance Service - â‚¬249</label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" name="includeVV" value="1"> ğŸ¥ Virtual Viewing - â‚¬89</label>
                    </div>
                    <div class="form-row" style="margin-top:12px"><div class="form-group"><label class="form-label">Sconto %</label><input type="number" class="form-input" name="discount" value="0" min="0" max="100"></div><div class="form-group"><label class="form-label">ValiditÃ  (giorni)</label><input type="number" class="form-input" name="validDays" value="7"></div></div>
                </div>
                <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes"></textarea></div>`;
        }
        // Proposta di Locazione
        else if (type === 'proposta_locazione') {
            const tenants = S.users.filter(u => u.role === 'tenant');
            const landlords = S.users.filter(u => u.role === 'landlord');
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ PROPONENTE (Inquilino)</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="tenantId" onchange="fillUserData(this.value,'tenant')"><option value="">-- Inserisci --</option>${tenants.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" id="tplTenantName" required></div><div class="form-group"><label class="form-label">C.F.</label><input type="text" class="form-input" name="tenantCF"></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Email *</label><input type="email" class="form-input" name="tenantEmail" required></div><div class="form-group"><label class="form-label">Telefono</label><input type="tel" class="form-input" name="tenantPhone"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ DESTINATARIO (Proprietario)</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="landlordId" onchange="fillUserData(this.value,'landlord')"><option value="">-- Inserisci --</option>${landlords.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="landlordName" id="tplLandlordName" required></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ  IMMOBILE</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="propertyId" onchange="fillPropertyData(this.value)"><option value="">-- Inserisci --</option>${S.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
                    <div class="form-group"><label class="form-label">Indirizzo *</label><input type="text" class="form-input" name="propertyAddress" id="tplPropertyAddress" required></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ’° CONDIZIONI PROPOSTE</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Canone â‚¬/mese *</label><input type="number" class="form-input" name="rent" id="tplRent" required></div><div class="form-group"><label class="form-label">Deposito â‚¬</label><input type="number" class="form-input" name="deposit" id="tplDeposit"></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Data Inizio *</label><input type="date" class="form-input" name="startDate" required></div><div class="form-group"><label class="form-label">Durata</label><input type="text" class="form-input" name="duration" placeholder="es. 12 mesi"></div></div>
                    <div class="form-group"><label class="form-label">ValiditÃ  Proposta</label><input type="text" class="form-input" name="validUntil" value="7 giorni dalla data"></div>
                </div>
                <div class="form-group"><label class="form-label">Note/Condizioni Particolari</label><textarea class="form-textarea" name="notes" placeholder="Es: Incluse spese condominiali, animali ammessi..."></textarea></div>`;
        }
        // Accettazione Proposta
        else if (type === 'accettazione_proposta') {
            const landlords = S.users.filter(u => u.role === 'landlord');
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ ACCETTANTE (Proprietario)</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="landlordId" onchange="fillUserData(this.value,'landlord')"><option value="">-- Inserisci --</option>${landlords.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" id="tplLandlordName" required></div><div class="form-group"><label class="form-label">C.F.</label><input type="text" class="form-input" name="landlordCF"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ“¨ RIFERIMENTO PROPOSTA</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Proponente *</label><input type="text" class="form-input" name="tenantName" required></div><div class="form-group"><label class="form-label">Data Proposta</label><input type="date" class="form-input" name="proposalDate"></div></div>
                    <div class="form-group"><label class="form-label">Immobile *</label><input type="text" class="form-input" name="propertyAddress" required></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">âœ… CONDIZIONI ACCETTATE</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Canone â‚¬/mese *</label><input type="number" class="form-input" name="rent" required></div><div class="form-group"><label class="form-label">Deposito â‚¬</label><input type="number" class="form-input" name="deposit"></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Data Inizio *</label><input type="date" class="form-input" name="startDate" required></div><div class="form-group"><label class="form-label">Durata</label><input type="text" class="form-input" name="duration"></div></div>
                    <div class="form-group"><label class="form-label">Eventuali Modifiche</label><textarea class="form-textarea" name="notes"></textarea></div>
                </div>`;
        }
        // Ricevuta Pigione
        else if (type === 'ricevuta_pigione') {
            const tenants = S.users.filter(u => u.role === 'tenant');
            const landlords = S.users.filter(u => u.role === 'landlord');
            const now = new Date();
            const monthNames = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ RICEVENTE (Proprietario)</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="landlordId" onchange="fillUserData(this.value,'landlord')"><option value="">-- Inserisci --</option>${landlords.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" id="tplLandlordName" required></div><div class="form-group"><label class="form-label">C.F./P.IVA</label><input type="text" class="form-input" name="landlordCF"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ PAGANTE (Inquilino)</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="tenantId" onchange="fillUserData(this.value,'tenant')"><option value="">-- Inserisci --</option>${tenants.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="tenantName" id="tplTenantName" required></div><div class="form-group"><label class="form-label">C.F.</label><input type="text" class="form-input" name="tenantCF"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ  IMMOBILE</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="propertyId" onchange="fillPropertyData(this.value)"><option value="">-- Inserisci --</option>${S.properties.map(p => `<option value="${p.id}">${p.name} - ${p.address || 'Roma'}</option>`).join('')}</select></div>
                    <div class="form-group"><label class="form-label">Indirizzo *</label><input type="text" class="form-input" name="propertyAddress" id="tplPropertyAddress" required></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ’° PAGAMENTO</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Mese Riferimento *</label><select class="form-select" name="month">${monthNames.map((m,i) => `<option value="${m} ${now.getFullYear()}" ${i === now.getMonth() ? 'selected' : ''}>${m} ${now.getFullYear()}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Importo â‚¬ *</label><input type="number" class="form-input" name="amount" id="tplRent" required></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Data Pagamento *</label><input type="date" class="form-input" name="paymentDate" value="${now.toISOString().split('T')[0]}" required></div><div class="form-group"><label class="form-label">ModalitÃ </label><select class="form-select" name="paymentMethod"><option value="bonifico">Bonifico Bancario</option><option value="contanti">Contanti</option><option value="assegno">Assegno</option></select></div></div>
                    <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes"></textarea></div>
                </div>`;
        }
        // Mandato di Gestione
        else if (type === 'mandato_gestione') {
            const landlords = S.users.filter(u => u.role === 'landlord');
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ MANDANTE (Proprietario)</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="landlordId" onchange="fillUserData(this.value,'landlord')"><option value="">-- Inserisci --</option>${landlords.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome/Ragione Sociale *</label><input type="text" class="form-input" name="clientName" id="tplLandlordName" required></div><div class="form-group"><label class="form-label">C.F./P.IVA *</label><input type="text" class="form-input" name="landlordCF" required></div></div>
                    <div class="form-group"><label class="form-label">Indirizzo Residenza *</label><input type="text" class="form-input" name="landlordAddress" required></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Email *</label><input type="email" class="form-input" name="landlordEmail" required></div><div class="form-group"><label class="form-label">Telefono</label><input type="tel" class="form-input" name="landlordPhone"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ  IMMOBILE DA GESTIRE</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="propertyId" onchange="fillPropertyData(this.value)"><option value="">-- Inserisci --</option>${S.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
                    <div class="form-group"><label class="form-label">Indirizzo Completo *</label><input type="text" class="form-input" name="propertyAddress" id="tplPropertyAddress" required></div>
                    <div class="form-group"><label class="form-label">Dati Catastali</label><input type="text" class="form-input" name="cadastral" placeholder="Foglio X, Part. Y, Sub. Z"></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ“‹ TERMINI MANDATO</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Data Inizio *</label><input type="date" class="form-input" name="startDate" value="${new Date().toISOString().split('T')[0]}" required></div><div class="form-group"><label class="form-label">Durata</label><select class="form-select" name="duration"><option value="12 mesi">12 mesi</option><option value="24 mesi">24 mesi</option><option value="36 mesi">36 mesi</option><option value="indeterminata">Indeterminata</option></select></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Compenso % sul canone</label><input type="number" class="form-input" name="feePercent" value="10" min="0" max="100"></div><div class="form-group"><label class="form-label">Oppure Fisso â‚¬/mese</label><input type="number" class="form-input" name="feeFixed" placeholder="0"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">âœ… SERVIZI INCLUSI</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" name="svc_rent" checked> Riscossione canoni</label>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" name="svc_payments" checked> Pagamento utenze</label>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" name="svc_maint" checked> Gestione manutenzioni</label>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" name="svc_tenant" checked> Rapporti con inquilino</label>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" name="svc_condo"> Rapporti condominiali</label>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="checkbox" name="svc_report" checked> Rendicontazione</label>
                    </div>
                </div>`;
        }
        // Rendiconto Annuale
        else if (type === 'rendiconto_annuale') {
            const landlords = S.users.filter(u => u.role === 'landlord');
            const currentYear = new Date().getFullYear();
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ PROPRIETARIO</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="landlordId" onchange="fillUserData(this.value,'landlord')"><option value="">-- Inserisci --</option>${landlords.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" id="tplLandlordName" required></div><div class="form-group"><label class="form-label">C.F.</label><input type="text" class="form-input" name="landlordCF"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ  IMMOBILE</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="propertyId" onchange="fillPropertyData(this.value)"><option value="">-- Inserisci --</option>${S.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
                    <div class="form-group"><label class="form-label">Indirizzo</label><input type="text" class="form-input" name="propertyAddress" id="tplPropertyAddress"></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ“… PERIODO</h4>
                    <div class="form-group"><label class="form-label">Anno di Riferimento *</label><select class="form-select" name="year"><option value="${currentYear}">${currentYear}</option><option value="${currentYear-1}">${currentYear-1}</option></select></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ’° ENTRATE</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Canoni Percepiti â‚¬</label><input type="number" class="form-input" name="totalRent" value="0"></div><div class="form-group"><label class="form-label">Depositi Ricevuti â‚¬</label><input type="number" class="form-input" name="deposits" value="0"></div></div>
                    <div class="form-group"><label class="form-label">Altre Entrate â‚¬</label><input type="number" class="form-input" name="otherIncome" value="0"></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ’¸ USCITE</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Compenso Gestione â‚¬</label><input type="number" class="form-input" name="managementFee" value="0"></div><div class="form-group"><label class="form-label">Manutenzioni â‚¬</label><input type="number" class="form-input" name="maintenance" value="0"></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Utenze â‚¬</label><input type="number" class="form-input" name="utilities" value="0"></div><div class="form-group"><label class="form-label">Spese Condominiali â‚¬</label><input type="number" class="form-input" name="condo" value="0"></div></div>
                    <div class="form-group"><label class="form-label">Altre Spese â‚¬</label><input type="number" class="form-input" name="otherExpenses" value="0"></div>
                </div>
                <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes"></textarea></div>`;
        }
        // Lettera d'Incarico
        else if (type === 'lettera_incarico') {
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ CLIENTE</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="clientId" onchange="fillClientData(this.value)"><option value="">-- Inserisci --</option>${S.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" id="tplName" required></div><div class="form-group"><label class="form-label">C.F.</label><input type="text" class="form-input" name="clientCF"></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Email *</label><input type="email" class="form-input" name="clientEmail" id="tplEmail" required></div><div class="form-group"><label class="form-label">Telefono</label><input type="tel" class="form-input" name="clientPhone" id="tplPhone"></div></div>
                    <div class="form-group"><label class="form-label">Indirizzo Residenza</label><input type="text" class="form-input" name="clientAddress"></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ” OGGETTO RICERCA</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Tipologia</label><select class="form-select" name="propertyType"><option value="appartamento">Appartamento</option><option value="stanza">Stanza</option><option value="monolocale">Monolocale</option><option value="villa">Villa</option></select></div><div class="form-group"><label class="form-label">Destinazione</label><select class="form-select" name="purpose"><option value="locazione">Locazione</option><option value="acquisto">Acquisto</option></select></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Budget Max â‚¬/mese *</label><input type="number" class="form-input" name="budget" id="tplBudget" required></div><div class="form-group"><label class="form-label">Zone Preferite *</label><input type="text" class="form-input" name="zone" id="tplZone" required></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Data Arrivo/Inizio</label><input type="date" class="form-input" name="arrivalDate"></div><div class="form-group"><label class="form-label">Durata Prevista</label><input type="text" class="form-input" name="duration" id="tplDuration" placeholder="es. 12 mesi"></div></div>
                    <div class="form-group"><label class="form-label">Requisiti Specifici</label><textarea class="form-textarea" name="requirements" placeholder="NÂ° locali, animali, parcheggio, balcone..."></textarea></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ’¼ INCARICO</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Servizio</label><select class="form-select" name="service"><option value="PFS">Property Finding Service â‚¬350</option><option value="DAS">Deal Assistance Service â‚¬249</option><option value="VV">Virtual Viewing â‚¬89</option></select></div><div class="form-group"><label class="form-label">Durata Incarico</label><select class="form-select" name="mandateDuration"><option value="30 giorni">30 giorni</option><option value="60 giorni">60 giorni</option><option value="90 giorni">90 giorni</option></select></div></div>
                    <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes"></textarea></div>
                </div>`;
        }
        // Comunicazione ISTAT
        else if (type === 'comunicazione_istat') {
            const tenants = S.users.filter(u => u.role === 'tenant');
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ DESTINATARIO (Inquilino)</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="tenantId" onchange="fillUserData(this.value,'tenant')"><option value="">-- Inserisci --</option>${tenants.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" id="tplTenantName" required></div><div class="form-group"><label class="form-label">Indirizzo Immobile *</label><input type="text" class="form-input" name="propertyAddress" required></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ“ˆ ADEGUAMENTO ISTAT</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Canone Attuale â‚¬ *</label><input type="number" class="form-input" name="currentRent" required></div><div class="form-group"><label class="form-label">Indice ISTAT % *</label><input type="number" class="form-input" name="istatIndex" step="0.1" value="5.4" required></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nuovo Canone â‚¬ *</label><input type="number" class="form-input" name="newRent" required></div><div class="form-group"><label class="form-label">Decorrenza *</label><input type="date" class="form-input" name="effectiveDate" required></div></div>
                    <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes"></textarea></div>
                </div>`;
        }
        // Sollecito Pagamento
        else if (type === 'sollecito_pagamento') {
            const tenants = S.users.filter(u => u.role === 'tenant');
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ DESTINATARIO</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="tenantId" onchange="fillUserData(this.value,'tenant')"><option value="">-- Inserisci --</option>${tenants.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" id="tplTenantName" required></div><div class="form-group"><label class="form-label">Indirizzo Immobile *</label><input type="text" class="form-input" name="propertyAddress" required></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ’° IMPORTO DOVUTO</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Mese/i di Riferimento *</label><input type="text" class="form-input" name="period" required placeholder="es. Gennaio-Febbraio 2025"></div><div class="form-group"><label class="form-label">Importo Totale â‚¬ *</label><input type="number" class="form-input" name="amount" required></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Scadenza Originale</label><input type="date" class="form-input" name="originalDueDate"></div><div class="form-group"><label class="form-label">Giorni di Ritardo</label><input type="number" class="form-input" name="daysLate" value="0"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">âš ï¸ TIPO SOLLECITO</h4>
                    <div class="form-group"><label class="form-label">Livello</label><select class="form-select" name="level"><option value="primo">Primo Sollecito (cortese)</option><option value="secondo">Secondo Sollecito (formale)</option><option value="diffida">Diffida/Messa in Mora</option></select></div>
                    <div class="form-group"><label class="form-label">Termine per Pagamento</label><input type="date" class="form-input" name="deadline" value="${new Date(Date.now() + 15*24*60*60*1000).toISOString().split('T')[0]}"></div>
                    <div class="form-group"><label class="form-label">Note Aggiuntive</label><textarea class="form-textarea" name="notes"></textarea></div>
                </div>`;
        }
        // Disdetta Contratto
        else if (type === 'disdetta') {
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ MITTENTE</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" required></div><div class="form-group"><label class="form-label">C.F.</label><input type="text" class="form-input" name="senderCF"></div></div>
                    <div class="form-group"><label class="form-label">QualitÃ </label><select class="form-select" name="senderRole"><option value="conduttore">Conduttore (Inquilino)</option><option value="locatore">Locatore (Proprietario)</option></select></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ“‹ CONTRATTO</h4>
                    <div class="form-group"><label class="form-label">Indirizzo Immobile *</label><input type="text" class="form-input" name="propertyAddress" required></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Data Contratto</label><input type="date" class="form-input" name="contractDate"></div><div class="form-group"><label class="form-label">Scadenza Contratto</label><input type="date" class="form-input" name="contractEnd"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">âŒ DISDETTA</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Data Rilascio *</label><input type="date" class="form-input" name="releaseDate" required></div><div class="form-group"><label class="form-label">Preavviso (mesi)</label><input type="number" class="form-input" name="noticePeriod" value="6"></div></div>
                    <div class="form-group"><label class="form-label">Motivazione</label><textarea class="form-textarea" name="reason" placeholder="es. Gravi motivi, trasferimento lavorativo..."></textarea></div>
                </div>`;
        }
        // Ricevuta Provvigione
        else if (type === 'ricevuta_provvigione') {
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ‘¤ CLIENTE</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="clientId" onchange="fillClientData(this.value)"><option value="">-- Inserisci --</option>${S.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" id="tplName" required></div><div class="form-group"><label class="form-label">C.F./P.IVA</label><input type="text" class="form-input" name="clientCF"></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ’¼ SERVIZIO PRESTATO</h4>
                    <div class="form-group"><label class="form-label">Tipo Servizio *</label><select class="form-select" name="serviceType"><option value="PFS">Property Finding Service â‚¬350</option><option value="DAS">Deal Assistance Service â‚¬249</option><option value="VV">Virtual Viewing â‚¬89</option><option value="mediazione">Mediazione Immobiliare</option><option value="altro">Altro</option></select></div>
                    <div class="form-group"><label class="form-label">Descrizione</label><input type="text" class="form-input" name="serviceDesc" placeholder="es. Ricerca e locazione appartamento Via Roma 1"></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ’° PROVVIGIONE</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Importo â‚¬ *</label><input type="number" class="form-input" name="amount" required></div><div class="form-group"><label class="form-label">Data Pagamento *</label><input type="date" class="form-input" name="paymentDate" value="${new Date().toISOString().split('T')[0]}" required></div></div>
                    <div class="form-group"><label class="form-label">ModalitÃ </label><select class="form-select" name="paymentMethod"><option value="bonifico">Bonifico Bancario</option><option value="stripe">Carta (Stripe)</option><option value="contanti">Contanti</option></select></div>
                    <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes"></textarea></div>
                </div>`;
        }
        // Stato Immobile
        else if (type === 'stato_immobile') {
            formFields = `
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ  IMMOBILE</h4>
                    <div class="form-group"><label class="form-label">Seleziona</label><select class="form-select" name="propertyId" onchange="fillPropertyData(this.value)"><option value="">-- Seleziona --</option>${S.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
                    <div class="form-group"><label class="form-label">Indirizzo *</label><input type="text" class="form-input" name="clientName" id="tplPropertyAddress" required></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ“‹ STATO GENERALE</h4>
                    <div class="form-row"><div class="form-group"><label class="form-label">Data Verifica *</label><input type="date" class="form-input" name="date" value="${new Date().toISOString().split('T')[0]}" required></div><div class="form-group"><label class="form-label">Tipo</label><select class="form-select" name="checkType"><option value="ingresso">Ingresso</option><option value="uscita">Uscita</option><option value="periodica">Verifica Periodica</option></select></div></div>
                </div>
                <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px">
                    <h4 style="margin:0 0 12px 0;color:var(--gold);font-size:13px">ğŸ” VALUTAZIONE AMBIENTI</h4>
                    <div style="display:grid;gap:8px">
                        <div class="form-row"><label style="width:100px">Ingresso</label><select class="form-select" name="stateIngresso"><option value="ottimo">Ottimo</option><option value="buono">Buono</option><option value="sufficiente">Sufficiente</option><option value="da_riparare">Da Riparare</option></select><input type="text" class="form-input" name="noteIngresso" placeholder="Note"></div>
                        <div class="form-row"><label style="width:100px">Soggiorno</label><select class="form-select" name="stateSoggiorno"><option value="ottimo">Ottimo</option><option value="buono">Buono</option><option value="sufficiente">Sufficiente</option><option value="da_riparare">Da Riparare</option></select><input type="text" class="form-input" name="noteSoggiorno" placeholder="Note"></div>
                        <div class="form-row"><label style="width:100px">Cucina</label><select class="form-select" name="stateCucina"><option value="ottimo">Ottimo</option><option value="buono">Buono</option><option value="sufficiente">Sufficiente</option><option value="da_riparare">Da Riparare</option></select><input type="text" class="form-input" name="noteCucina" placeholder="Note"></div>
                        <div class="form-row"><label style="width:100px">Camera</label><select class="form-select" name="stateCamera"><option value="ottimo">Ottimo</option><option value="buono">Buono</option><option value="sufficiente">Sufficiente</option><option value="da_riparare">Da Riparare</option></select><input type="text" class="form-input" name="noteCamera" placeholder="Note"></div>
                        <div class="form-row"><label style="width:100px">Bagno</label><select class="form-select" name="stateBagno"><option value="ottimo">Ottimo</option><option value="buono">Buono</option><option value="sufficiente">Sufficiente</option><option value="da_riparare">Da Riparare</option></select><input type="text" class="form-input" name="noteBagno" placeholder="Note"></div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">Note Generali</label><textarea class="form-textarea" name="notes" rows="4"></textarea></div>`;
        }
        // Default fallback
        else {
            formFields = `
                <div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-input" name="clientName" required></div>
                <div class="form-group"><label class="form-label">Note</label><textarea class="form-textarea" name="notes"></textarea></div>`;
        }
        
        document.getElementById('modals').innerHTML = `<div class="modal-overlay active"><div class="modal xl">
            <div class="modal-header"><h3 class="modal-title">${titles[type] || 'ğŸ“„ Documento'}</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body" style="max-height:65vh;overflow-y:auto"><form id="tplForm"><input type="hidden" name="templateType" value="${type}">${formFields}</form></div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annulla</button><button class="btn" onclick="generateTemplatePDF()">ğŸ“¥ Genera PDF</button></div>
        </div></div>`;
        
        if (prefillClient) fillClientData(prefillClient.id);
    }
    
    function fillUserData(id, type) {
        const u = S.users.find(x => x.id === id); if (!u) return;
        if (type === 'landlord') {
            const el = document.getElementById('tplLandlordName'); if (el) el.value = u.name;
        } else {
            const el = document.getElementById('tplTenantName'); if (el) el.value = u.name;
        }
    }
    
    function fillPropertyData(id) {
        const p = S.properties.find(x => x.id === id); if (!p) return;
        const addr = document.getElementById('tplPropertyAddress'); if (addr) addr.value = p.address || '';
        const rent = document.getElementById('tplRent'); if (rent) rent.value = p.rent || '';
        const dep = document.getElementById('tplDeposit'); if (dep) dep.value = (p.rent || 0) * 3;
    }
    
    function fillClientData(id) {
        const c = S.clients.find(x => x.id === id); if (!c) return;
        const name = document.getElementById('tplName'); if (name) name.value = c.name || '';
        const email = document.getElementById('tplEmail'); if (email) email.value = c.email || '';
        const phone = document.getElementById('tplPhone'); if (phone) phone.value = c.phone || '';
        const budget = document.getElementById('tplBudget'); if (budget) budget.value = c.budget || '';
        const zone = document.getElementById('tplZone'); if (zone) zone.value = c.zone || '';
        const duration = document.getElementById('tplDuration'); if (duration) duration.value = c.duration || '';
    }

    function generateTemplatePDF() {
        const data = Object.fromEntries(new FormData(document.getElementById('tplForm')));
        if (!data.clientName && !data.landlordName && !data.tenantName) {
            return toast('error', 'Compila i campi obbligatori');
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const type = data.templateType;
        const ref = type.toUpperCase().replace(/_/g, '') + '-' + Date.now().toString(36).slice(-6).toUpperCase();
        const isIT = S.lang === 'IT';
        const today = new Date().toLocaleDateString(isIT ? 'it-IT' : 'en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
        
        // Title mapping (bilingual)
        const titles = isIT ? { 
            pfs: 'PROPERTY FINDING SERVICE', das: 'DEAL ASSISTANCE SERVICE', vv: 'VIRTUAL VIEWING',
            lettera_incarico: 'LETTERA D\'INCARICO', proposal: 'PROPOSTA SERVIZI', quote: 'PREVENTIVO',
            proposta_locazione: 'PROPOSTA DI LOCAZIONE', accettazione_proposta: 'ACCETTAZIONE PROPOSTA',
            rental_transitorio: 'CONTRATTO TRANSITORIO', rental_studenti: 'CONTRATTO STUDENTI', rental_4plus4: 'CONTRATTO 4+4',
            disdetta: 'DISDETTA CONTRATTO', ricevuta_pigione: 'RICEVUTA DI PAGAMENTO', deposit_receipt: 'RICEVUTA DEPOSITO',
            ricevuta_provvigione: 'RICEVUTA PROVVIGIONE', mandato_gestione: 'MANDATO DI GESTIONE',
            rendiconto_annuale: 'RENDICONTO ANNUALE', comunicazione_istat: 'ADEGUAMENTO ISTAT',
            sollecito_pagamento: 'SOLLECITO DI PAGAMENTO', handover: 'VERBALE CONSEGNA', inventory: 'INVENTARIO ARREDI',
            stato_immobile: 'STATO DELL\'IMMOBILE'
        } : {
            pfs: 'PROPERTY FINDING SERVICE', das: 'DEAL ASSISTANCE SERVICE', vv: 'VIRTUAL VIEWING',
            lettera_incarico: 'ENGAGEMENT LETTER', proposal: 'SERVICE PROPOSAL', quote: 'QUOTE',
            proposta_locazione: 'RENTAL PROPOSAL', accettazione_proposta: 'PROPOSAL ACCEPTANCE',
            rental_transitorio: 'TRANSITIONAL LEASE', rental_studenti: 'STUDENT LEASE', rental_4plus4: 'LEASE AGREEMENT 4+4',
            disdetta: 'LEASE TERMINATION', ricevuta_pigione: 'RENT RECEIPT', deposit_receipt: 'DEPOSIT RECEIPT',
            ricevuta_provvigione: 'COMMISSION RECEIPT', mandato_gestione: 'MANAGEMENT MANDATE',
            rendiconto_annuale: 'ANNUAL STATEMENT', comunicazione_istat: 'ISTAT ADJUSTMENT',
            sollecito_pagamento: 'PAYMENT REMINDER', handover: 'HANDOVER REPORT', inventory: 'FURNITURE INVENTORY',
            stato_immobile: 'PROPERTY CONDITION'
        };
        
        // Labels (bilingual)
        const L = isIT ? {
            provider: 'FORNITORE DEL SERVIZIO', client: 'CLIENTE', object: 'OGGETTO DELL\'INCARICO',
            company: 'Ragione Sociale', vat: 'P.IVA', phone: 'Telefono', email: 'Email', name: 'Nome',
            cf: 'Codice Fiscale', address: 'Indirizzo', service: 'Servizio', amount: 'Importo',
            budget: 'Budget Max', zone: 'Zone', arrival: 'Data Arrivo', duration: 'Durata',
            requirements: 'Requisiti', receiver: 'RICEVENTE', payer: 'PAGANTE', property: 'IMMOBILE',
            payment: 'PAGAMENTO', month: 'Mese', date: 'Data', method: 'ModalitÃ ', signature: 'Firma',
            landlord: 'LOCATORE', tenant: 'CONDUTTORE', residence: 'Residenza', contract: 'CONTRATTO',
            start: 'Inizio', end: 'Fine', rent: 'Canone', deposit: 'Deposito', cadastral: 'Dati Catastali',
            energy: 'Classe Energetica'
        } : {
            provider: 'SERVICE PROVIDER', client: 'CLIENT', object: 'ENGAGEMENT DETAILS',
            company: 'Company', vat: 'VAT', phone: 'Phone', email: 'Email', name: 'Name',
            cf: 'Tax ID', address: 'Address', service: 'Service', amount: 'Amount',
            budget: 'Max Budget', zone: 'Area', arrival: 'Arrival Date', duration: 'Duration',
            requirements: 'Requirements', receiver: 'RECEIVER', payer: 'PAYER', property: 'PROPERTY',
            payment: 'PAYMENT', month: 'Month', date: 'Date', method: 'Method', signature: 'Signature',
            landlord: 'LANDLORD', tenant: 'TENANT', residence: 'Residence', contract: 'CONTRACT',
            start: 'Start', end: 'End', rent: 'Rent', deposit: 'Deposit', cadastral: 'Cadastral Data',
            energy: 'Energy Class'
        };
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HEADER - Design professionale nero/oro
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        doc.setFillColor(0, 0, 0);
        doc.rect(0, 0, 210, 40, 'F');
        
        // Logo text BOOM
        doc.setTextColor(212, 175, 55);
        doc.setFontSize(32);
        doc.setFont('helvetica', 'bold');
        doc.text('BOOM', 20, 26);
        
        // Sottotitolo
        doc.setTextColor(150, 150, 150);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.text('PROPERTY MANAGEMENT', 20, 33);
        
        // Titolo documento (destra)
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(titles[type] || 'DOCUMENTO', 190, 22, { align: 'right' });
        
        // Ref number
        doc.setTextColor(212, 175, 55);
        doc.setFontSize(9);
        doc.text(`Rif: ${ref}`, 190, 30, { align: 'right' });
        
        // Data
        doc.setTextColor(150, 150, 150);
        doc.setFontSize(8);
        doc.text(`Roma, ${today}`, 190, 36, { align: 'right' });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONTENT - Varia per tipo
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let y = 55;
        doc.setTextColor(0, 0, 0);
        
        // Helper functions
        const section = (title) => {
            doc.setFillColor(245, 245, 245);
            doc.rect(15, y - 4, 180, 8, 'F');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(212, 175, 55);
            doc.text(title, 20, y + 1);
            doc.setTextColor(0, 0, 0);
            y += 10;
        };
        
        const field = (label, value, col = 0) => {
            if (!value) return;
            const x = col === 0 ? 20 : 110;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text(label + ':', x, y);
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.text(String(value), x + 35, y);
            if (col === 0) y += 6;
        };
        
        const fieldRow = (label1, value1, label2, value2) => {
            field(label1, value1, 0);
            y -= 6;
            field(label2, value2, 1);
            y += 6;
        };
        
        const text = (content, indent = 20) => {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            const lines = doc.splitTextToSize(content, 170);
            doc.text(lines, indent, y);
            y += lines.length * 5 + 3;
        };
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DOCUMENT-SPECIFIC CONTENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // SERVIZI BOOM (PFS, DAS, VV)
        if (['pfs', 'das', 'vv', 'lettera_incarico'].includes(type)) {
            section(L.provider);
            field(L.company, COMPANY.legal);
            fieldRow(L.vat, COMPANY.piva, L.phone, COMPANY.phone);
            field(L.email, COMPANY.email);
            y += 5;
            
            section(L.client);
            field(L.name, data.clientName);
            if (data.clientCF) field(L.cf, data.clientCF);
            if (data.clientEmail) fieldRow(L.email, data.clientEmail, L.phone, data.clientPhone || 'â€”');
            if (data.clientAddress) field(L.address, data.clientAddress);
            y += 5;
            
            section(L.object);
            const svc = type === 'lettera_incarico' ? data.service : type.toUpperCase();
            field(L.service, SERVICES[svc]?.name || svc);
            field(L.amount, `EUR ${SERVICES[svc]?.price || data.serviceAmount || 'â€”'}`);
            y += 3;
            
            if (data.budget) fieldRow(L.budget, `â‚¬${data.budget}/${isIT ? 'mese' : 'month'}`, L.zone, data.zone || 'â€”');
            if (data.arrivalDate) fieldRow(L.arrival, data.arrivalDate, L.duration, data.duration || 'â€”');
            if (data.requirements) { y += 3; field(L.requirements, ''); text(data.requirements); }
        }
        
        // RICEVUTA PIGIONE
        else if (type === 'ricevuta_pigione') {
            section(L.receiver);
            field(L.name, data.clientName || data.landlordName);
            if (data.landlordCF) field(L.cf + '/P.IVA', data.landlordCF);
            y += 5;
            
            section(L.payer);
            field(L.name, data.tenantName);
            if (data.tenantCF) field(L.cf, data.tenantCF);
            y += 5;
            
            section(L.property);
            field(L.address, data.propertyAddress);
            y += 5;
            
            section(L.payment);
            doc.setFillColor(212, 175, 55);
            doc.rect(20, y - 2, 80, 15, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(`EUR ${data.amount || 'â€”'}`, 25, y + 8);
            doc.setFontSize(9);
            doc.setTextColor(0);
            y += 20;
            
            fieldRow('Mese Riferimento', data.month, 'Data Pagamento', data.paymentDate);
            field('ModalitÃ ', data.paymentMethod === 'bonifico' ? 'Bonifico Bancario' : data.paymentMethod === 'contanti' ? 'Contanti' : data.paymentMethod);
            
            y += 10;
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(9);
            doc.text('Con la presente si dichiara di aver ricevuto la somma sopra indicata a titolo di canone di locazione.', 20, y);
        }
        
        // PROPOSTA DI LOCAZIONE
        else if (type === 'proposta_locazione') {
            section('PROPONENTE');
            field('Nome', data.clientName || data.tenantName);
            if (data.tenantCF) field('Codice Fiscale', data.tenantCF);
            fieldRow('Email', data.tenantEmail, 'Telefono', data.tenantPhone || 'â€”');
            y += 5;
            
            section('PROPRIETARIO');
            field('Nome', data.landlordName);
            y += 5;
            
            section('IMMOBILE');
            field('Indirizzo', data.propertyAddress);
            y += 5;
            
            section('CONDIZIONI PROPOSTE');
            fieldRow('Canone Mensile', `â‚¬${data.rent}`, 'Deposito', `â‚¬${data.deposit || 'â€”'}`);
            fieldRow('Data Inizio', data.startDate, 'Durata', data.duration || 'â€”');
            field('ValiditÃ  Proposta', data.validUntil || '7 giorni dalla data');
            
            if (data.notes) {
                y += 5;
                section('NOTE E CONDIZIONI PARTICOLARI');
                text(data.notes);
            }
        }
        
        // MANDATO DI GESTIONE
        else if (type === 'mandato_gestione') {
            section('MANDANTE (Proprietario)');
            field('Nome', data.clientName || data.landlordName);
            field('C.F./P.IVA', data.landlordCF);
            field('Indirizzo', data.landlordAddress);
            fieldRow('Email', data.landlordEmail, 'Telefono', data.landlordPhone || 'â€”');
            y += 5;
            
            section('MANDATARIO');
            field('Ragione Sociale', COMPANY.legal);
            fieldRow('P.IVA', COMPANY.piva, 'Telefono', COMPANY.phone);
            y += 5;
            
            section('IMMOBILE IN GESTIONE');
            field('Indirizzo', data.propertyAddress);
            if (data.cadastral) field('Dati Catastali', data.cadastral);
            y += 5;
            
            section('TERMINI DEL MANDATO');
            fieldRow('Decorrenza', data.startDate, 'Durata', data.duration);
            const fee = data.feePercent ? `${data.feePercent}% sul canone` : `â‚¬${data.feeFixed}/mese`;
            field('Compenso', fee);
            y += 5;
            
            section('SERVIZI INCLUSI');
            doc.setFontSize(9);
            const services = [];
            if (data.svc_rent) services.push('Riscossione canoni');
            if (data.svc_payments) services.push('Pagamento utenze');
            if (data.svc_maint) services.push('Gestione manutenzioni');
            if (data.svc_tenant) services.push('Rapporti con inquilino');
            if (data.svc_condo) services.push('Rapporti condominiali');
            if (data.svc_report) services.push('Rendicontazione periodica');
            text(services.join(' â€¢ ') || 'Gestione completa');
        }
        
        // RENDICONTO ANNUALE
        else if (type === 'rendiconto_annuale') {
            section('PROPRIETARIO');
            field('Nome', data.clientName || data.landlordName);
            if (data.landlordCF) field('Codice Fiscale', data.landlordCF);
            y += 5;
            
            section('IMMOBILE');
            field('Indirizzo', data.propertyAddress);
            field('Anno di Riferimento', data.year);
            y += 5;
            
            section('ENTRATE');
            const totalIn = (parseInt(data.totalRent) || 0) + (parseInt(data.deposits) || 0) + (parseInt(data.otherIncome) || 0);
            fieldRow('Canoni Percepiti', `â‚¬${data.totalRent || 0}`, 'Depositi', `â‚¬${data.deposits || 0}`);
            field('Altre Entrate', `â‚¬${data.otherIncome || 0}`);
            doc.setFont('helvetica', 'bold');
            field('TOTALE ENTRATE', `â‚¬${totalIn}`);
            y += 5;
            
            section('USCITE');
            const totalOut = (parseInt(data.managementFee) || 0) + (parseInt(data.maintenance) || 0) + (parseInt(data.utilities) || 0) + (parseInt(data.condo) || 0) + (parseInt(data.otherExpenses) || 0);
            fieldRow('Compenso Gestione', `â‚¬${data.managementFee || 0}`, 'Manutenzioni', `â‚¬${data.maintenance || 0}`);
            fieldRow('Utenze', `â‚¬${data.utilities || 0}`, 'Spese Condominiali', `â‚¬${data.condo || 0}`);
            field('Altre Spese', `â‚¬${data.otherExpenses || 0}`);
            doc.setFont('helvetica', 'bold');
            field('TOTALE USCITE', `â‚¬${totalOut}`);
            y += 8;
            
            // Saldo
            doc.setFillColor(212, 175, 55);
            doc.rect(20, y - 2, 170, 12, 'F');
            doc.setTextColor(0);
            doc.setFontSize(12);
            doc.text(`SALDO NETTO: EUR ${totalIn - totalOut}`, 105, y + 6, { align: 'center' });
        }
        
        // SOLLECITO PAGAMENTO
        else if (type === 'sollecito_pagamento') {
            const levelText = { primo: 'PRIMO SOLLECITO', secondo: 'SECONDO SOLLECITO', diffida: 'DIFFIDA DI PAGAMENTO' };
            
            // Badge livello
            const bgColor = data.level === 'diffida' ? [255, 59, 48] : data.level === 'secondo' ? [255, 149, 0] : [0, 122, 255];
            doc.setFillColor(...bgColor);
            doc.rect(20, y, 60, 8, 'F');
            doc.setTextColor(255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text(levelText[data.level] || 'SOLLECITO', 25, y + 5.5);
            doc.setTextColor(0);
            y += 15;
            
            section('DESTINATARIO');
            field('Nome', data.clientName || data.tenantName);
            field('Immobile', data.propertyAddress);
            y += 5;
            
            section('IMPORTO DOVUTO');
            doc.setFillColor(255, 240, 240);
            doc.rect(20, y - 2, 170, 15, 'F');
            doc.setTextColor(255, 59, 48);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(`EUR ${data.amount}`, 25, y + 8);
            doc.setTextColor(0);
            y += 20;
            
            field('Periodo Riferimento', data.period);
            if (data.daysLate > 0) field('Giorni di Ritardo', data.daysLate);
            field('Termine Pagamento', data.deadline);
            
            y += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            if (data.level === 'diffida') {
                text('Con la presente si intima formalmente il pagamento della somma sopra indicata entro e non oltre il termine specificato. In difetto, ci vedremo costretti ad adire le vie legali per il recupero del credito, con aggravio delle spese a Vs. carico.');
            } else {
                text('La preghiamo di provvedere al pagamento della somma sopra indicata entro il termine specificato. Per qualsiasi chiarimento, non esiti a contattarci.');
            }
        }
        
        // DEFAULT - Altri documenti
        else {
            section('DATI');
            if (data.clientName) field('Cliente/Destinatario', data.clientName);
            if (data.landlordName) field('Proprietario', data.landlordName);
            if (data.tenantName) field('Inquilino', data.tenantName);
            if (data.propertyAddress) field('Immobile', data.propertyAddress);
            if (data.amount) field('Importo', `â‚¬${data.amount}`);
            if (data.rent) field('Canone', `â‚¬${data.rent}/mese`);
            if (data.deposit) field('Deposito', `â‚¬${data.deposit}`);
            if (data.startDate) field('Data Inizio', data.startDate);
            if (data.endDate) field('Data Fine', data.endDate);
            if (data.date) field('Data', data.date);
            
            if (data.notes) {
                y += 5;
                section('NOTE');
                text(data.notes);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FIRME
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (y < 220) y = 220;
        else if (y > 250) { doc.addPage(); y = 30; }
        
        y += 10;
        doc.setDrawColor(200, 200, 200);
        doc.line(20, y + 15, 85, y + 15);
        doc.line(125, y + 15, 190, y + 15);
        
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text('Firma Cliente', 52.5, y + 22, { align: 'center' });
        doc.text('Firma BOOM', 157.5, y + 22, { align: 'center' });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FOOTER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFillColor(0, 0, 0);
            doc.rect(0, 282, 210, 15, 'F');
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(7);
            doc.text(`${COMPANY.legal} | P.IVA ${COMPANY.piva} | ${COMPANY.email} | ${COMPANY.phone}`, 105, 289, { align: 'center' });
            doc.setTextColor(212, 175, 55);
            doc.text(COMPANY.website, 105, 293, { align: 'center' });
            doc.setTextColor(80);
            doc.text(`Pag. ${i}/${pageCount}`, 190, 289, { align: 'right' });
        }
        
        // Save
        const filename = `BOOM_${(titles[type] || 'DOC').replace(/[^a-zA-Z0-9]/g, '_')}_${(data.clientName || data.landlordName || data.tenantName || 'doc').replace(/[^a-zA-Z0-9]/g, '_')}_${ref}.pdf`;
        doc.save(filename);
        closeModal();
        toast('success', 'PDF generato!', filename);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXPORT FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function exportInvoicesCSV() {
        let csv = 'Numero,Cliente,Servizio,Importo,Stato,Data\n';
        S.invoices.forEach(i => {
            const client = S.clients.find(c => c.id === i.clientId);
            csv += `"${i.number}","${client?.name || ''}","${i.service || ''}",${i.amount || 0},"${i.status}","${fmtDate(i.createdAt)}"\n`;
        });
        downloadCSV(csv, 'BOOM_Fatture.csv');
    }

    function exportPaymentsCSV() {
        let csv = 'Immobile,Inquilino,Mese,Importo,Stato,Scadenza,Pagato\n';
        S.payments.forEach(p => {
            const c = S.contracts.find(x => x.id === p.contractId);
            const prop = c ? S.properties.find(x => x.id === c.propertyId) : null;
            const t = c ? S.users.find(x => x.id === c.tenantId) : null;
            csv += `"${prop?.name || ''}","${t?.name || ''}","${p.month || ''}",${p.amount || 0},"${p.status}","${fmtDate(p.dueDate)}","${fmtDate(p.paidDate)}"\n`;
        });
        downloadCSV(csv, 'BOOM_Pagamenti.csv');
    }

    function downloadCSV(content, filename) {
        const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        toast('success', 'Export completato!');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function initials(n) { return (n || '?').split(' ').map(x => x[0]).join('').toUpperCase().slice(0, 2); }
    function roleLabel(r) { return { admin: 'Admin', landlord: 'Proprietario', tenant: 'Inquilino' }[r] || r; }
    function statusLabel(s) { return { open: 'Aperta', in_progress: 'In Corso', resolved: 'Risolta', paid: 'Pagato', pending: 'In Attesa', active: 'Attivo', expired: 'Scaduto' }[s] || s; }
    function statusColor(s) { return { open: 'orange', in_progress: 'blue', resolved: 'green', paid: 'green', pending: 'orange', active: 'green', expired: 'red' }[s] || 'gray'; }
    function priorityLabel(p) { return { low: 'Bassa', medium: 'Media', high: 'Alta', urgent: 'Urgente' }[p] || p; }
    function priorityColor(p) { return { low: 'gray', medium: 'blue', high: 'orange', urgent: 'red' }[p] || 'gray'; }
    function catLabel(c) { return { plumbing: 'Idraulica', electrical: 'ElettricitÃ ', heating: 'Riscaldamento', appliance: 'Elettrodomestici', other: 'Altro' }[c] || c; }
    function docIcon(t) { return { contract: 'ğŸ“‹', id: 'ğŸªª', receipt: 'ğŸ§¾', utility: 'ğŸ’¡', other: 'ğŸ“„' }[t] || 'ğŸ“„'; }
    function docTypeLabel(t) { return { contract: 'Contratto', id: 'Documento ID', receipt: 'Ricevuta', utility: 'Utenza', other: 'Altro' }[t] || t; }
    function stageLabel(s) { return PIPELINE_STAGES.find(x => x.id === s)?.name || s; }
    function stageBadgeColor(s) { return { lead: 'gray', contacted: 'blue', qualified: 'green', searching: 'purple', found: 'orange', closing: 'gold', paid: 'green', completed: 'green', lost: 'red' }[s] || 'gray'; }
    function fmtDate(d) { if (!d) return 'â€”'; const dt = d.toDate ? d.toDate() : new Date(d); return isNaN(dt.getTime()) ? 'â€”' : dt.toLocaleDateString('it-IT'); }
    function isThisMonth(d) { if (!d) return false; const dt = d.toDate ? d.toDate() : new Date(d); const now = new Date(); return dt.getMonth() === now.getMonth() && dt.getFullYear() === now.getFullYear(); }
    function numberToWords(n) {
        if (n === 0) return 'zero';
        const units = ['', 'uno', 'due', 'tre', 'quattro', 'cinque', 'sei', 'sette', 'otto', 'nove'];
        const teens = ['dieci', 'undici', 'dodici', 'tredici', 'quattordici', 'quindici', 'sedici', 'diciassette', 'diciotto', 'diciannove'];
        const tens = ['', '', 'venti', 'trenta', 'quaranta', 'cinquanta', 'sessanta', 'settanta', 'ottanta', 'novanta'];
        const hundreds = ['', 'cento', 'duecento', 'trecento', 'quattrocento', 'cinquecento', 'seicento', 'settecento', 'ottocento', 'novecento'];
        if (n < 10) return units[n];
        if (n < 20) return teens[n - 10];
        if (n < 100) { const t = Math.floor(n / 10), u = n % 10; let s = tens[t]; if (u === 1 || u === 8) s = s.slice(0, -1); return s + units[u]; }
        if (n < 1000) { const h = Math.floor(n / 100), r = n % 100; return hundreds[h] + (r ? numberToWords(r) : ''); }
        if (n < 10000) { const th = Math.floor(n / 1000), r = n % 1000; return (th === 1 ? 'mille' : units[th] + 'mila') + (r ? numberToWords(r) : ''); }
        return String(n);
    }

    function toast(type, title, msg = '') {
        const c = document.getElementById('toasts');
        const icons = { success: 'âœ“', error: 'âœ•', warning: 'âš ', info: 'â„¹' };
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerHTML = `<span style="font-size:16px">${icons[type] || 'â„¹'}</span><div style="flex:1"><div style="font-weight:600;font-size:13px">${title}</div>${msg ? `<div style="font-size:11px;opacity:.8;margin-top:2px">${msg}</div>` : ''}</div>`;
        c.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateX(100px)'; setTimeout(() => el.remove(), 300); }, 4000);
    }

    console.log('ğŸš€ BOOM Portal v5 Pro - Complete Bilingual Edition');
    
    // Check if opened locally (file://) - this won't work with Firebase
    if (window.location.protocol === 'file:') {
        console.warn('âš ï¸ File opened locally - Firebase auth may not work');
        setTimeout(() => {
            hideLoading();
            showAuth();
            showAuthError('âš ï¸ Questo file deve essere caricato su un server web (non aprire direttamente). Caricalo su boomrome.com per usarlo.');
        }, 2000);
    }
    
    // Fallback timeout - if loading takes more than 15 seconds, show error
    setTimeout(() => {
        const loading = document.getElementById('loading');
        if (loading && !loading.classList.contains('hidden')) {
            console.error('Loading timeout - Firebase may be unreachable');
            hideLoading();
            showAuth();
            showAuthError('Connessione lenta. Ricarica la pagina o verifica la connessione internet.');
        }
    }, 15000);
    </script>
</body>
</html>
